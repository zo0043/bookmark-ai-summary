# 分布式一致性协议 Raft 原理
- URL: https://wingsxdu.com/posts/algorithms/raft/
- Added At: 2024-10-14 13:28:58
- [Link To Text](2024-10-14-分布式一致性协议-raft-原理_raw.md)

## TL;DR
Raft 是一种易于理解的分布式一致性协议，通过领导选举、日志复制、安全性和成员变更确保节点一致。它分解复杂问题，保障数据一致性，适用于非拜占庭环境，通过随机超时和两阶段配置变更应对网络分区和日志膨胀。

## Summary
1. **Raft 简介**：Raft 是一种基于消息传递通信模型的分布式一致性协议，旨在管理日志复制，允许一组机器像一个整体一样工作，即使在某些机器出现错误的情况下也能正常提供服务。与 Paxos 相比，Raft 更易于理解和实现。

2. **概述**：
   - Raft 将复杂的复制集群节点一致性问题分解为四个子问题：领导选举、日志复制、安全性和成员变更。
   - Raft 是分布式领域中的强一致性算法，确保所有节点以相同顺序收到相同指令，并产生一致结果。

3. **数据一致性**：
   - 分布式系统中的节点通信存在两种模型：共享内存和消息传递。
   - Raft 解决在不考虑拜占庭将军问题的条件下，如何在可能发生异常的分布式系统中就某个值达成一致，保证数据一致性。

4. **状态机复制**：
   - 状态机复制通常使用日志复制实现，每个服务器节点存储包含一系列命令的日志，状态机按顺序执行日志中的命令。
   - Raft 的工作是保证复制日志的一致性，服务器上的 Consensus 模块接收来自客户端的命令，并将它们添加到日志中。

5. **Raft 算法特性**：
   - 确保在所有非拜占庭条件下的安全性。
   - 只要超过一半（n/2+1）服务器都可以运行，算法就可用。
   - 不依赖于时序来确保日志的一致性。
   - 在通常情况下，只要集群的大部分服务器已经响应了单轮远程过程调用，命令就可以完成。

6. **领导选举**：
   - Raft 通过领导选举机制选举出一个 Leader，由它全权管理日志复制来实现一致性。
   - Raft 集群包含若干个服务器节点，每个节点都有一个唯一标识 ID，并且在任何时刻，每一个服务器节点都处于 Leader、Follower 或 Candidate 状态之一。

7. **节点通信**：
   - 集群中的节点使用远程过程调用（RPC）进行通信，Raft 中一共有三种类型的 RPC：AppendEntries RPC、RequestVote RPC 和 InstallSnapshot RPC。

8. **选举流程**：
   - 当一个 Raft 集群启动时，所有节点都是 Follower 身份，一个节点从领导人或者候选者处接收到有效的 RPC 时会继续保持着 Follower 状态。
   - 如果 Follower 在一段时间里没有接收到任何消息，那么他就会认为系统中没有可用的领导者，因此发起选举以选出新的领导者。

9. **随机选举超时时间**：
   - Raft 使用随机选举超时时间机制来确保很少会发生选票瓜分的情况，选举超时时间是从一个固定区间内（例如 150-300 ms）随机选择。

10. **日志复制**：
    - 当 Leader 被选举出来，它就开始为客户端提供服务，客户端的每一个请求都包含一条被状态机执行的指令，Leader 把这条指令作为一条新的日志条目附加到日志中。

11. **日志一致性检查**：
    - Leader 通过强制 Follower 复制自己的日志处理不一致问题，这意味着在 Follower 中冲突的日志条目会被 Leader 的日志覆盖。

12. **安全性**：
    - Raft 在领导选举时会增加一些限制条件，保证任何的 Leader 对于给定的任期号，都拥有之前任期所有被提交的日志条目。

13. **成员变更**：
    - Raft 将配置变更自动化归并到算法中，采用两阶段方法，先切换到一个过渡的配置，称之为共同一致状态，一旦共同一致被提交，那么系统就切换到新的配置上。

14. **网络分区**：
    - Raft 算法对不同情况下的网络分区具有不同的应对方案，例如 Leader 在少数节点分区中和 Leader 在多数节点分区中。

15. **日志压缩**：
    - Raft 算法采用了快照机制来压缩庞大的日志，在某个时间点，将整个系统的所有状态稳定地写入到可持久化存储中，然后这个时间点后的所有日志全部清除。

16. **总结**：
    - Raft 算法的实现原理清晰，在逻辑上比较遵循人的直觉，描述也很细致，考虑到了一些边界问题，这些不仅提升了 Raft 的可理解性，也令人相信其正确性。
