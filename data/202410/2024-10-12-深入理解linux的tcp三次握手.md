# 深入理解Linux的TCP三次握手
- URL: https://mp.weixin.qq.com/s/LIeb5DwMS6RS2YhEw47GDA
- Added At: 2024-10-12 10:02:00
- [Link To Text](2024-10-12-深入理解linux的tcp三次握手_raw.md)

## TL;DR
本文详细介绍了TCP协议的可靠性和面向连接特性，探讨了三次握手、拥塞控制及synflood攻击防范机制，并介绍了TFO技术及其内核参数，旨在优化TCP传输效率和安全性。

## Summary
1. **TCP协议概述**：TCP协议是一个面向连接和可靠的传输层协议，与UDP的不可靠和非面向连接特性形成对比。TCP需要在不可靠的IP层上实现可靠的传输，因此设计复杂。

2. **可靠性与面向连接**：
   - **面向连接**：数据传输具有状态和顺序关系，需要维护数据流的顺序，解决数据包重复问题。
   - **可靠性**：保证数据在传输过程中不被损坏或丢失，确保正确到达。

3. **解决面向连接问题**：
   - 使用建立连接、传输数据、断开连接的三步流程。
   - 维护seq序列号字段，保证按序交付和解决数据包重复问题。
   - 使用syn、ack、fin、rst等状态标记包来创建、断开和维护连接。

4. **解决可靠性问题**：
   - 引入数据传输确认机制，即停止等待协议。
   - 引入窗口确认机制和滑动窗口，提高带宽利用率。
   - 引入窗口变量和窗口监测通告，适应不同延时的网络。

5. **拥塞控制机制**：
   - 在拥塞情况下，调整滑动窗口大小，公平分享带宽。
   - 发送方维护已发送并确认、已发送未确认、即将发送的偏移量。
   - 接收方维护已接受并确认的偏移量和接受后会保存的窗口大小。

6. **三次握手的目的**：
   - 确认对端在线。
   - 确认连接中传输数据的起始序列号。

7. **三次握手过程**：
   - 客户端发送syn包。
   - 服务器回复syn+ack包。
   - 客户端发送ack包。

8. **synflood攻击原理**：
   - 通过构造不完整的三次握手过程，占满服务端的半连接池，导致无法建立新连接。

9. **syncookie机制**：
   - 通过在synack包中包含cookie信息，绕过半连接池限制，防止synflood攻击。

10. **listen backlog参数**：
    - 限制完全建立但未被accept的连接队列长度。
    - 当队列满时，新的连接请求可能会被拒绝或忽略。

11. **TFO - TCP Fast Open**：
    - 简化三次握手过程，提高TCP在大延时网络上的打开速度。
    - 通过在syn包中携带cookie，实现快速建立连接。

12. **TFO相关内核参数**：
    - /proc/sys/net/ipv4/tcp\_fastopen：控制TFO开关。
    - /proc/sys/net/ipv4/tcp\_fastopen\_key：设置TFO密钥。
    - /proc/sys/net/ipv4/tcp\_fastopen\_blackhole\_timeout\_sec：设置TFO黑洞检测关闭周期。

13. **其他内核参数**：
    - /proc/sys/net/ipv4/tcp\_synretries：设置第一次握手syn重试次数。
    - /proc/sys/net/ipv4/tcp\_synack\_retries：设置第二次握手synack重试次数。
