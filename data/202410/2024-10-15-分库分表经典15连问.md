# 分库分表经典15连问
- URL: https://mp.weixin.qq.com/s?__biz=MzkyMzU5Mzk1NQ==&mid=2247506697&idx=1&sn=ddd188c4e0f6f055aeab78b3d2038ed8&source=41#wechat_redirect
- Added At: 2024-10-15 13:09:06
- [Link To Text](2024-10-15-分库分表经典15连问_raw.md)

## TL;DR
文章详细介绍了分库分表的必要性、时机、策略及常见问题解决方案，包括分表键选择、热点避免、事务处理、跨节点Join、聚合函数和分页问题，并推荐了相关中间件和不停服分表方法。

## Summary
1. **分库分表理由**：
   - **磁盘存储**：业务量剧增时，单机磁盘容量可能不足。
   - **并发连接支撑**：高并发场景下，单机数据库连接数可能不足。

2. **分库分表时机**：
   - 数据量达到千万级别，或单表容量超过2GB时考虑分库分表。
   - 需要提前规划，避免等到数据量过大时才考虑。

3. **分表键选择**：
   - 根据业务主题选择分表键，如客户号。
   - 避免触发全表路由。

4. **非分表键查询**：
   - 遍历所有表（不推荐）。
   - 将数据同步到ES进行查询（推荐）。

5. **分表策略**：
   - **range范围**：按范围划分表，有利于扩容，但可能有热点问题。
   - **hash取模**：按哈希值取模分表，避免热点问题，但扩容麻烦。
   - **一致性Hash**：解决扩容迁移问题。

6. **避免热点问题**：
   - 使用range范围+hash哈希取模结合的分表策略。

7. **事务问题解决**：
   - 使用分布式事务解决方案，如两阶段提交、TCC等。

8. **跨节点Join问题**：
   - 字段冗余、全局表、数据抽象同步、应用层代码组装。

9. **聚合函数问题**：
   - 在各个节点上得到结果后，在应用程序端进行合并。

10. **分页问题**：
    - **全局视野法**：在代码端汇聚再分页，业务无损但数据量大。
    - **业务折衷法**：只允许上一页和下一页，不允许跳页查询。

11. **分布式ID**：
    - 使用UUID或雪花算法生成分布式ID。

12. **分库分表中间件**：
    - Sharding-JDBC、cobar、Mycat等。

13. **分库数量评估**：
    - 一般建议分4~10个库。

14. **分库分表类型区别**：
    - 水平分库、水平分表、垂直分库、垂直分表。

15. **不停服分表**：
    - 编写代理层、双写、数据迁移、停读旧表、停写旧表。
