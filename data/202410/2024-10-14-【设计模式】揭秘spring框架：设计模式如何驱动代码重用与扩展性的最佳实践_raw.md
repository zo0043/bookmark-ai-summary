Title: ã€è®¾è®¡æ¨¡å¼ã€‘æ­ç§˜Springæ¡†æ¶ï¼šè®¾è®¡æ¨¡å¼å¦‚ä½•é©±åŠ¨ä»£ç é‡ç”¨ä¸æ‰©å±•æ€§çš„æœ€ä½³å®è·µåœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè®¾è®¡æ¨¡å¼ä¸ä»…ä¼˜åŒ–äº†ä»£ç ç»“æ„ - æ˜é‡‘

URL Source: https://juejin.cn/post/7424904499666501632

Markdown Content:
> **ä½œè€…ï¼šåç«¯å°è‚¥è‚ **
> 
> ğŸ‡ æˆ‘å†™è¿‡çš„æ–‡ç« ä¸­çš„ç›¸å…³ä»£ç æ”¾åˆ°äº†giteeï¼Œåœ°å€ï¼š[xfc-fdw-cloud: å…¬å…±è§£å†³æ–¹æ¡ˆ](https://link.juejin.cn/?target=https%3A%2F%2Fgitee.com%2Fu_ncle%2Fxfc-fdw-cloud "https://gitee.com/u_ncle/xfc-fdw-cloud")
> 
> ğŸŠ æœ‰ç–‘é—®å¯ç§ä¿¡æˆ–è¯„è®ºåŒºè”ç³»æˆ‘ã€‚
> 
> ğŸ¥‘ Â åˆ›ä½œä¸æ˜“æœªç»å…è®¸ä¸¥ç¦è½¬è½½ã€‚
> 
> **å§Šå¦¹ç¯‡ï¼š**
> 
> [ã€è®¾è®¡æ¨¡å¼ã€‘ä¸‡å­—è¯¦è§£ï¼šæ·±å…¥æŒæ¡äº”å¤§åŸºç¡€è¡Œä¸ºæ¨¡å¼-CSDNåšå®¢](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fc18213590220%2Farticle%2Fdetails%2F142432297%3Fspm%3D1001.2014.3001.5501 "https://blog.csdn.net/c18213590220/article/details/142432297?spm=1001.2014.3001.5501")
> 
> [ã€è®¾è®¡æ¨¡å¼ã€‘ï¼ˆä¸‡å­—æ€»ç»“ï¼‰æ·±å…¥ç†è§£Javaä¸­çš„åˆ›å»ºå‹è®¾è®¡æ¨¡å¼\_javaè®¾è®¡æ¨¡å¼åˆ›å»º-CSDNåšå®¢](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fc18213590220%2Farticle%2Fdetails%2F140751369 "https://blog.csdn.net/c18213590220/article/details/140751369")
> 
> [ã€è®¾è®¡æ¨¡å¼ã€‘ç»“æ„å‹æ¨¡å¼å…¨æ”»ç•¥:ä»å…¥é—¨åˆ°ç²¾é€šçš„ä¸‡å­—å®æˆ˜æŒ‡å—\_ç»“æ„å‹æ¨¡å¼ä»£ç†æ¨¡å¼è¯¦è§£-CSDNåšå®¢](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fc18213590220%2Farticle%2Fdetails%2F141066406 "https://blog.csdn.net/c18213590220/article/details/141066406")

1\. å‰è¨€
------

åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè®¾è®¡æ¨¡å¼ä¸ä»…ä¼˜åŒ–äº†ä»£ç ç»“æ„ï¼Œè¿˜æå‡äº†åº”ç”¨çš„çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚ç‰¹åˆ«æ˜¯åœ¨Springæ¡†æ¶ä¸­ï¼Œè®¾è®¡æ¨¡å¼çš„åº”ç”¨æˆä¸ºäº†å®ç°å…¶å¼ºå¤§åŠŸèƒ½çš„åŸºçŸ³ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Springæ¡†æ¶å¦‚ä½•é€šè¿‡å·¥å‚æ¨¡å¼ä»¥åŠå…¶ä»–è®¾è®¡æ¨¡å¼æ¥ä¼˜åŒ–å¯¹è±¡çš„ç”Ÿäº§å’Œç®¡ç†ï¼Œå¼ºåŒ–äº†æ¡†æ¶çš„åŠŸèƒ½å¹¶ç®€åŒ–äº†å¼€å‘è€…çš„ç¼–ç å·¥ä½œã€‚é€šè¿‡å…·ä½“çš„ä»£ç ç¤ºä¾‹å’Œè¯¦ç»†çš„åˆ†æï¼Œæˆ‘ä»¬å°†æ­ç¤ºè¿™äº›è®¾è®¡æ¨¡å¼åœ¨Springä¸­çš„å®é™…è¿ç”¨ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£å’Œè¿ç”¨Springæ¡†æ¶ï¼Œä»è€Œæ‰“é€ å‡ºæ›´é«˜æ•ˆã€æ›´ç¨³å®šçš„åº”ç”¨ã€‚

2\. Springä¸­å·¥å‚æ¨¡å¼çš„åº”ç”¨
------------------

**Springçš„è®¾è®¡ç†å¿µ**

*   Springæ˜¯é¢å‘Beançš„ç¼–ç¨‹ï¼ˆBOPï¼šBean Oriented Programmingï¼‰ï¼ŒBeanåœ¨Springä¸­æ‰æ˜¯çœŸæ­£çš„ä¸»è§’ã€‚Beanåœ¨Springä¸­ä½œç”¨å°±åƒObjectå¯¹OOPçš„æ„ä¹‰ä¸€æ ·ï¼Œæ²¡æœ‰å¯¹è±¡çš„æ¦‚å¿µå°±åƒæ²¡æœ‰é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ŒSpringä¸­æ²¡æœ‰Beanä¹Ÿå°±æ²¡æœ‰Springå­˜åœ¨çš„æ„ä¹‰ã€‚Springæä¾›äº†IoC å®¹å™¨é€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£çš„æ–¹å¼æ¥ç®¡ç†å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚
*   æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼Œç¼©å†™ä¸ºIoCï¼‰ï¼Œæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ä¸€ç§è®¾è®¡åŸåˆ™ï¼Œå¯ä»¥ç”¨æ¥å‡ä½ä»£ç ä¹‹é—´çš„è€¦åˆåº¦ã€‚å…¶ä¸­æœ€å¸¸è§çš„æ–¹å¼å«åšä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼Œç®€ç§°DIï¼‰ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼å«â€œä¾èµ–æŸ¥æ‰¾â€ï¼ˆDependency Lookupï¼‰ã€‚é€šè¿‡æ§åˆ¶åè½¬ï¼Œå¯¹è±¡åœ¨è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œç”±ä¸€ä¸ªè°ƒæ§ç³»ç»Ÿå†…æ‰€æœ‰å¯¹è±¡çš„å¤–ç•Œå®ä½“ï¼Œå°†å…¶æ‰€ä¾èµ–çš„å¯¹è±¡çš„å¼•ç”¨ä¼ é€’ç»™å®ƒã€‚

### 2.1. Springä¸­çš„Beanç»„ä»¶

Beanç»„ä»¶å®šä¹‰åœ¨Springçš„**org.springframework.beans**åŒ…ä¸‹ï¼Œè§£å†³äº†ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

è¿™ä¸ªåŒ…ä¸‹çš„æ‰€æœ‰ç±»ä¸»è¦è§£å†³äº†ä¸‰ä»¶äº‹ï¼š

*   Beançš„å®šä¹‰
*   Beançš„åˆ›å»º
*   Beançš„è§£æ

Spring Beançš„åˆ›å»ºæ˜¯å…¸å‹çš„å·¥å‚æ¨¡å¼ï¼Œå®ƒçš„é¡¶çº§æ¥å£æ˜¯BeanFactoryã€‚

![Image 1: 137.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ece6f593dbf247559068d1b25e459e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=eyWJgCa%2F1Zc2DeWyQwFxhkPzlzA%3D)

BeanFactoryæœ‰ä¸‰ä¸ªå­ç±»ï¼š`ListableBeanFactory`ã€`HierarchicalBeanFactory`å’Œ`AutowireCapableBeanFactory`ã€‚ç›®çš„æ˜¯ä¸ºäº†**åŒºåˆ†Springå†…éƒ¨å¯¹è±¡å¤„ç†å’Œè½¬åŒ–çš„æ•°æ®é™åˆ¶**ã€‚

ä½†æ˜¯ä»å›¾ä¸­å¯ä»¥å‘ç°æœ€ç»ˆçš„é»˜è®¤å®ç°ç±»æ˜¯`DefaultListableBeanFactory`ï¼Œå®ƒå®ç°äº†æ‰€æœ‰çš„æ¥å£

### 2.2. Springä¸­çš„BeanFactory

Springä¸­çš„BeanFactoryå°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„ä½“ç°ï¼Œæ ¹æ®ä¼ å…¥ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†æ¥è·å¾—Beanå¯¹è±¡

BeanFactoryï¼Œä»¥Factoryç»“å°¾ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå·¥å‚(æ¥å£)ï¼Œ å®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†beançš„ä¸€ä¸ªå·¥å‚ã€‚åœ¨Springä¸­ï¼ŒBeanFactoryæ˜¯å·¥å‚çš„é¡¶å±‚æ¥å£ï¼Œä¹Ÿæ˜¯IOCå®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œå› æ­¤BeanFactoryä¸­å®šä¹‰äº†**ç®¡ç†Beançš„é€šç”¨æ–¹æ³•**ï¼Œå¦‚ **getBean** å’Œ **containsBean** ç­‰.

å®ƒçš„èŒè´£åŒ…æ‹¬ï¼šå®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´çš„ä¾èµ–ã€‚

BeanFactoryåªæ˜¯ä¸ªæ¥å£ï¼Œå¹¶ä¸æ˜¯IOCå®¹å™¨çš„å…·ä½“å®ç°ï¼Œæ‰€ä»¥Springå®¹å™¨ç»™å‡ºäº†å¾ˆå¤šç§å®ç°ï¼Œå¦‚ **DefaultListableBeanFactory**ã€**XmlBeanFactory**ã€**ApplicationContext**ç­‰ï¼Œå…¶ä¸­XmlBeanFactoryå°±æ˜¯å¸¸ç”¨çš„ä¸€ä¸ªï¼Œè¯¥å®ç°å°†ä»¥XMLæ–¹å¼æè¿°ç»„æˆåº”ç”¨çš„å¯¹è±¡åŠå¯¹è±¡é—´çš„ä¾èµ–å…³ç³»ã€‚

**1) BeanFactoryæºç è§£æ**

```
public interface BeanFactory {
 Â  Â 
 Â  Â /**
 Â       å¯¹FactoryBeançš„è½¬ç§»å®šä¹‰,å› ä¸ºå¦‚æœä½¿ç”¨beançš„åå­—æ¥æ£€ç´¢FactoryBeanå¾—åˆ°çš„æ˜¯å¯¹è±¡æ˜¯å·¥å‚ç”Ÿæˆçš„å¯¹è±¡,
 Â       å¦‚æœæƒ³å¾—åˆ°å·¥å‚æœ¬èº«å°±éœ€è¦è½¬ç§»
 Â  Â */
 Â  Â String FACTORY_BEAN_PREFIX = "&";

 Â  Â //æ ¹æ®Beançš„åå­— è·å–IOCå®¹å™¨ä¸­å¯¹åº”çš„å®ä¾‹
 Â  Â Object getBean(String var1) throws BeansException;

 Â  Â 
 Â  Â //æ ¹æ®Beançš„åå­—å’Œclassç±»å‹å¾—åˆ°beanå®ä¾‹,å¢åŠ äº†ç±»å‹å®‰å…¨éªŒè¯æœºåˆ¶
 Â  Â <T> T getBean(String var1, Class<T> var2) throws BeansException;

 Â  Â Object getBean(String var1, Object... var2) throws BeansException;

 Â  Â <T> T getBean(Class<T> var1) throws BeansException;

 Â  Â <T> T getBean(Class<T> var1, Object... var2) throws BeansException;

 Â  Â <T> ObjectProvider<T> getBeanProvider(Class<T> var1);

 Â  Â <T> ObjectProvider<T> getBeanProvider(ResolvableType var1);

 Â  Â 
 Â  //æŸ¥çœ‹Beanå®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„å®ä¾‹,å­˜åœ¨è¿”å›true å¦åˆ™è¿”å›false
 Â  Â boolean containsBean(String var1);

 Â  Â //æ ¹æ®Beançš„åå­— åˆ¤æ–­è¿™ä¸ªbeanæ˜¯ä¸æ˜¯å•ä¾‹
 Â  Â boolean isSingleton(String var1) throws NoSuchBeanDefinitionException;

 Â  Â boolean isPrototype(String var1) throws NoSuchBeanDefinitionException;

 Â  Â boolean isTypeMatch(String var1, ResolvableType var2) throws NoSuchBeanDefinitionException;

 Â  Â boolean isTypeMatch(String var1, Class<?> var2) throws NoSuchBeanDefinitionException;

 Â  Â //å¾—åˆ°beanå®ä¾‹çš„classç±»å‹
 Â  Â @Nullable
 Â  Â Class<?> getType(String var1) throws NoSuchBeanDefinitionException;

 Â  Â @Nullable
 Â  Â Class<?> getType(String var1, boolean var2) throws NoSuchBeanDefinitionException;

 Â  Â 
 Â  Â //å¾—åˆ°beançš„åˆ«å
 Â  Â String[] getAliases(String var1);
}

```

**BeanFactoryçš„ä½¿ç”¨åœºæ™¯**

1.  ä»IOCå®¹å™¨ä¸­è·å–Bean(Name or Type)
2.  æ£€ç´¢IOCå®¹å™¨ä¸­æ˜¯å¦åŒ…å«äº†æŒ‡å®šçš„å¯¹è±¡
3.  åˆ¤æ–­Beanæ˜¯å¦ä¸ºå•ä¾‹

**2) BeanFactoryçš„ä½¿ç”¨**

```
public class User {

 Â  Â private int id;

 Â  Â private String name;

 Â  Â private Friends friends;

 Â  Â public User() {
 Â   }

 Â  Â public User(Friends friends) {
 Â  Â  Â  Â this.friends = friends;
 Â   }

    //get set......
}

public class Friends {

 Â  Â private List<String> names;

 Â  Â public Friends() {
 Â   }

 Â  Â public List<String> getNames() {
 Â  Â  Â  Â return names;
 Â   }

 Â  Â public void setNames(List<String> names) {
 Â  Â  Â  Â this.names = names;
 Â   }
}
```

**é…ç½®æ–‡ä»¶**

```
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:task="http://www.springframework.org/schema/task"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-4.2.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc-4.2.xsd
        http://www.springframework.org/schema/task
        http://www.springframework.org/schema/task/spring-task-4.2.xsd">
    
    <bean id="User" class="com.example.factory.User">
        <property name="friends" ref="UserFriends" />
    </bean>
    <bean id="UserFriends" class="com.example.factory.Friends">
        <property name="names">
            <list>
                <value>"LiLi"</value>
                <value>"LuLu"</value>
            </list>
        </property>
    </bean>
</beans>
```

**æµ‹è¯•**

```
public class SpringFactoryTest {

 Â  Â public static void main(String[] args) {
 Â  Â  Â  Â ClassPathXmlApplicationContext ctx = new ClassPathXmlApplicationContext("bean.xml");
 Â  Â  Â  Â User user = ctx.getBean("User", User.class);

 Â  Â  Â  Â List<String> names = user.getFriends().getNames();
 Â  Â  Â  Â for (String name : names) {
 Â  Â  Â  Â  Â  Â System.out.println("FriendName: " + name);
 Â  Â  Â   }

 Â  Â  Â  Â ctx.close();
 Â   }
}
```

### 2.3. Springä¸­çš„FactoryBean

é¦–å…ˆFactoryBeanæ˜¯ä¸€ä¸ªBeanï¼Œä½†åˆä¸ä»…ä»…æ˜¯ä¸€ä¸ªBeanï¼Œè¿™æ ·å¬èµ·æ¥çŸ›ç›¾ï¼Œä½†ä¸ºå•¥åˆè¿™æ ·è¯´å‘¢ï¼Ÿå…¶å®åœ¨Springä¸­ï¼Œæ‰€æœ‰çš„Beanéƒ½æ˜¯ç”±BeanFactoryï¼ˆä¹Ÿå°±æ˜¯IOCå®¹å™¨ï¼‰æ¥è¿›è¡Œç®¡ç†çš„ã€‚ä½†å¯¹FactoryBeanè€Œè¨€ï¼Œ**è¿™ä¸ªFactoryBeanä¸æ˜¯ç®€å•çš„Beanï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½ç”Ÿäº§æˆ–è€…ä¿®é¥°å¯¹è±¡ç”Ÿæˆçš„å·¥å‚Bean,å®ƒçš„å®ç°ä¸è®¾è®¡æ¨¡å¼ä¸­çš„å·¥å‚æ–¹æ³•æ¨¡å¼å’Œä¿®é¥°å™¨æ¨¡å¼ç±»ä¼¼**

**1) ä¸ºä»€ä¹ˆéœ€è¦FactoryBean?**

1.  åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ä¾‹åŒ–Beanè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨ä¸­æä¾›å¤§é‡çš„é…ç½®ä¿¡æ¯ã€‚é…ç½®æ–¹å¼çš„çµæ´»æ€§æ˜¯å—é™çš„ï¼Œè¿™æ—¶é‡‡ç”¨ç¼–ç çš„æ–¹å¼å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆã€‚Springä¸ºæ­¤æä¾›äº†ä¸€ä¸ª`org.springframework.bean.factory.FactoryBean`çš„å·¥å‚ç±»æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å®ç°è¯¥æ¥å£å®šåˆ¶å®ä¾‹åŒ–Beançš„é€»è¾‘ã€‚FactoryBeanæ¥å£å¯¹äºSpringæ¡†æ¶æ¥è¯´å ç”¨é‡è¦çš„åœ°ä½ï¼ŒSpringè‡ªèº«å°±æä¾›äº†70å¤šä¸ªFactoryBeançš„å®ç°ã€‚å®ƒä»¬éšè—äº†å®ä¾‹åŒ–ä¸€äº›å¤æ‚Beançš„ç»†èŠ‚ï¼Œç»™ä¸Šå±‚åº”ç”¨å¸¦æ¥äº†ä¾¿åˆ©ã€‚
2.  ç”±äºç¬¬ä¸‰æ–¹åº“ä¸èƒ½ç›´æ¥æ³¨å†Œåˆ°springå®¹å™¨ï¼Œäºæ˜¯å¯ä»¥å®ç°`org.springframework.bean.factory.FactoryBean`æ¥å£ï¼Œç„¶åç»™å‡ºè‡ªå·±å¯¹è±¡çš„å®ä¾‹åŒ–ä»£ç å³å¯ã€‚

**2 ) FactoryBeançš„ä½¿ç”¨ç‰¹ç‚¹**

1.  å½“ç”¨æˆ·ä½¿ç”¨å®¹å™¨æœ¬èº«æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è½¬ä¹‰å­—ç¬¦"&"æ¥å¾—åˆ°FactoryBeanæœ¬èº«ï¼Œä»¥åŒºåˆ«é€šè¿‡FactoryBeanäº§ç”Ÿçš„å®ä¾‹å¯¹è±¡å’ŒFactoryBeanå¯¹è±¡æœ¬èº«ã€‚
    
2.  åœ¨BeanFactoryä¸­é€šè¿‡å¦‚ä¸‹ä»£ç å®šä¹‰äº†è¯¥è½¬ä¹‰å­—ç¬¦ï¼š
    
    ```
     StringFACTORY_BEAN_PREFIX = "&";
    ```
    
3.  ä¸¾ä¾‹
    
    ```
    å¦‚æœMyObjectæ˜¯ä¸€ä¸ªFactoryBeanï¼Œåˆ™ä½¿ç”¨&MyObjectå¾—åˆ°çš„æ˜¯MyObjectå¯¹è±¡ï¼Œè€Œä¸æ˜¯MyObjectäº§ç”Ÿå‡ºæ¥çš„å¯¹è±¡ã€‚
    ```
    

**3) FactoryBeançš„ä»£ç ç¤ºä¾‹**

```
@Configuration
@ComponentScan("com.example.factory_bean")
public class AppConfig {
}

@Component("studentBean")
public class StudentBean implements FactoryBean {

 Â  Â //è¿”å›å·¥å‚ä¸­çš„å®ä¾‹
 Â  Â @Override
 Â  Â public Object getObject() throws Exception {
 Â  Â  Â  Â //è¿™é‡Œå¹¶ä¸ä¸€å®šè¦è¿”å›MyBeanè‡ªèº«çš„å®ä¾‹ï¼Œå¯ä»¥æ˜¯å…¶ä»–ä»»ä½•å¯¹è±¡çš„å®ä¾‹ã€‚
 Â  Â  Â  Â return new TeacherBean();
 Â   }

 Â  Â //è¯¥æ–¹æ³•è¿”å›çš„ç±»å‹æ˜¯åœ¨IOCå®¹å™¨ä¸­getBeanæ‰€åŒ¹é…çš„ç±»å‹
 Â  Â @Override
 Â  Â public Class<?> getObjectType() {
 Â  Â  Â  Â return StudentBean.class;
 Â   }

 Â  Â public void study(){
 Â  Â  Â  Â System.out.println("å­¦ç”Ÿå­¦ä¹ ......");
 Â   }
}

public class TeacherBean {

 Â  Â public void teach(){
 Â  Â  Â  Â System.out.println("è€å¸ˆæ•™ä¹¦......");
 Â   }
}

public class Test01 {

 Â  Â public static void main(String[] args) {

 Â  Â  Â  Â AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
 Â  Â  Â  Â //StudentBean studentBean = (StudentBean)context.getBean("studentBean");

 Â  Â  Â  Â //åŠ ä¸Š&ç¬¦å·,è¿”å›å·¥å‚ä¸­çš„å®ä¾‹
// Â  Â  Â   StudentBean studentBean = (StudentBean)context.getBean("&studentBean");
// Â  Â  Â   studentBean.study();

 Â  Â  Â  Â TeacherBean teacherBean = (TeacherBean) context.getBean("studentBean");
 Â  Â  Â  Â teacherBean.teach();
 Â   }
}
```

**3) FactoryBeanæºç åˆ†æ**

```
public interface FactoryBean<T> {
    String OBJECT_TYPE_ATTRIBUTE = "factoryBeanObjectType";

    /**
    getObject()æ–¹æ³•: ä¼šè¿”å›è¯¥FactoryBeanç”Ÿäº§çš„å¯¹è±¡å®ä¾‹,æˆ‘ä»¬éœ€è¦å®ç°è¯¥æ–¹æ³•,ä»¥ç»™å‡ºè‡ªå·±çš„å¯¹è±¡å®ä¾‹åŒ–é€»è¾‘
    è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯FactoryBeançš„æ ¸å¿ƒ.
    */
    @Nullable
    T getObject() throws Exception;

    /**
    getObjectType()æ–¹æ³•: ä»…è¿”å›getObject() æ–¹æ³•æ‰€è¿”å›çš„å¯¹è±¡ç±»å‹,å¦‚æœé¢„å…ˆæ— æ³•ç¡®å®š,è¿”å›NULL,
    è¿™ä¸ªæ–¹æ³•è¿”å›ç±»å‹æ˜¯åœ¨IOCå®¹å™¨ä¸­getBeanæ‰€åŒ¹é…çš„ç±»å‹
    */
    @Nullable
    Class<?> getObjectType();

    //è¯¥æ–¹æ³•çš„ç»“æœç”¨äºè¡¨æ˜ å·¥å‚æ–¹æ³•getObject() æ‰€ç”Ÿäº§çš„ å¯¹è±¡æ˜¯å¦è¦ä»¥å•ä¾‹å½¢å¼å­˜å‚¨åœ¨å®¹å™¨ä¸­å¦‚æœä»¥å•ä¾‹å­˜åœ¨å°±è¿”å›true,å¦åˆ™è¿”å›false
    default boolean isSingleton() {
        return true;
    }
}
```

FactoryBeanè¡¨ç°çš„æ˜¯ä¸€ä¸ªå·¥å‚çš„èŒè´£,å¦‚æœä¸€ä¸ªBeanA æ˜¯å®ç°FactoryBeanæ¥å£,é‚£ä¹ˆAå°±æ˜¯å˜æˆäº†ä¸€ä¸ªå·¥å‚,æ ¹æ®Açš„åç§°è·å–åˆ°çš„å®é™…ä¸Šæ˜¯å·¥å‚è°ƒç”¨getObject()æ–¹æ³•è¿”å›çš„å¯¹è±¡,è€Œä¸æ˜¯å¯¹è±¡æœ¬èº«,å¦‚æœæƒ³è·å–å·¥å‚å¯¹è±¡æœ¬èº«,éœ€è¦åœ¨åç§°å‰é¢åŠ ä¸Š '&'ç¬¦å·

*   getObject('name') è¿”å›çš„æ˜¯å·¥å‚ä¸­å·¥å‚æ–¹æ³•ç”Ÿäº§çš„å®ä¾‹
*   getObject('&name') è¿”å›çš„æ˜¯å·¥å‚æœ¬èº«å®ä¾‹

**ä½¿ç”¨åœºæ™¯**

*   FactoryBeançš„æœ€ä¸ºç»å…¸çš„ä½¿ç”¨åœºæ™¯,å°±æ˜¯ç”¨æ¥åˆ›å»ºAOPä»£ç†å¯¹è±¡,è¿™ä¸ªå¯¹è±¡åœ¨Springä¸­å°±æ˜¯ ProxyFactoryBean

**BeanFactoryä¸FactoryBeanåŒºåˆ«**

*   ä»–ä»¬ä¸¤ä¸ªéƒ½æ˜¯å·¥å‚,ä½†æ˜¯FactoryBeanæœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªBean,ä¹Ÿå½’BeanFactoryç®¡ç†
*   BeanFactoryæ˜¯Springå®¹å™¨çš„é¡¶å±‚æ¥å£,FactoryBeanæ›´ç±»ä¼¼äºç”¨æˆ·è‡ªå®šä¹‰çš„å·¥å‚æ¥å£

**BeanFactoryå’ŒApplicationContextçš„åŒºåˆ«**

*   BeanFactoryæ˜¯Springå®¹å™¨çš„é¡¶å±‚æ¥å£,è€ŒApplicationContextåº”ç”¨ä¸Šä¸‹æ–‡ç±» ä»–æ˜¯BeanFactoryçš„å­ç±»,ä»–æ˜¯Springä¸­æ›´é«˜çº§çš„å®¹å™¨,æä¾›äº†æ›´å¤šçš„åŠŸèƒ½
    
    *   å›½é™…åŒ–
    *   è®¿é—®èµ„æº
    *   è½½å…¥å¤šä¸ªä¸Šä¸‹æ–‡
    *   æ¶ˆæ¯å‘é€ å“åº”æœºåˆ¶
*   ä¸¤è€…çš„è£…è½½beançš„æ—¶æœºä¸åŒ
    
    *   BeanFactory: åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ä¸ä¼šå»å®ä¾‹åŒ–bean,åªæœ‰ä»å®¹å™¨ä¸­æ‹¿beançš„æ—¶å€™æ‰ä¼šå»å®ä¾‹åŒ–(æ‡’åŠ è½½)
        
        *   ä¼˜ç‚¹: åº”ç”¨å¯åŠ¨çš„æ—¶å€™å ç”¨çš„èµ„æºæ¯”è¾ƒå°‘,å¯¹èµ„æºçš„ä½¿ç”¨è¦æ±‚æ¯”è¾ƒé«˜çš„åº”ç”¨ ,æ¯”è¾ƒæœ‰ä¼˜åŠ¿
    *   ApplicationContext:åœ¨å¯åŠ¨çš„æ—¶å€™å°±æŠŠæ‰€æœ‰çš„Beanå…¨éƒ¨å®ä¾‹åŒ–.
        
        *   lazy-init= true å¯ä»¥ä½¿beanå»¶æ—¶å®ä¾‹åŒ–
        *   ä¼˜ç‚¹: æ‰€æœ‰çš„Beanåœ¨å¯åŠ¨çš„æ—¶å€™å°±åŠ è½½,ç³»ç»Ÿè¿è¡Œçš„é€Ÿåº¦å¿«,è¿˜å¯ä»¥åŠæ—¶çš„å‘ç°ç³»ç»Ÿä¸­é…ç½®çš„é—®é¢˜.

3\. Springä¸­è§‚å¯Ÿè€…æ¨¡å¼çš„åº”ç”¨
-------------------

### 3.1. è§‚å¯Ÿè€…æ¨¡å¼ä¸å‘å¸ƒè®¢é˜…æ¨¡å¼çš„å¼‚åŒ

**è§‚å¯Ÿè€…æ¨¡å¼å®ƒæ˜¯ç”¨äºå»ºç«‹ä¸€ç§å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»,ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶å°†è‡ªåŠ¨é€šçŸ¥å…¶ä»–å¯¹è±¡,å…¶ä»–å¯¹è±¡å°†ç›¸åº”çš„ä½œå‡ºååº”.**

> åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­å‘ç”Ÿæ”¹å˜çš„å¯¹è±¡ç§°ä¸º**è§‚å¯Ÿç›®æ ‡**,è€Œè¢«é€šçŸ¥çš„å¯¹è±¡ç§°ä¸º**è§‚å¯Ÿè€…**,ä¸€ä¸ªè§‚å¯Ÿç›®æ ‡å¯ä»¥åº”å¯¹å¤šä¸ªè§‚å¯Ÿè€…,è€Œä¸”è¿™äº›è§‚å¯Ÿè€…ä¹‹é—´å¯ä»¥æ²¡æœ‰ä»»ä½•ç›¸äº’è”ç³»,å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…,ä½¿å¾—ç³»ç»Ÿæ›´æ˜“äºæ‰©å±•.

è§‚å¯Ÿè€…æ¨¡å¼çš„åˆ«åæœ‰å‘å¸ƒ-è®¢é˜…(Publish/Subscribe)æ¨¡å¼, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼ä¸å‘å¸ƒè®¢é˜…æ¨¡å¼ç»“æ„ä¸Šçš„åŒºåˆ«

*   åœ¨è®¾è®¡æ¨¡å¼ç»“æ„ä¸Šï¼Œå‘å¸ƒè®¢é˜…æ¨¡å¼**ç»§æ‰¿**è‡ªè§‚å¯Ÿè€…æ¨¡å¼ï¼Œæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°çš„å˜ä½“ã€‚
*   åœ¨è®¾è®¡æ¨¡å¼æ„å›¾ä¸Šï¼Œä¸¤è€…**å…³æ³¨ç‚¹**ä¸åŒï¼Œä¸€ä¸ªå…³å¿ƒæ•°æ®æºï¼Œä¸€ä¸ªå…³å¿ƒçš„æ˜¯äº‹ä»¶æ¶ˆæ¯ã€‚

![Image 2: 134.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3159391792e24abf9ebf11d870e6cf48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=hyX%2FK8YZfKaT8L7oBvJFLmiocoo%3D)

> è§‚å¯Ÿè€…æ¨¡å¼é‡Œï¼Œåªæœ‰ä¸¤ä¸ªè§’è‰² â€”â€” è§‚å¯Ÿè€… + è¢«è§‚å¯Ÿè€…; è€Œå‘å¸ƒè®¢é˜…æ¨¡å¼é‡Œï¼Œå´ä¸ä»…ä»…åªæœ‰å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¸¤ä¸ªè§’è‰²ï¼Œè¿˜æœ‰ä¸€ä¸ªç®¡ç†å¹¶æ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„ â€œç»çºªäººBrokerâ€
> 
> è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ï¼Œæ˜¯æ¾è€¦åˆçš„å…³ç³»;å‘å¸ƒè€…å’Œè®¢é˜…è€…ï¼Œåˆ™å®Œå…¨ä¸å­˜åœ¨è€¦åˆ

*   è§‚å¯Ÿè€…æ¨¡å¼ï¼š**æ•°æ®æºç›´æ¥é€šçŸ¥è®¢é˜…è€…å‘ç”Ÿæ”¹å˜ã€‚**
*   å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼š**æ•°æ®æºå‘Šè¯‰ç¬¬ä¸‰æ–¹ï¼ˆäº‹ä»¶é€šé“ï¼‰å‘ç”Ÿäº†æ”¹å˜ï¼Œç¬¬ä¸‰æ–¹å†é€šçŸ¥è®¢é˜…è€…å‘ç”Ÿäº†æ”¹å˜ã€‚**

### 3.2. Springä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼

Spring åŸºäºè§‚å¯Ÿè€…æ¨¡å¼ï¼Œå®ç°äº†è‡ªèº«çš„äº‹ä»¶æœºåˆ¶ä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œäº‹ä»¶é©±åŠ¨æ¨¡å‹é€šå¸¸ä¹Ÿè¢«ç†è§£æˆè§‚å¯Ÿè€…æˆ–è€…å‘å¸ƒ/è®¢é˜…æ¨¡å‹ã€‚

springäº‹ä»¶æ¨¡å‹æä¾›å¦‚ä¸‹å‡ ä¸ªè§’è‰²

*   **ApplicationEvent**
*   **ApplicationListener**
*   **ApplicationEventPublisher**
*   **ApplicationEventMulticaster**

**1) äº‹ä»¶ï¼šApplicationEvent**

*   æ˜¯æ‰€æœ‰äº‹ä»¶å¯¹è±¡çš„çˆ¶ç±»ã€‚ApplicationEvent ç»§æ‰¿è‡ª jdk çš„ EventObject, æ‰€æœ‰çš„äº‹ä»¶éƒ½éœ€è¦ç»§æ‰¿ ApplicationEvent, å¹¶ä¸”é€šè¿‡ source å¾—åˆ°äº‹ä»¶æºã€‚
    
    ```
    public abstract class ApplicationEvent extends EventObject {
        private static final long serialVersionUID = 7099057708183571937L;
        private final long timestamp = System.currentTimeMillis();
    
        public ApplicationEvent(Object source) {
            super(source);
        }
    
        public final long getTimestamp() {
            return this.timestamp;
        }
    }
    ```
    
*   Spring ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šå†…ç½®äº‹ä»¶:
    
    *   ContextRefreshEventï¼Œå½“ApplicationContextå®¹å™¨åˆå§‹åŒ–å®Œæˆæˆ–è€…è¢«åˆ·æ–°çš„æ—¶å€™ï¼Œå°±ä¼šå‘å¸ƒè¯¥äº‹ä»¶ã€‚
    *   ContextStartedEventï¼Œå½“ApplicationContextå¯åŠ¨çš„æ—¶å€™å‘å¸ƒäº‹ä»¶.
    *   ContextStoppedEventï¼Œå½“ApplicationContextå®¹å™¨åœæ­¢çš„æ—¶å€™å‘å¸ƒäº‹ä»¶.
    *   RequestHandledEventï¼Œåªèƒ½ç”¨äºDispatcherServletçš„webåº”ç”¨ï¼ŒSpringå¤„ç†ç”¨æˆ·è¯·æ±‚ç»“æŸåï¼Œç³»ç»Ÿä¼šè§¦å‘è¯¥äº‹ä»¶ã€‚

![Image 3: 133.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/859acb598b894d35960089d22677d637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=eJYexgHdu0vxTHrHwD%2FxnDhQpJ8%3D)

**2) äº‹ä»¶ç›‘å¬ï¼šApplicationListener**

*   ApplicationListener(åº”ç”¨ç¨‹åºäº‹ä»¶ç›‘å¬å™¨) ç»§æ‰¿è‡ªjdkçš„EventListener,æ‰€æœ‰çš„ç›‘å¬å™¨éƒ½è¦å®ç°è¿™ä¸ªæ¥å£,è¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªonApplicationEvent()æ–¹æ³•,è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªApplicationEventæˆ–å…¶å­ç±»å¯¹è±¡ä½œä¸ºå‚æ•°
    
*   åœ¨æ–¹æ³•ä½“ä¸­,å¯ä»¥é€šè¿‡ä¸åŒå¯¹Eventç±»çš„åˆ¤æ–­æ¥è¿›è¡Œç›¸åº”çš„å¤„ç†.å½“äº‹ä»¶è§¦å‘æ—¶æ‰€æœ‰çš„ç›‘å¬å™¨éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯,å¦‚æœä½ éœ€è¦å¯¹ç›‘å¬å™¨çš„æ¥æ”¶é¡ºåºæœ‰è¦æ±‚,å¯æ˜¯å®ç°è¯¥æ¥å£çš„ä¸€ä¸ªå®ç°`SmartApplicationListener`,é€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥æŒ‡å®šç›‘å¬å™¨æ¥æ”¶äº‹ä»¶çš„é¡ºåº.
    
    ```
    @FunctionalInterface
    public interface ApplicationListener<E extends ApplicationEvent> extends EventListener {
        void onApplicationEvent(E var1);
    }
    ```
    
*   å®ç°äº†ApplicationListeneræ¥å£ä¹‹åï¼Œéœ€è¦å®ç°æ–¹æ³•onApplicationEvent()ï¼Œåœ¨å®¹å™¨å°†æ‰€æœ‰çš„Beanéƒ½åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ã€‚
    

**3) äº‹ä»¶æºï¼šApplicationEventPublisher**

*   äº‹ä»¶çš„å‘å¸ƒè€…ï¼Œå°è£…äº†äº‹ä»¶å‘å¸ƒåŠŸèƒ½æ–¹æ³•æ¥å£ï¼Œæ˜¯Applicationcontextæ¥å£çš„è¶…ç±»
    
    > äº‹ä»¶æœºåˆ¶çš„å®ç°éœ€è¦ä¸‰ä¸ªéƒ¨åˆ†,äº‹ä»¶æº,äº‹ä»¶,äº‹ä»¶ç›‘å¬å™¨,åœ¨ä¸Šé¢ä»‹ç»çš„ApplicationEventå°±ç›¸å½“äºäº‹ä»¶,ApplicationListenerç›¸å½“äºäº‹ä»¶ç›‘å¬å™¨,è¿™é‡Œçš„äº‹ä»¶æºè¯´çš„å°±æ˜¯ApplicationEventPublisher.
    
    ```
    public interface ApplicationEventPublisher {
        default void publishEvent(ApplicationEvent event) {
            this.publishEvent((Object)event);
        }
    	//è°ƒç”¨publishEventæ–¹æ³•,ä¼ å…¥ä¸€ä¸ªApplicationEventçš„å®ç°ç±»å¯¹è±¡ä½œä¸ºå‚æ•°,æ¯å½“ApplicationContextå‘å¸ƒApplicationEventæ—¶,æ‰€æœ‰çš„ApplicationListenerå°±ä¼šè¢«è‡ªåŠ¨çš„è§¦å‘.
        void publishEvent(Object var1);
    }
    ```
    
*   æˆ‘ä»¬å¸¸ç”¨çš„`ApplicationContext`éƒ½ç»§æ‰¿äº†`AbstractApplicationContext`,åƒæˆ‘ä»¬å¹³æ—¶å¸¸è§`ClassPathXmlApplicationContext`ã€`XmlWebApplicationContex`ä¹Ÿéƒ½æ˜¯ç»§æ‰¿äº†å®ƒ,`AbstractApplicationcontext`æ˜¯`ApplicationContext`æ¥å£çš„æŠ½è±¡å®ç°ç±»,åœ¨è¯¥ç±»ä¸­å®ç°äº†`publishEvent`æ–¹æ³•:
    
    ```
       protected void publishEvent(Object event, @Nullable ResolvableType eventType) {
            Assert.notNull(event, "Event must not be null");
    
            if (this.earlyApplicationEvents != null) {
                this.earlyApplicationEvents.add(applicationEvent);
            } else {
              //äº‹ä»¶å‘å¸ƒå§”æ‰˜ç»™applicationEventMulticaster
              this.getApplicationEventMulticaster().multicastEvent((ApplicationEvent)applicationEvent, eventType);
            }
        }
    ```
    
    åœ¨è¿™ä¸ªæ–¹æ³•ä¸­,æˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªgetApplicationEventMulticaster().è¿™å°±è¦ç‰µæ‰¯åˆ°å¦ä¸€ä¸ªç±»ApplicationEventMulticaster.
    

**4) äº‹ä»¶ç®¡ç†ï¼šApplicationEventMulticaster**

*   ç”¨äºäº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œå’Œäº‹ä»¶çš„å¹¿æ’­ã€‚ç›‘å¬å™¨çš„æ³¨å†Œå°±æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŠŠ Applicationcontext å‘å¸ƒçš„ Event å¹¿æ’­ç»™å®ƒçš„ç›‘å¬å™¨åˆ—è¡¨ã€‚
    
    ```
    public interface ApplicationEventMulticaster {
        
        //æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        void addApplicationListener(ApplicationListener<?> var1);
    
        //æ·»åŠ äº‹ä»¶ç›‘å¬å™¨,ä½¿ç”¨å®¹å™¨ä¸­çš„bean
        void addApplicationListenerBean(String var1);
    
        //ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        void removeApplicationListener(ApplicationListener<?> var1);
    
        void removeApplicationListenerBean(String var1);
    
        //ç§»é™¤æ‰€æœ‰
        void removeAllListeners();
    
        //å‘å¸ƒäº‹ä»¶
        void multicastEvent(ApplicationEvent var1);
    
        void multicastEvent(ApplicationEvent var1, @Nullable ResolvableType var2);
    }
    ```
    
*   åœ¨AbstractApplicationcontextä¸­æœ‰ä¸€ä¸ªapplicationEventMulticasterçš„æˆå‘˜å˜é‡,æä¾›äº†ç›‘å¬å™¨Listenerçš„æ³¨å†Œæ–¹æ³•.
    
    ```
    public abstract class AbstractApplicationContext extends DefaultResourceLoader
            implements ConfigurableApplicationContext, DisposableBean {
    
    ã€€ã€€private ApplicationEventMulticaster applicationEventMulticaster;
        
    ã€€ã€€protected void registerListeners() {
            // Register statically specified listeners first.
            for (ApplicationListener<?> listener : getApplicationListeners()) {
                getApplicationEventMulticaster().addApplicationListener(listener);
            }
            // Do not initialize FactoryBeans here: We need to leave all regular beans
            // uninitialized to let post-processors apply to them!
            String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);
            for (String lisName : listenerBeanNames) {
                getApplicationEventMulticaster().addApplicationListenerBean(lisName);
            }
        }
    }
    ```
    

### 3.3. äº‹ä»¶ç›‘å¬æ¡ˆä¾‹

å®ç°ä¸€ä¸ªéœ€æ±‚ï¼šå½“è°ƒç”¨ä¸€ä¸ªç±»çš„æ–¹æ³•å®Œæˆæ—¶ï¼Œè¯¥ç±»å‘å¸ƒäº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨ç›‘å¬è¯¥ç±»çš„äº‹ä»¶å¹¶æ‰§è¡Œçš„è‡ªå·±çš„æ–¹æ³•é€»è¾‘

å‡è®¾è¿™ä¸ªç±»æ˜¯Requestã€å‘å¸ƒçš„äº‹ä»¶æ˜¯ReuqestEventã€äº‹ä»¶ç›‘å¬è€…æ˜¯ReuqestListenerã€‚å½“è°ƒç”¨Requestçš„doRequestæ–¹æ³•æ—¶ï¼Œå‘å¸ƒäº‹ä»¶ã€‚

ä»£ç å¦‚ä¸‹

```
/**
 * å®šä¹‰äº‹ä»¶
 * @date 2022/10/24
 **/
public class RequestEvent  extends ApplicationEvent {

    public RequestEvent(Object source) {
        super(source);
    }
}

/**
 * å‘å¸ƒäº‹ä»¶
 * @date 2022/10/24
 **/
@Component
public class Request {

    @Autowired
    private ApplicationContext applicationContext;

    public void doRequest(){
        System.out.println("è°ƒç”¨Requestç±»çš„doRequestæ–¹æ³•å‘é€ä¸€ä¸ªè¯·æ±‚......");
        applicationContext.publishEvent(new RequestEvent(this));
    }
}

/**
 * ç›‘å¬äº‹ä»¶
 * @date 2022/10/24
 **/
@Component
public class RequestListener implements ApplicationListener<RequestEvent> {

    @Override
    public void onApplicationEvent(RequestEvent requestEvent) {
        System.out.println("ç›‘å¬åˆ°RequestEventäº‹ä»¶,æ‰§è¡Œæœ¬æ–¹æ³•");
    }
}

public class SpringEventTest {

    public static void main(String[] args) {
        ApplicationContext context =
                new AnnotationConfigApplicationContext("com.xfc.pubsub");

        Request request = (Request) context.getBean("request");

        //è°ƒç”¨æ–¹æ³•å‘å¸ƒäº‹ä»¶
        request.doRequest();
    }
}

//æ‰“å°æ—¥å¿—
è°ƒç”¨Requestç±»çš„doRequestæ–¹æ³•å‘é€ä¸€ä¸ªè¯·æ±‚......
ç›‘å¬åˆ°RequestEventäº‹ä»¶,æ‰§è¡Œæœ¬æ–¹æ³•
```

### 3.4. äº‹ä»¶æœºåˆ¶å·¥ä½œæµç¨‹

ä¸Šé¢ä»£ç çš„æ‰§è¡Œæµç¨‹

![Image 4: 146.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faf169a2458842bfa6f7b076b334d24f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=bm7dAstLfqUwi7XNi0unBzFmKRE%3D)

1.  ç›‘å¬å™¨ä»€ä¹ˆæ—¶å€™æ³¨å†Œåˆ°IOCå®¹å™¨
    
    æ³¨å†Œçš„å¼€å§‹é€»è¾‘æ˜¯åœ¨AbstractApplicationContextç±»çš„refreshæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŒ…å«äº†æ•´ä¸ªIOCå®¹å™¨åˆå§‹åŒ–æ‰€æœ‰æ–¹æ³•ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªregisterListeners()æ–¹æ³•å°±æ˜¯æ³¨å†Œç³»ç»Ÿç›‘å¬è€…(springè‡ªå¸¦çš„)å’Œè‡ªå®šä¹‰ç›‘å¬å™¨çš„ã€‚
    
    ```
    public void refresh() throws BeansException, IllegalStateException {
        			//BeanFactoryå‡†å¤‡å·¥ä½œå®Œæˆåè¿›è¡Œçš„åç½®å¤„ç†å·¥ä½œ
                    this.postProcessBeanFactory(beanFactory);
        
        			//æ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•ï¼›
                    this.invokeBeanFactoryPostProcessors(beanFactory);
        
        			//æ³¨å†ŒBeanPostProcessorï¼ˆBeançš„åç½®å¤„ç†å™¨ï¼‰ï¼Œåœ¨åˆ›å»ºbeançš„å‰åç­‰æ‰§è¡Œ
                    this.registerBeanPostProcessors(beanFactory);
        	
        			//åˆå§‹åŒ–MessageSourceç»„ä»¶ï¼ˆåšå›½é™…åŒ–åŠŸèƒ½ï¼›æ¶ˆæ¯ç»‘å®šï¼Œæ¶ˆæ¯è§£æï¼‰ï¼›
                    this.initMessageSource();
        
        			//åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨
                    this.initApplicationEventMulticaster();
        
        			////å­ç±»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰é€»è¾‘ï¼›å¦‚åˆ›å»ºTomcatï¼ŒJettyç­‰WEBæœåŠ¡å™¨
                    this.onRefresh();
        
                        //æ³¨å†Œåº”ç”¨çš„ç›‘å¬å™¨ã€‚å°±æ˜¯æ³¨å†Œå®ç°äº†ApplicationListeneræ¥å£çš„ç›‘å¬å™¨beanï¼Œè¿™äº›ç›‘å¬å™¨æ˜¯æ³¨å†Œåˆ°ApplicationEventMulticasterä¸­çš„
                    this.registerListeners();
        
        			//åˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„éæ‡’åŠ è½½çš„å•ä¾‹bean
                    this.finishBeanFactoryInitialization(beanFactory);
        
        			//å®Œæˆcontextçš„åˆ·æ–°
                    this.finishRefresh();
        }
    ```
    
    çœ‹registerListenersçš„å…³é”®æ–¹æ³•ä½“ï¼Œå…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•`addApplicationListenerå’ŒaddApplicationListenerBean`ï¼Œä»æ–¹æ³•å¯ä»¥çœ‹å‡ºæ˜¯æ·»åŠ ç›‘å¬è€…ã€‚
    
    ```
    protected void registerListeners() {
        Iterator var1 = this.getApplicationListeners().iterator();
    
        while(var1.hasNext()) {
            ApplicationListener<?> listener = (ApplicationListener)var1.next();
            this.getApplicationEventMulticaster().addApplicationListener(listener);
        }
    
        String[] listenerBeanNames = this.getBeanNamesForType(ApplicationListener.class, true, false);
        String[] var7 = listenerBeanNames;
        int var3 = listenerBeanNames.length;
    
        for(int var4 = 0; var4 < var3; ++var4) {
            String listenerBeanName = var7[var4];
            this.getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);
        }
    }
    ```
    
    é‚£ä¹ˆæœ€åå°†ç›‘å¬è€…æ”¾åˆ°å“ªé‡Œäº†å‘¢ï¼Ÿå°±æ˜¯ApplicationEventMulticasteræ¥å£çš„å­ç±»
    

![Image 5: 135.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a54e00b4fff437e8232fc2f39a040c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=xS4qiYxLC6Hj6JhjDb3Jj0MPtVU%3D)

è¯¥æ¥å£ä¸»è¦ä¸¤ä¸ªèŒè´£ï¼Œç»´æŠ¤ApplicationListenerç›¸å…³ç±»å’Œå‘å¸ƒäº‹ä»¶ã€‚

å®ç°åœ¨é»˜è®¤å®ç°ç±»AbstractApplicationEventMulticasterï¼Œ`æœ€åå°†Listeneræ”¾åˆ°äº†å†…éƒ¨ç±»ListenerRetrieverä¸¤ä¸ªseté›†åˆä¸­`

```
private class ListenerRetriever {
        public final Set<ApplicationListener<?>> applicationListeners = new LinkedHashSet();
        public final Set<String> applicationListenerBeans = new LinkedHashSet();
}
```

ListenerRetrieverè¢«ç§°ä¸ºç›‘å¬å™¨æ³¨å†Œè¡¨ã€‚

2.  Springå¦‚ä½•å‘å¸ƒçš„äº‹ä»¶å¹¶é€šçŸ¥ç›‘å¬è€…
    
    **è¿™ä¸ªæ³¨æ„çš„æœ‰ä¸¤ä¸ªæ–¹æ³•**
    
    **1) publishEventæ–¹æ³•**
    
    *   `AbstractApplicationContext`å®ç°äº†`ApplicationEventPublisher` æ¥å£çš„`publishEvent`æ–¹æ³•
    
    ```
    protected void publishEvent(Object event, @Nullable ResolvableType eventType) {
        Assert.notNull(event, "Event must not be null");
        Object applicationEvent;
        
        //å°è¯•è½¬æ¢ä¸ºApplicationEventæˆ–è€…PayloadApplicationEventï¼Œå¦‚æœæ˜¯PayloadApplicationEventåˆ™è·å–eventType
        if (event instanceof ApplicationEvent) {
            applicationEvent = (ApplicationEvent)event;
        } else {
            applicationEvent = new PayloadApplicationEvent(this, event);
            if (eventType == null) {
                eventType = ((PayloadApplicationEvent)applicationEvent).getResolvableType();
            }
        }
    
       
        if (this.earlyApplicationEvents != null) {
             //åˆ¤æ–­earlyApplicationEventsæ˜¯å¦ä¸ºç©º(ä¹Ÿå°±æ˜¯æ—©æœŸäº‹ä»¶è¿˜æ²¡æœ‰è¢«å‘å¸ƒ-è¯´æ˜å¹¿æ’­å™¨è¿˜æ²¡æœ‰å®ä¾‹åŒ–å¥½)ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™å°†å½“å‰äº‹ä»¶æ”¾å…¥é›†åˆ
            this.earlyApplicationEvents.add(applicationEvent);
        } else {
            //å¦åˆ™è·å–ApplicationEventMulticasterè°ƒç”¨å…¶multicastEventå°†äº‹ä»¶å¹¿æ’­å‡ºå»ã€‚æœ¬æ–‡è¿™é‡Œè·å–åˆ°çš„å¹¿æ’­å™¨å®ä¾‹æ˜¯SimpleApplicationEventMulticasterã€‚
            this.getApplicationEventMulticaster().multicastEvent((ApplicationEvent)applicationEvent, eventType);
        }
    	
        //å°†äº‹ä»¶äº¤ç»™çˆ¶ç±»å¤„ç†
        if (this.parent != null) {
            if (this.parent instanceof AbstractApplicationContext) {
                ((AbstractApplicationContext)this.parent).publishEvent(event, eventType);
            } else {
                this.parent.publishEvent(event);
            }
        }
    
    }
    ```
    
    **2) multicastEventæ–¹æ³•**
    
    ç»§ç»­è¿›å…¥åˆ°`multicastEventæ–¹æ³•`ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ç§æ–¹å¼è°ƒç”¨invokeListenerï¼Œé€šè¿‡çº¿ç¨‹æ± å’Œç›´æ¥è°ƒç”¨ï¼Œè¿›ä¸€æ­¥è¯´å°±æ˜¯é€šè¿‡å¼‚æ­¥å’ŒåŒæ­¥ä¸¤ç§æ–¹å¼è°ƒç”¨.
    
    ```
    public void multicastEvent(ApplicationEvent event, @Nullable ResolvableType eventType) {
        
        //è§£æäº‹ä»¶ç±»å‹
        ResolvableType type = eventType != null ? eventType : this.resolveDefaultEventType(event);
        
        //è·å–æ‰§è¡Œå™¨
        Executor executor = this.getTaskExecutor();
        
        // è·å–åˆé€‚çš„ApplicationListenerï¼Œå¾ªç¯è°ƒç”¨ç›‘å¬å™¨çš„onApplicationEventæ–¹æ³•
        Iterator var5 = this.getApplicationListeners(event, type).iterator();
    
        while(var5.hasNext()) {
            ApplicationListener<?> listener = (ApplicationListener)var5.next();
            if (executor != null) {
                //å¦‚æœexecutorä¸ä¸ºnullï¼Œåˆ™äº¤ç»™executorå»è°ƒç”¨ç›‘å¬å™¨
                executor.execute(() -> {
                    this.invokeListener(listener, event);
                });
            } else {
                //å¦åˆ™ï¼Œä½¿ç”¨å½“å‰ä¸»çº¿ç¨‹ç›´æ¥è°ƒç”¨ç›‘å¬å™¨ï¼›
                this.invokeListener(listener, event);
            }
        }
    
    }
    ```
    
    **3) invokeListeneræ–¹æ³•**
    
    ```
    // è¯¥æ–¹æ³•å¢åŠ äº†é”™è¯¯å¤„ç†é€»è¾‘ï¼Œç„¶åè°ƒç”¨doInvokeListener
    protected void invokeListener(ApplicationListener<?> listener, ApplicationEvent event) {
     Â  Â ErrorHandler errorHandler = this.getErrorHandler();
     Â  Â if (errorHandler != null) {
     Â  Â  Â  Â try {
     Â  Â  Â  Â  Â  Â this.doInvokeListener(listener, event);
     Â  Â  Â   } catch (Throwable var5) {
     Â  Â  Â  Â  Â  Â errorHandler.handleError(var5);
     Â  Â  Â   }
     Â   } else {
     Â  Â  Â  Â this.doInvokeListener(listener, event);
     Â   }
    â€‹
    }
    â€‹
    private void doInvokeListener(ApplicationListener listener, ApplicationEvent event) {
     Â  Â //ç›´æ¥è°ƒç”¨äº†listeneræ¥å£çš„onApplicationEventæ–¹æ³•
     Â  Â listener.onApplicationEvent(event); Â 
    }
    ```
    

4\. ç»“åˆè®¾è®¡æ¨¡å¼è‡ªå®šä¹‰SpringIOC
----------------------

### 4.1. Spring IOCæ ¸å¿ƒç»„ä»¶

**1) BeanFactory**

BeanFactoryä½œä¸ºæœ€é¡¶å±‚çš„ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†IoCå®¹å™¨çš„åŸºæœ¬åŠŸèƒ½è§„èŒƒ

![Image 6: 137.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57fa057139464cf6888011cecdec7c3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=jOKVvB9xLCqIILeQjq13awTXNao%3D)

ä»ç±»å›¾ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°æœ€ç»ˆçš„é»˜è®¤å®ç°ç±»æ˜¯DefaultListableBeanFactoryï¼Œå®ƒå®ç°äº†æ‰€æœ‰çš„æ¥å£ã€‚é‚£ä¹ˆä¸ºä½•è¦å®šä¹‰è¿™ä¹ˆå¤šå±‚æ¬¡çš„æ¥å£å‘¢ï¼Ÿ æ¯ä¸ªæ¥å£éƒ½æœ‰å®ƒçš„ä½¿ç”¨åœºåˆï¼Œä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†åœ¨Springå†…éƒ¨æ“ä½œè¿‡ç¨‹ä¸­å¯¹è±¡çš„ä¼ é€’å’Œè½¬åŒ–ï¼Œå¯¹å¯¹è±¡çš„æ•°æ®è®¿é—®æ‰€åšçš„é™åˆ¶ã€‚

ä¾‹å¦‚ï¼Œ

*   ListableBeanFactoryæ¥å£è¡¨ç¤ºè¿™äº›Beanå¯åˆ—è¡¨åŒ–ã€‚
*   HierarchicalBeanFactoryè¡¨ç¤ºè¿™äº›Bean æ˜¯æœ‰ç»§æ‰¿å…³ç³»çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª Bean å¯èƒ½æœ‰çˆ¶ Bean
*   AutowireCapableBeanFactory æ¥å£å®šä¹‰Beançš„è‡ªåŠ¨è£…é…è§„åˆ™ã€‚

è¿™ä¸‰ä¸ªæ¥å£å…±åŒå®šä¹‰äº†Beançš„é›†åˆã€Beanä¹‹é—´çš„å…³ç³»åŠBeanè¡Œä¸ºã€‚

åœ¨BeanFactoryé‡Œåªå¯¹IoCå®¹å™¨çš„åŸºæœ¬è¡Œä¸ºåšäº†å®šä¹‰ï¼Œæ ¹æœ¬ä¸å…³å¿ƒä½ çš„Beanæ˜¯å¦‚ä½•å®šä¹‰åŠæ€æ ·åŠ è½½çš„ã€‚æ­£å¦‚æˆ‘ä»¬åªå…³å¿ƒèƒ½ä»å·¥å‚é‡Œå¾—åˆ°ä»€ä¹ˆäº§å“ï¼Œä¸å…³å¿ƒå·¥å‚æ˜¯æ€ä¹ˆç”Ÿäº§è¿™äº›äº§å“çš„ã€‚

**2 ) ApplicationContext**

BeanFactoryæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å­æ¥å£ï¼Œå°±æ˜¯ApplicationContextæ¥å£ï¼Œè¯¥æ¥å£ä¸»è¦æ¥è§„èŒƒå®¹å™¨ä¸­çš„beanå¯¹è±¡æ˜¯éå»¶æ—¶åŠ è½½ï¼Œå³åœ¨åˆ›å»ºå®¹å™¨å¯¹è±¡çš„æ—¶å€™å°±å¯¹è±¡beanè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶å­˜å‚¨åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ã€‚

```
//å»¶æ—¶åŠ è½½
BeanFactory factory = new XmlBeanFactory(new ClassPathResource("bean.xml"));

//ç«‹å³åŠ è½½
ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("bean.xml");
User user = context.getBean("user", User.class);
```

ApplicationContext çš„å­ç±»ä¸»è¦åŒ…å«ä¸¤ä¸ªæ–¹é¢ï¼š

*   `ConfigurableApplicationContext` è¡¨ç¤ºè¯¥ Context æ˜¯å¯ä¿®æ”¹çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨æ„å»º Context ä¸­ç”¨æˆ·å¯ä»¥åŠ¨æ€æ·»åŠ æˆ–ä¿®æ”¹å·²æœ‰çš„é…ç½®ä¿¡æ¯
*   `WebApplicationContext` é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸º web å‡†å¤‡çš„ Context ä»–å¯ä»¥ç›´æ¥è®¿é—®åˆ° ServletContextï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ¥å£ä½¿ç”¨å°‘

è¦çŸ¥é“å·¥å‚æ˜¯å¦‚ä½•äº§ç”Ÿå¯¹è±¡çš„ï¼Œæˆ‘ä»¬éœ€è¦çœ‹å…·ä½“çš„IoCå®¹å™¨å®ç°ï¼ŒSpringæä¾›äº†è®¸å¤šIoCå®¹å™¨å®ç°ï¼Œæ¯”å¦‚ï¼š

*   `ClasspathXmlApplicationContext` : æ ¹æ®ç±»è·¯å¾„åŠ è½½xmlé…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºIOCå®¹å™¨å¯¹è±¡ã€‚
*   `FileSystemXmlApplicationContext` ï¼šæ ¹æ®ç³»ç»Ÿè·¯å¾„åŠ è½½xmlé…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºIOCå®¹å™¨å¯¹è±¡ã€‚
*   `AnnotationConfigApplicationContext` ï¼šåŠ è½½æ³¨è§£ç±»é…ç½®ï¼Œå¹¶åˆ›å»ºIOCå®¹å™¨ã€‚

![Image 7: 138.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ffae0f86ff497e881c6d1070aef63e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=sl1ufx7aPaGakqWxoWOYHYSizTY%3D)

æ€»ä½“æ¥è¯´ ApplicationContext å¿…é¡»è¦å®Œæˆä»¥ä¸‹å‡ ä»¶äº‹ï¼š

*   æ ‡è¯†ä¸€ä¸ªåº”ç”¨ç¯å¢ƒ
*   åˆ©ç”¨ BeanFactory åˆ›å»º Bean å¯¹è±¡
*   ä¿å­˜å¯¹è±¡å…³ç³»è¡¨
*   èƒ½å¤Ÿæ•è·å„ç§äº‹ä»¶

**3) Beanå®šä¹‰ï¼šBeanDefinition**

è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­

```
public class DefaultListableBeanFactory extends AbstractAutowireCapableBeanFactory
        implements ConfigurableListableBeanFactory, BeanDefinitionRegistry, Serializable {
	//DefaultListableBeanFactory ä¸­ä½¿ç”¨ Map ç»“æ„ä¿å­˜æ‰€æœ‰çš„ BeanDefinition ä¿¡æ¯
    private final Map<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap<>(256); 
}   
```

**BeanDefinition** ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚

**4) BeanDefinitionReader**

Beançš„è§£æè¿‡ç¨‹éå¸¸å¤æ‚ï¼ŒåŠŸèƒ½è¢«åˆ†å¾—å¾ˆç»†ï¼Œå› ä¸ºè¿™é‡Œéœ€è¦è¢«æ‰©å±•çš„åœ°æ–¹å¾ˆå¤šï¼Œå¿…é¡»ä¿è¯è¶³å¤Ÿçš„çµæ´»æ€§ï¼Œä»¥åº”å¯¹å¯èƒ½çš„å˜åŒ–ã€‚Beançš„è§£æä¸»è¦å°±æ˜¯å¯¹Springé…ç½®æ–‡ä»¶çš„è§£æã€‚

è¿™ä¸ªè§£æè¿‡ç¨‹ä¸»è¦é€šè¿‡BeanDefinitionReaderæ¥å®Œæˆï¼Œçœ‹çœ‹Springä¸­BeanDefinitionReaderçš„ç±»ç»“æ„å›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![Image 8: 140.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98e678faf8c943e0a070afc024b58403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=M4mES34%2FMCM4ieBwrg9aOuba7wA%3D)

BeanDefinitionReaderæ¥å£å®šä¹‰çš„åŠŸèƒ½

```
public interface BeanDefinitionReader {

	/*
		ä¸‹é¢çš„loadBeanDefinitionséƒ½æ˜¯åŠ è½½beanå®šä¹‰ï¼Œä»æŒ‡å®šçš„èµ„æºä¸­
	*/
	int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException;
	int loadBeanDefinitions(Resource... resources) throws BeanDefinitionStoreException;
	int loadBeanDefinitions(String location) throws BeanDefinitionStoreException;
	int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException;
}
```

**5) BeanFactoryåç½®å¤„ç†å™¨**

åç½®å¤„ç†å™¨æ˜¯ä¸€ç§æ‹“å±•æœºåˆ¶ï¼Œè´¯ç©¿Spring Beançš„ç”Ÿå‘½å‘¨æœŸ

åç½®å¤„ç†å™¨åˆ†ä¸ºä¸¤ç±»ï¼š

**BeanFactoryåç½®å¤„ç†å™¨ï¼šBeanFactoryPostProcessor**

å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨springçš„beanåˆ›å»ºä¹‹å‰ï¼Œä¿®æ”¹beançš„å®šä¹‰å±æ€§

![Image 9: 141.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8677ca0274492890ef2f778a37f55f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=g4W6J1wCoNM5RqIIktpmg%2FGdqPM%3D)

```
public interface BeanFactoryPostProcessor {

    /*
     *  è¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•postProcessBeanFactoryï¼Œæ–¹æ³•å‚æ•°æ˜¯ConfigurableListableBeanFactoryï¼Œé€šè¿‡è¯¥
        å‚æ•°ï¼Œå¯ä»¥è·å–BeanDefinition
    */
    void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException;
}
```

**6) Beanåç½®å¤„ç†å™¨ï¼šBeanPostProcessor**

BeanPostProcessoræ˜¯Spring IOCå®¹å™¨ç»™æˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæ‰©å±•æ¥å£

å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨springå®¹å™¨å®ä¾‹åŒ–beanä¹‹åï¼Œåœ¨æ‰§è¡Œbeançš„åˆå§‹åŒ–æ–¹æ³•å‰åï¼Œæ·»åŠ ä¸€äº›å¤„ç†é€»è¾‘

![Image 10: ec51548d8fd231991a603771a114b7ed.jpeg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e628653380d2417184013e92efc9dcd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=qcDfGoHXvfmx846lkl7cva8icjw%3D)

```
public interface BeanPostProcessor {
    //beanåˆå§‹åŒ–æ–¹æ³•è°ƒç”¨å‰è¢«è°ƒç”¨
    Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException;
    //beanåˆå§‹åŒ–æ–¹æ³•è°ƒç”¨åè¢«è°ƒç”¨
    Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;
}
```

### 4.2. IOCæµç¨‹å›¾

![Image 11: d09e79e71bb191a06aba33c59dacd5d0.jpeg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5b3e98cbc774037a058a17f895fedc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=%2Fk6FyL%2BUsiwIX9tIrvYhEir%2FSGo%3D)

1.  å®¹å™¨ç¯å¢ƒçš„åˆå§‹åŒ–(ç³»ç»Ÿã€JVM ã€è§£æå™¨ã€ç±»åŠ è½½å™¨ç­‰ç­‰)
2.  Beanå·¥å‚çš„åˆå§‹åŒ–(IOCå®¹å™¨é¦–å…ˆä¼šé”€æ¯æ—§å·¥å‚,æ—§Beanã€åˆ›å»ºæ–°çš„å·¥å‚)
3.  è¯»å–ï¼šé€šè¿‡BeanDefinitonReaderè¯»å–æˆ‘ä»¬é¡¹ç›®ä¸­çš„é…ç½®ï¼ˆapplication.xmlï¼‰
4.  å®šä¹‰ï¼šé€šè¿‡è§£æxmlæ–‡ä»¶å†…å®¹ï¼Œå°†é‡Œé¢çš„Beanè§£ææˆBeanDefinitionï¼ˆæœªå®ä¾‹åŒ–ã€æœªåˆå§‹åŒ–ï¼‰
5.  å°†è§£æå¾—åˆ°çš„BeanDefinition,å­˜å‚¨åˆ°å·¥å‚ç±»çš„Mapå®¹å™¨ä¸­
6.  è°ƒç”¨ BeanFactoryPostProcessor è¯¥æ–¹æ³•æ˜¯ä¸€ç§åŠŸèƒ½å¢å¼ºï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ­¥éª¤å¯¹å·²ç»å®Œæˆåˆå§‹åŒ–çš„ BeanFactory è¿›è¡Œå±æ€§è¦†ç›–ï¼Œæˆ–æ˜¯ä¿®æ”¹å·²ç»æ³¨å†Œåˆ° BeanFactory çš„ BeanDefinition
7.  é€šè¿‡åå°„å®ä¾‹åŒ–beanå¯¹è±¡
8.  è¿›å…¥åˆ°Beanå®ä¾‹åŒ–æµç¨‹,é¦–å…ˆè®¾ç½®å¯¹è±¡å±æ€§
9.  æ£€æŸ¥Awareç›¸å…³æ¥å£,å¹¶è®¾ç½®ç›¸å…³ä¾èµ–
10.  å‰ç½®å¤„ç†å™¨,æ‰§è¡ŒBeanPostProcesserçš„beforeæ–¹æ³•å¯¹beanè¿›è¡Œæ‰©å±•
11.  æ£€æŸ¥æ˜¯å¦æœ‰å®ç°initializingBean å›è°ƒæ¥å£,å¦‚æœå®ç°å°±è¦å›è°ƒå…¶ä¸­çš„AftpropertiesSet() æ–¹æ³•,(é€šè¿‡å¯ä»¥å®Œæˆä¸€äº›é…ç½®çš„åŠ è½½)
12.  æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®è‡ªå®šä¹‰çš„init-method ,
13.  åç½®å¤„ç†å™¨æ‰§è¡ŒBeanPostProcesser çš„afteræ–¹æ³• --\> AOPå°±æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆçš„, åœ¨è¿™é‡Œåˆ¤æ–­beanå¯¹è±¡æ˜¯å¦å®ç°æ¥å£,å®ç°å°±ä½¿ç”¨JDKä»£ç†,å¦åˆ™é€‰æ‹©CGLIB
14.  å¯¹è±¡åˆ›å»ºå®Œæˆ,æ·»åŠ åˆ°BeanFactoryçš„å•ä¾‹æ± ä¸­

### 4.3. è‡ªå®šä¹‰SpringIOC

å¯¹ä¸‹é¢çš„é…ç½®æ–‡ä»¶è¿›è¡Œè§£æï¼Œå¹¶è‡ªå®šä¹‰SpringIOC, å¯¹æ¶‰åŠåˆ°çš„å¯¹è±¡è¿›è¡Œç®¡ç†ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<beans>
    <bean id="courseService" class="com.xfc.service.impl.CourseServiceImpl">
        <property name="courseDao" ref="courseDao"></property>
    </bean>
    <bean id="courseDao" class="com.xfc.dao.impl.CourseDaoImpl"></bean>
</beans>
```

1.  åˆ›å»ºä¸Beanç›¸å…³çš„pojoç±»

*   **PropertyValueç±»**: ç”¨äºå°è£…beançš„å±æ€§ï¼Œä½“ç°åˆ°ä¸Šé¢çš„é…ç½®æ–‡ä»¶å°±æ˜¯å°è£…beanæ ‡ç­¾çš„å­æ ‡ç­¾propertyæ ‡ç­¾æ•°æ®ã€‚

```
package com.xfc.framework.beans;

/**
 * è¯¥ç±»ç”¨æ¥å°è£…beanæ ‡ç­¾ä¸‹çš„propertyå­æ ‡ç­¾çš„å±æ€§
 * Â  Â   1.nameå±æ€§
 * Â  Â   2.refå±æ€§
 * Â  Â   3.valueå±æ€§: ç»™åŸºæœ¬æ•°æ®ç±»å‹åŠstringç±»å‹æ•°æ®èµ‹çš„å€¼
 * @date 2022/10/26
 **/
public class PropertyValue {

 Â  Â private String name;

 Â  Â private String ref;

 Â  Â private String value;

 Â  Â public PropertyValue() {
 Â   }

 Â  Â public PropertyValue(String name, String ref, String value) {
 Â  Â  Â  Â this.name = name;
 Â  Â  Â  Â this.ref = ref;
 Â  Â  Â  Â this.value = value;
 Â   }

 Â  Â public String getName() {
 Â  Â  Â  Â return name;
 Â   }

 Â  Â public void setName(String name) {
 Â  Â  Â  Â this.name = name;
 Â   }

 Â  Â public String getRef() {
 Â  Â  Â  Â return ref;
 Â   }

 Â  Â public void setRef(String ref) {
 Â  Â  Â  Â this.ref = ref;
 Â   }

 Â  Â public String getValue() {
 Â  Â  Â  Â return value;
 Â   }

 Â  Â public void setValue(String value) {
 Â  Â  Â  Â this.value = value;
 Â   }
}
```

*   **MutablePropertyValuesç±»**: ä¸€ä¸ªbeanæ ‡ç­¾å¯ä»¥æœ‰å¤šä¸ªpropertyå­æ ‡ç­¾ï¼Œæ‰€ä»¥å†å®šä¹‰ä¸€ä¸ªMutablePropertyValuesç±»ï¼Œç”¨æ¥å­˜å‚¨å¹¶ç®¡ç†å¤šä¸ªPropertyValueå¯¹è±¡ã€‚

```
package com.xfc.framework.beans;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;

/**
 * è¯¥ç±»ç”¨æ¥å­˜å‚¨å’Œéå†å¤šä¸ªPropertyValueå¯¹è±¡
 * @date 2022/10/26
 **/
public class MutablePropertyValues implements Iterable<PropertyValue>{

 Â  Â //å®šä¹‰Listé›†åˆ,å­˜å‚¨PropertyValueçš„å®¹å™¨
 Â  Â private final List<PropertyValue> propertyValueList;

 Â  Â //ç©ºå‚æ„é€ ä¸­ åˆå§‹åŒ–ä¸€ä¸ªlist
 Â  Â public MutablePropertyValues() {
 Â  Â  Â  Â this.propertyValueList = new ArrayList<PropertyValue>();
 Â   }

 Â  Â //æœ‰å‚æ„é€  æ¥æ”¶ä¸€ä¸ªå¤–éƒ¨ä¼ å…¥çš„list,èµ‹å€¼propertyValueListå±æ€§
 Â  Â public MutablePropertyValues(List<PropertyValue> propertyValueList) {
 Â  Â  Â  Â if(propertyValueList == null){
 Â  Â  Â  Â  Â  Â this.propertyValueList = new ArrayList<PropertyValue>();
 Â  Â  Â   }else{
 Â  Â  Â  Â  Â  Â this.propertyValueList = propertyValueList;
 Â  Â  Â   }
 Â   }

 Â  Â //è·å–å½“å‰å®¹å™¨å¯¹åº”çš„è¿­ä»£å™¨å¯¹è±¡
 Â  Â @Override
 Â  Â public Iterator<PropertyValue> iterator() {

 Â  Â  Â  Â //ç›´æ¥è·å–Listé›†åˆä¸­çš„è¿­ä»£å™¨
 Â  Â  Â  Â return propertyValueList.iterator();
 Â   }

 Â  Â //è·å–æ‰€æœ‰çš„PropertyValue
 Â  Â public PropertyValue[] getPropertyValues(){
 Â  Â  Â  Â //å°†é›†åˆè½¬æ¢ä¸ºæ•°ç»„å¹¶è¿”å›
 Â  Â  Â  Â return propertyValueList.toArray(new PropertyValue[0]); //new PropertyValue[0]å£°æ˜è¿”å›çš„æ•°ç»„ç±»å‹
 Â   }

 Â  Â //æ ¹æ®nameå±æ€§å€¼è·å–PropertyValue
 Â  Â public PropertyValue getPropertyValue(String propertyName){
 Â  Â  Â  Â //éå†é›†åˆå¯¹è±¡
 Â  Â  Â  Â for (PropertyValue propertyValue : propertyValueList) {
 Â  Â  Â  Â  Â  Â if(propertyValue.getName().equals(propertyName)){
 Â  Â  Â  Â  Â  Â  Â  Â return propertyValue;
 Â  Â  Â  Â  Â   }
 Â  Â  Â   }

 Â  Â  Â  Â return null;
 Â   }

 Â  Â //åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º,æ˜¯å¦å­˜å‚¨PropertyValue
 Â  Â public boolean isEmpty(){
 Â  Â  Â  Â return propertyValueList.isEmpty();
 Â   }

 Â  Â //å‘é›†åˆä¸­æ·»åŠ 
 Â  Â public MutablePropertyValues addPropertyValue(PropertyValue value){
 Â  Â  Â  Â //åˆ¤æ–­é›†åˆä¸­å­˜å‚¨çš„propertyvalueå¯¹è±¡.æ˜¯å¦é‡å¤,é‡å¤å°±è¿›è¡Œè¦†ç›–
 Â  Â  Â  Â for (int i = 0; i < propertyValueList.size(); i++) {
 Â  Â  Â  Â  Â  Â //è·å–é›†åˆä¸­æ¯ä¸€ä¸ª PropertyValue
 Â  Â  Â  Â  Â  Â PropertyValue currentPv = propertyValueList.get(i);

 Â  Â  Â  Â  Â  Â //åˆ¤æ–­å½“å‰çš„pvçš„nameå±æ€§ æ˜¯å¦ä¸ä¼ å…¥çš„ç›¸åŒ,å¦‚æœç›¸åŒå°±è¦†ç›–
 Â  Â  Â  Â  Â  Â if(currentPv.getName().equals(value.getName())){
 Â  Â  Â  Â  Â  Â  Â  Â propertyValueList.set(i,value);
 Â  Â  Â  Â  Â  Â  Â  Â return this;
 Â  Â  Â  Â  Â   }
 Â  Â  Â   }

 Â  Â  Â  Â //æ²¡æœ‰é‡å¤
 Â  Â  Â  Â this.propertyValueList.add(value);
 Â  Â  Â  Â return this; Â //ç›®çš„æ˜¯å®ç°é“¾å¼ç¼–ç¨‹
 Â   }

 Â  Â //åˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šnameå±æ€§å€¼çš„å¯¹è±¡
 Â  Â public boolean contains(String propertyName){
 Â  Â  Â  Â return getPropertyValue(propertyName) != null;
 Â   }
}
```

*   **BeanDefinitionç±»**: ç”¨æ¥å°è£…beanä¿¡æ¯çš„ï¼Œä¸»è¦åŒ…å«idï¼ˆå³beanå¯¹è±¡çš„åç§°ï¼‰ã€classï¼ˆéœ€è¦äº¤ç”±springç®¡ç†çš„ç±»çš„å…¨ç±»åï¼‰åŠå­æ ‡ç­¾propertyæ•°æ®ã€‚

```
/**
 * å°è£…Beanæ ‡ç­¾æ•°æ®çš„ç±»,åŒ…æ‹¬idä¸classä»¥åŠå­æ ‡ç­¾çš„æ•°æ®
 * @date 2022/10/27
 **/
public class BeanDefinition {

 Â  Â private String id;

 Â  Â private String className;

 Â  Â private MutablePropertyValues propertyValues;

 Â  Â public BeanDefinition() {
 Â  Â  Â  Â propertyValues = new MutablePropertyValues();
 Â   }

 Â  Â public String getId() {
 Â  Â  Â  Â return id;
 Â   }

 Â  Â public void setId(String id) {
 Â  Â  Â  Â this.id = id;
 Â   }

 Â  Â public String getClassName() {
 Â  Â  Â  Â return className;
 Â   }

 Â  Â public void setClassName(String className) {
 Â  Â  Â  Â this.className = className;
 Â   }

 Â  Â public MutablePropertyValues getPropertyValues() {
 Â  Â  Â  Â return propertyValues;
 Â   }

 Â  Â public void setPropertyValues(MutablePropertyValues propertyValues) {
 Â  Â  Â  Â this.propertyValues = propertyValues;
 Â   }
}
```

2.  åˆ›å»ºæ³¨å†Œè¡¨ç›¸å…³çš„ç±»

BeanDefinitionå¯¹è±¡å­˜å–çš„æ“ä½œ, å…¶å®æ˜¯åœ¨BeanDefinitionRegistryæ¥å£ä¸­å®šä¹‰çš„,å®ƒè¢«ç§°ä¸ºæ˜¯BeanDefinitionçš„æ³¨å†Œä¸­å¿ƒ.

```
//æºç 
public interface BeanDefinitionRegistry extends AliasRegistry {

	void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)
			throws BeanDefinitionStoreException;

	void removeBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;

	BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;

	boolean containsBeanDefinition(String beanName);

	String[] getBeanDefinitionNames();
    
	int getBeanDefinitionCount();
    
	boolean isBeanNameInUse(String beanName);
}
```

BeanDefinitionRegistryç»§æ‰¿ç»“æ„å›¾å¦‚ä¸‹ï¼š

![Image 12: 03eeed0e1ed0cd0c2b5a96ab87ed344e.jpeg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba2a462cf1b0425a9577de1b16fd99da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=%2FvJAL4MN9IUwdVvpZ7FvxBfx63k%3D)

BeanDefinitionRegistryæ¥å£çš„å­å®ç°ç±»ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š

*   DefaultListableBeanFactory
    
    åœ¨è¯¥ç±»ä¸­å®šä¹‰äº†å¦‚ä¸‹ä»£ç ï¼Œå°±æ˜¯ç”¨æ¥æ³¨å†Œbean
    
    ```
    private final Map<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap<>(256);
    ```
    
*   SimpleBeanDefinitionRegistry
    
    åœ¨è¯¥ç±»ä¸­å®šä¹‰äº†å¦‚ä¸‹ä»£ç ï¼Œå°±æ˜¯ç”¨æ¥æ³¨å†Œbean
    
    ```
    private final Map<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap<>(64);
    ```
    

*   è‡ªå®šä¹‰BeanDefinitionRegistryæ¥å£å®šä¹‰äº†æ³¨å†Œè¡¨çš„ç›¸å…³æ“ä½œï¼Œå®šä¹‰å¦‚ä¸‹åŠŸèƒ½ï¼š

```
public interface BeanDefinitionRegistry {

    //æ³¨å†ŒBeanDefinitionå¯¹è±¡åˆ°æ³¨å†Œè¡¨ä¸­
    void registerBeanDefinition(String beanName, BeanDefinition beanDefinition);

    //ä»æ³¨å†Œè¡¨ä¸­åˆ é™¤æŒ‡å®šåç§°çš„BeanDefinitionå¯¹è±¡
    void removeBeanDefinition(String beanName) throws Exception;

    //æ ¹æ®åç§°ä»æ³¨å†Œè¡¨ä¸­è·å–BeanDefinitionå¯¹è±¡
    BeanDefinition getBeanDefinition(String beanName) throws Exception;

    //åˆ¤æ–­æ³¨å†Œè¡¨ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šåç§°çš„BeanDefinitionå¯¹è±¡
    boolean containsBeanDefinition(String beanName);

    //è·å–æ³¨å†Œè¡¨ä¸­BeanDefinitionå¯¹è±¡çš„ä¸ªæ•°
    int getBeanDefinitionCount();

    //è·å–æ³¨å†Œè¡¨ä¸­æ‰€æœ‰çš„BeanDefinitionçš„åç§°
    String[] getBeanDefinitionNames();
}
```

*   SimpleBeanDefinitionRegistryç±», è¯¥ç±»å®ç°äº†BeanDefinitionRegistryæ¥å£ï¼Œå®šä¹‰äº†Mapé›†åˆä½œä¸ºæ³¨å†Œè¡¨å®¹å™¨ã€‚

```
public class SimpleBeanDefinitionRegistry implements BeanDefinitionRegistry {
â€‹
 Â  Â private Map<String, BeanDefinition> beanDefinitionMap = new HashMap<String, BeanDefinition>();

 Â  Â @Override
 Â  Â public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) {
 Â  Â  Â  Â beanDefinitionMap.put(beanName,beanDefinition);
 Â   }

 Â  Â @Override
 Â  Â public void removeBeanDefinition(String beanName) throws Exception {
 Â  Â  Â  Â beanDefinitionMap.remove(beanName);
 Â   }

 Â  Â @Override
 Â  Â public BeanDefinition getBeanDefinition(String beanName) throws Exception {
 Â  Â  Â  Â return beanDefinitionMap.get(beanName);
 Â   }

 Â  Â @Override
 Â  Â public boolean containsBeanDefinition(String beanName) {
 Â  Â  Â  Â return beanDefinitionMap.containsKey(beanName);
 Â   }

 Â  Â @Override
 Â  Â public int getBeanDefinitionCount() {
 Â  Â  Â  Â return beanDefinitionMap.size();
 Â   }

 Â  Â @Override
 Â  Â public String[] getBeanDefinitionNames() {
 Â  Â  Â  Â return beanDefinitionMap.keySet().toArray(new String[1]);
 Â   }
}
```

3.  åˆ›å»ºè§£æå™¨ç›¸å…³çš„ç±»

BeanDefinitionReaderæ¥å£

*   BeanDefinitionReaderç”¨æ¥è§£æé…ç½®æ–‡ä»¶å¹¶åœ¨æ³¨å†Œè¡¨ä¸­æ³¨å†Œbeançš„ä¿¡æ¯ã€‚å®šä¹‰äº†ä¸¤ä¸ªè§„èŒƒï¼š
    
*   è·å–æ³¨å†Œè¡¨çš„åŠŸèƒ½,è®©å¤–ç•Œå¯ä»¥é€šè¿‡è¯¥å¯¹è±¡è·å–æ³¨å†Œè¡¨å¯¹è±¡
    
*   åŠ è½½é…ç½®æ–‡ä»¶,å¹¶æ³¨å†Œbeanæ•°æ®
    

```
/**
 * @date 2022/10/28
 **/
public interface BeanDefinitionReader {

 Â  Â //è·å–æ³¨å†Œè¡¨å¯¹è±¡
 Â  Â BeanDefinitionRegistry getRegistry();

 Â  Â //åŠ è½½é…ç½®æ–‡ä»¶å¹¶åœ¨æ³¨å†Œè¡¨ä¸­è¿›è¡Œæ³¨å†Œ
 Â  Â void loadBeanDefinitions(String configLocation) throws Exception;
}
```

XmlBeanDefinitionReaderç±»

*   XmlBeanDefinitionReaderæ˜¯ä¸“é—¨ç”¨æ¥è§£æxmlé…ç½®æ–‡ä»¶çš„ã€‚è¯¥ç±»å®ç°BeanDefinitionReaderæ¥å£å¹¶å®ç°æ¥å£ä¸­çš„ä¸¤ä¸ªåŠŸèƒ½ã€‚

```
/**
 * è¯¥ç±»æ˜¯å¯¹XMLæ–‡ä»¶è¿›è¡Œè§£æçš„ç±»
 * @date 2022/10/28
 **/
public class XmlBeanDefinitionReader implements BeanDefinitionReader {

 Â  Â //å£°æ˜æ³¨å†Œè¡¨å¯¹è±¡(å°†é…ç½®æ–‡ä»¶ä¸æ³¨å†Œè¡¨è§£è€¦,é€šè¿‡Readeré™ä½è€¦åˆæ€§)
 Â  Â private BeanDefinitionRegistry registry;

 Â  Â public XmlBeanDefinitionReader() {
 Â  Â  Â  Â registry = new SimpleBeanDefinitionRegistry();
 Â   }

 Â  Â @Override
 Â  Â public BeanDefinitionRegistry getRegistry() {
 Â  Â  Â  Â return registry;
 Â   }

 Â  Â //åŠ è½½é…ç½®æ–‡ä»¶
 Â  Â @Override
 Â  Â public void loadBeanDefinitions(String configLocation) throws Exception {
 Â  Â  Â  Â //ä½¿ç”¨dom4jè§£æxml
 Â  Â  Â  Â SAXReader reader = new SAXReader();

 Â  Â  Â  Â //è·å–é…ç½®æ–‡ä»¶,ç±»è·¯å¾„ä¸‹
 Â  Â  Â  Â InputStream is = XmlBeanDefinitionReader.class.getClassLoader().getResourceAsStream(configLocation);

 Â  Â  Â  Â //è·å–documentæ–‡æ¡£å¯¹è±¡
 Â  Â  Â  Â Document document = reader.read(is);

 Â  Â  Â  Â Element rootElement = document.getRootElement();
 Â  Â  Â  Â //è§£æbeanæ ‡ç­¾
 Â  Â  Â  Â parseBean(rootElement);
 Â   }

 Â  Â private void parseBean(Element rootElement) {

 Â  Â  Â  Â //è·å–æ‰€æœ‰çš„beanæ ‡ç­¾
 Â  Â  Â  Â List<Element> elements = rootElement.elements();

 Â  Â  Â  Â //éå†è·å–æ¯ä¸ªbeanæ ‡ç­¾çš„å±æ€§å€¼å’Œå­æ ‡ç­¾property
 Â  Â  Â  Â for (Element element : elements) {

 Â  Â  Â  Â  Â  Â String id = element.attributeValue("id");
 Â  Â  Â  Â  Â  Â String className = element.attributeValue("class");

 Â  Â  Â  Â  Â  Â //å°è£…åˆ°beanDefinition
 Â  Â  Â  Â  Â  Â BeanDefinition beanDefinition = new BeanDefinition();
 Â  Â  Â  Â  Â  Â beanDefinition.setId(id);
 Â  Â  Â  Â  Â  Â beanDefinition.setClassName(className);

 Â  Â  Â  Â  Â  Â //è·å–property
 Â  Â  Â  Â  Â  Â List<Element> list = element.elements("property");

 Â  Â  Â  Â  Â  Â MutablePropertyValues mutablePropertyValues = new MutablePropertyValues();

 Â  Â  Â  Â  Â  Â //éå†,å°è£…propertyValue,å¹¶ä¿å­˜åˆ°mutablePropertyValues
 Â  Â  Â  Â  Â  Â for (Element element1 : list) {
 Â  Â  Â  Â  Â  Â  Â  Â String name = element1.attributeValue("name");
 Â  Â  Â  Â  Â  Â  Â  Â String ref = element1.attributeValue("ref");
 Â  Â  Â  Â  Â  Â  Â  Â String value = element1.attributeValue("value");
 Â  Â  Â  Â  Â  Â  Â  Â PropertyValue propertyValue = new PropertyValue(name,ref,value);
 Â  Â  Â  Â  Â  Â  Â  Â mutablePropertyValues.addPropertyValue(propertyValue);
 Â  Â  Â  Â  Â   }

 Â  Â  Â  Â  Â  Â //å°†mutablePropertyValueså°è£…åˆ°beanDefinition
 Â  Â  Â  Â  Â  Â beanDefinition.setPropertyValues(mutablePropertyValues);

 Â  Â  Â  Â  Â  Â System.out.println(beanDefinition);
 Â  Â  Â  Â  Â  Â //å°†beanDefinitionæ³¨å†Œåˆ°æ³¨å†Œè¡¨
 Â  Â  Â  Â  Â  Â registry.registerBeanDefinition(id,beanDefinition);
 Â  Â  Â   }
 Â   }
}
```

4.  åˆ›å»ºIOCå®¹å™¨ç›¸å…³çš„ç±»

**1) BeanFactoryæ¥å£**

åœ¨è¯¥æ¥å£ä¸­å®šä¹‰IOCå®¹å™¨çš„ç»Ÿä¸€è§„èŒƒå’Œè·å–beanå¯¹è±¡çš„æ–¹æ³•ã€‚

```
/**
 * IOCå®¹å™¨çˆ¶æ¥å£
 * @date 2022/10/28
 **/
public interface BeanFactory {

 Â  Â Object getBean(String name)throws Exception;

 Â  Â //æ³›å‹æ–¹æ³•,ä¼ å…¥å½“å‰ç±»æˆ–è€…å…¶å­ç±»
 Â  Â <T> T getBean(String name ,Class<? extends T> clazz)throws Exception;
}

```

**2) ApplicationContextæ¥å£**

è¯¥æ¥å£çš„æ‰€æœ‰çš„å­å®ç°ç±»å¯¹beanå¯¹è±¡çš„åˆ›å»ºéƒ½æ˜¯éå»¶æ—¶çš„ï¼Œæ‰€ä»¥åœ¨è¯¥æ¥å£ä¸­å®šä¹‰ `refresh()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦å®Œæˆä»¥ä¸‹ä¸¤ä¸ªåŠŸèƒ½ï¼š

*   åŠ è½½é…ç½®æ–‡ä»¶ã€‚
*   æ ¹æ®æ³¨å†Œè¡¨ä¸­çš„BeanDefinitionå¯¹è±¡å°è£…çš„æ•°æ®è¿›è¡Œbeanå¯¹è±¡çš„åˆ›å»ºã€‚

```
/**
 * å®šä¹‰éå»¶æ—¶åŠ è½½åŠŸèƒ½
 * @date 2022/10/28
 **/
public interface ApplicationContext extends BeanFactory {

 Â  Â //è¿›è¡Œé…ç½®æ–‡ä»¶åŠ è½½,å¹¶è¿›è¡Œå¯¹è±¡åˆ›å»º
 Â  Â void refresh();
}
```

**3) AbstractApplicationContextç±»**

*   ä½œä¸ºApplicationContextæ¥å£çš„å­ç±»ï¼Œæ‰€ä»¥è¯¥ç±»ä¹Ÿæ˜¯éå»¶æ—¶åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¯¥ç±»ä¸­å®šä¹‰ä¸€ä¸ªMapé›†åˆï¼Œä½œä¸ºbeanå¯¹è±¡å­˜å‚¨çš„å®¹å™¨ã€‚
*   å£°æ˜BeanDefinitionReaderç±»å‹çš„å˜é‡ï¼Œç”¨æ¥è¿›è¡Œxmlé…ç½®æ–‡ä»¶çš„è§£æï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ã€‚
*   BeanDefinitionReaderç±»å‹çš„å¯¹è±¡åˆ›å»ºäº¤ç”±å­ç±»å®ç°ï¼Œå› ä¸ºåªæœ‰å­ç±»æ˜ç¡®åˆ°åº•åˆ›å»ºBeanDefinitionReaderå“ªå„¿ä¸ªå­å®ç°ç±»å¯¹è±¡ã€‚

```
/**
 * ApplicationContextæ¥å£çš„å­å®ç°ç±»
 *      åˆ›å»ºå®¹å™¨å¯¹è±¡æ—¶,åŠ è½½é…ç½®æ–‡ä»¶,å¯¹beanè¿›è¡Œåˆå§‹åŒ–
 * @date 2022/10/28
 **/
public abstract class AbstractApplicationContext implements ApplicationContext {

    //å£°æ˜è§£æå™¨å˜é‡
    protected BeanDefinitionReader beanDefinitionReader;

    //å®šä¹‰å­˜å‚¨beanå¯¹è±¡çš„Mapé›†åˆ
    protected Map<String,Object> singletonObjects = new HashMap<>();

    //å£°æ˜é…ç½®æ–‡ä»¶ç±»è·¯å¾„çš„å˜é‡
    protected String configLocation;

    @Override
    public void refresh() {

        //åŠ è½½beanDefinitionå¯¹è±¡
        try {
            beanDefinitionReader.loadBeanDefinitions(configLocation);
            //åˆå§‹åŒ–bean
            finishBeanInitialization();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    //beanåˆå§‹åŒ–
    protected  void finishBeanInitialization() throws Exception {
        //è·å–å¯¹åº”çš„æ³¨å†Œè¡¨å¯¹è±¡
        BeanDefinitionRegistry registry = beanDefinitionReader.getRegistry();

        //è·å–beanDefinitionå¯¹è±¡
        String[] beanNames = registry.getBeanDefinitionNames();
        for (String beanName : beanNames) {
            //è¿›è¡Œbeançš„åˆå§‹åŒ–
            getBean(beanName);
        }
    };
}
```

**4) ClassPathXmlApplicationContextç±»**

è¯¥ç±»ä¸»è¦æ˜¯åŠ è½½ç±»è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œbeanå¯¹è±¡çš„åˆ›å»ºï¼Œä¸»è¦å®Œæˆä»¥ä¸‹åŠŸèƒ½ï¼š

*   åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œåˆ›å»ºBeanDefinitionReaderå¯¹è±¡ã€‚
*   åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œè°ƒç”¨refresh()æ–¹æ³•ï¼Œç”¨äºè¿›è¡Œé…ç½®æ–‡ä»¶åŠ è½½ã€åˆ›å»ºbeanå¯¹è±¡å¹¶å­˜å‚¨åˆ°å®¹å™¨ä¸­ã€‚
*   é‡å†™çˆ¶æ¥å£ä¸­çš„getBean()æ–¹æ³•ï¼Œå¹¶å®ç°ä¾èµ–æ³¨å…¥æ“ä½œã€‚

```
/**
 * IOCå®¹å™¨å…·ä½“çš„å­å®ç°ç±»,åŠ è½½XMLæ ¼å¼é…ç½®æ–‡ä»¶
 * @date 2022/10/28
 **/
public class ClassPathXmlApplicationContext extends AbstractApplicationContext{

    public ClassPathXmlApplicationContext(String configLocation) {
        this.configLocation = configLocation;
        //æ„å»ºè§£æå™¨å¯¹è±¡
        this.beanDefinitionReader = new XmlBeanDefinitionReader();

        this.refresh();
    }

    //è·Ÿæ®beançš„å¯¹è±¡åç§°è·å–beanå¯¹è±¡
    @Override
    public Object getBean(String name) throws Exception {
        //åˆ¤æ–­å¯¹è±¡å®¹å™¨ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šåç§°çš„beanå¯¹è±¡,å¦‚æœåŒ…å«å°±è¿”å›,å¦åˆ™è‡ªè¡Œåˆ›å»º
        Object obj = singletonObjects.get(name);
        if(obj != null){
            return obj;
        }

        //è‡ªè¡Œåˆ›å»º,è·å–beanDefinitionå¯¹è±¡
        BeanDefinitionRegistry registry = beanDefinitionReader.getRegistry();
        BeanDefinition beanDefinition = registry.getBeanDefinition(name);

        //é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        String className = beanDefinition.getClassName();
        Class<?> clazz = Class.forName(className);
        Object beanObj = clazz.newInstance();

        //CourseServiceä¸UserDaoå­˜ä¾èµ–,æ‰€ä»¥è¦å°†UserDaoä¸€åŒåˆå§‹åŒ–,è¿›è¡Œä¾èµ–æ³¨å…¥
        MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();
        for (PropertyValue propertyValue : propertyValues) {
            //è·å–nameå±æ€§å€¼
            String propertyName = propertyValue.getName();
            //è·å–Valueå±æ€§
            String value = propertyValue.getValue();
            //è·å–refå±æ€§
            String ref = propertyValue.getRef();

            //refä¸valueåªèƒ½å­˜åœ¨ä¸€ä¸ª
            if(ref != null && !"".equals(ref)){
                //è·å–ä¾èµ–çš„beanå¯¹è±¡,æ‹¼æ¥set set+Course
                Object bean = getBean(ref);
                String methodName = StringUtils.getSetterMethodFieldName(propertyName);

                //è·å–æ‰€æœ‰æ–¹æ³•å¯¹è±¡
                Method[] methods = clazz.getMethods();
                for (Method method : methods) {
                    if(methodName.equals(method.getName())){
                        //æ‰§è¡Œè¯¥setæ–¹æ³•
                        method.invoke(beanObj,bean);
                    }
                }
            }

            if(value != null && !"".equals(value)){
                String methodName = StringUtils.getSetterMethodFieldName(propertyName);
                //è·å–method
                Method method = clazz.getMethod(methodName, String.class);
                method.invoke(beanObj,value);
            }
        }

        //åœ¨è¿”å›beanObjä¹‹å‰ ,éœ€è¦å°†å¯¹è±¡å­˜å‚¨åˆ°Mapå®¹å™¨ä¸­
        this.singletonObjects.put(name,beanObj);


        return beanObj;
    }

    @Override
    public <T> T getBean(String name, Class<? extends T> clazz) throws Exception {
        Object bean = getBean(name);
        if(bean == null){
            return null;
        }

       return clazz.cast(bean);
    }
}
```

5.  è‡ªå®šä¹‰IOCå®¹å™¨æµ‹è¯•

ç¬¬ä¸€æ­¥: å°†æˆ‘ä»¬å†™å¥½çš„è‡ªå®šä¹‰IOCå®¹å™¨é¡¹ç›®,å®‰è£…åˆ°mavenä»“åº“ä¸­,ä½¿å…¶ä»–é¡¹ç›®å¯ä»¥å¼•å…¥å…¶ä¾èµ–

```
//ä¾èµ–ä¿¡æ¯
<dependencies>
    <dependency>
        <groupId>com.xfc</groupId>
        <artifactId>user_defined_springioc</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

ç¬¬äºŒæ­¥: å®Œæˆä»£ç ç¼–å†™

*   dao

```
public interface CourseDao {
    public void add();
}

public class CourseDaoImpl implements CourseDao {

    //valueæ³¨å…¥
    private String courseName;

    public String getCourseName() {
        return courseName;
    }

    public void setCourseName(String courseName) {
        this.courseName = courseName;
    }

    public CourseDaoImpl() {
        System.out.println("CourseDaoImplåˆ›å»ºäº†......");
    }

    @Override
    public void add() {
        System.out.println("CourseDaoImplçš„addæ–¹æ³•æ‰§è¡Œäº†......" + courseName);
    }
}
```

*   service

```
public interface CourseService {

    public void add();
}

public class CourseServiceImpl implements CourseService {

    public CourseServiceImpl() {
        System.out.println("CourseServiceImplåˆ›å»ºäº†......");
    }

    private CourseDao courseDao;

    public void setCourseDao(CourseDao courseDao) {
        this.courseDao = courseDao;
    }

    @Override
    public void add() {
        System.out.println("CourseServiceImplçš„addæ–¹æ³•æ‰§è¡Œäº†......");
        courseDao.add();
    }
}
```

*   applicationContext.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<beans>
    <bean id="courseService" class="com.xfc.test_springioc.service.impl.CourseServiceImpl">
        <property name="courseDao" ref="courseDao"></property>
    </bean>
    <bean id="courseDao" class="com.xfc.test_springioc.dao.impl.CourseDaoImpl">
        <property name="courseName" value="java"></property>
    </bean>
</beans>
```

*   Controller

```
public class CourseController{

 Â  Â public static void main(String[] args) {
 Â  Â  Â  Â //1.åˆ›å»ºSpringçš„å®¹å™¨å¯¹è±¡
 Â  Â  Â  Â ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");

 Â  Â  Â  Â //2.ä»å®¹å™¨å¯¹è±¡ä¸­è·å–CourseServiceå¯¹è±¡
 Â  Â  Â  Â CourseService courseService = context.getBean("courseService", CourseService.class);

 Â  Â  Â  Â //3.è°ƒç”¨UserServiceçš„addæ–¹æ³•
 Â  Â  Â  Â courseService.add();
 Â   }
}
```

6.  æ¡ˆä¾‹ä¸­ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼

*   `å·¥å‚æ¨¡å¼`ã€‚è¿™ä¸ªä½¿ç”¨å·¥å‚æ¨¡å¼ + é…ç½®æ–‡ä»¶çš„æ–¹å¼ã€‚
*   ` å•ä¾‹æ¨¡å¼`ã€‚Spring IOCç®¡ç†çš„beanå¯¹è±¡éƒ½æ˜¯å•ä¾‹çš„ï¼Œæ­¤å¤„çš„å•ä¾‹ä¸æ˜¯é€šè¿‡æ„é€ å™¨è¿›è¡Œå•ä¾‹çš„æ§åˆ¶çš„ï¼Œè€Œæ˜¯springæ¡†æ¶å¯¹æ¯ä¸€ä¸ªbeanåªåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚
*   `æ¨¡æ¿æ–¹æ³•æ¨¡å¼`ã€‚AbstractApplicationContextç±»ä¸­çš„finishBeanInitialization()æ–¹æ³•è°ƒç”¨äº†å­ç±»çš„getBean()æ–¹æ³•ï¼Œå› ä¸ºgetBean()çš„å®ç°å’Œç¯å¢ƒæ¯æ¯ç›¸å…³ã€‚
*   `è¿­ä»£å™¨æ¨¡å¼`ã€‚å¯¹äºMutablePropertyValuesç±»å®šä¹‰ä½¿ç”¨åˆ°äº†è¿­ä»£å™¨æ¨¡å¼ï¼Œå› ä¸ºæ­¤ç±»å­˜å‚¨å¹¶ç®¡ç†PropertyValueå¯¹è±¡ï¼Œä¹Ÿå±äºä¸€ä¸ªå®¹å™¨ï¼Œæ‰€ä»¥ç»™è¯¥å®¹å™¨æä¾›ä¸€ä¸ªéå†æ–¹å¼ã€‚

5\. ç»“è¯­
------

é€šè¿‡æœ¬æ–‡çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒSpringæ¡†æ¶çš„è®¾è®¡å……åˆ†åˆ©ç”¨äº†å¤šç§è®¾è®¡æ¨¡å¼ï¼Œå°¤å…¶æ˜¯å·¥å‚æ¨¡å¼ï¼Œä¸ä»…åŠ å¼ºäº†æ¡†æ¶çš„çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼Œä¹Ÿæå¤§åœ°æå‡äº†ä»£ç çš„å¯é‡ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚Springé€šè¿‡å…¶IOCå®¹å™¨ï¼Œåˆ©ç”¨å·¥å‚æ¨¡å¼ç­‰è®¾è®¡æ¨¡å¼è‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–å…³ç³»ï¼Œæå¤§åœ°è§£æ”¾äº†å¼€å‘è€…ä»ç¹ççš„é…ç½®ç®¡ç†ä»»åŠ¡ä¸­ã€‚æŒæ¡è¿™äº›è®¾è®¡æ¨¡å¼å¹¶ç†è§£å®ƒä»¬åœ¨Springä¸­çš„åº”ç”¨ï¼Œå°†å¸®åŠ©å¼€å‘è€…æ›´åŠ é«˜æ•ˆåœ°ä½¿ç”¨Springæ¡†æ¶ï¼Œä»è€Œå¼€å‘å‡ºå“åº”å¿«é€Ÿã€æ˜“äºç»´æŠ¤çš„åº”ç”¨ã€‚

![Image 13: ç»“è¯­3.jpg](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d29fa6da61484904aabccf80cb0f1f07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&x-expires=1729397151&x-signature=BzB2%2BuzU%2FN%2B%2BqZI2VpMoGpxWO18%3D)
