# 深入理解Linux的TCP三次握手
- URL: https://mp.weixin.qq.com/s/LIeb5DwMS6RS2YhEw47GDA
- Added At: 2024-10-14 15:34:03
- [Link To Text](2024-10-14-深入理解linux的tcp三次握手_raw.md)

## TL;DR
文章详细介绍了TCP协议的可靠性和面向连接特性，通过三次握手建立连接，并探讨了synflood攻击及其防御措施syncookie。还分析了listen backlog和TFO技术优化连接速度，以及相关内核参数的作用。

## Summary
1. **TCP协议概述**：TCP协议是一个面向连接和可靠的传输层协议，相对的是UDP协议，不可靠且非面向连接。TCP协议的设计需要在一个面向无连接、不可靠的IP上实现一个面向连接、可靠的传输层协议。

2. **可靠和面向连接**：
   - **面向连接**：在一个连接中传输的数据是有关系状态的，需要维护传输数据的关系，比如数据流的顺序。
   - **可靠**：主要是指数据在传输过程中不会被损坏或者丢失，保证数据可以正确到达。

3. **解决面向连接问题**：
   - 使用建立连接，传输数据，断开连接的三步创建一个长期的数据传输机制。
   - 维护seq序列号字段维护数据的顺序关系保证按序交付，和解决数据包重复的问题。
   - 使用部分特殊的状态标记的包来专门创建、断开和维护一个连接：syn，ack，fin，rst。

4. **解决可靠性问题**：
   - 引入数据传输的确认机制，即数据发送之后等待对方确认。
   - 引入数据确认机制（停止等待协议）之后，引发了带宽利用律不高的问题，解决方案是引入窗口确认机制和滑动窗口。
   - 引入滑动窗口之后，如何在不同延时的网络上选择不同窗口大小？解决方法是引入窗口变量，和窗口监测通告。

5. **三次握手的目的**：
   - 确认对端在线，即我请求你的时候你能立即给出响应。
   - 如果传输的数据多的话，要保证包的顺序，所以要确认这个链接中传输数据的起始序列号。

6. **为什么是三次握手**：
   - 两次握手无法确认对端是否了解了你的起始序列号。
   - 四次握手太啰嗦，三次是最合理的。

7. **synflood攻击**：
   - 针对一个没有syncookie功能的服务器，任意客户端都可以通过构造一个不完整三次握手过程，只发syn，不回第三次握手的ack来占满服务端的半连接池，导致服务端无法再跟任何客户端进行tcp新建连接。

8. **syncookie如何防止synflood**：
   - syncookie功能的设计初衷是为了防止synflood。
   - syncookie会将需要记录到包里的信息做一下hash运算，运算出来的新数据就叫cookie。

9. **listen backlog**：
   - listen系统调用的backlog参数限制了tcp的半连接队列。
   - 当listen backlog队列被耗尽之后，新建连接是不能完成三次握手的。

10. **TFO - TCP Fast Open**：
    - TFO的主要目的就是简化三次握手的过程，让TCP在大延时网络上打开速度更快。
    - TFO修改了正常tcp三次握手的过程，在第一个syn包经过网络到达服务器期间，有可能部分路由器或防火墙规则会把这种特殊的syn当成异常流量而禁止掉。

11. **其他内核参数**：
    - /proc/sys/net/ipv4/tcp_syn_retries：设置第一次握手syn在没有收到synack的情况下，最大重试次数，默认为6次。
    - /proc/sys/net/ipv4/tcp_synack_retries：设置第二次握手synack发出之后，在没有收到最后一个ack的情况下，最大重试次数，默认值为5。
