Title: ç½‘ä¸Šçš„ AQS æ–‡ç« è®©æˆ‘å¾ˆå¤±æœ›ä¸€ã€AQS å¾ˆå¤šäººéƒ½æ²¡æœ‰è®²æ˜ç™½ ğŸ¤” ç¿»çœ‹äº†ç½‘ä¸Šçš„ AQSï¼ˆAbstractQueuedS

URL Source: https://juejin.cn/post/7428927105612185627

Markdown Content:
ä¸€ã€AQS å¾ˆå¤šäººéƒ½æ²¡æœ‰è®²æ˜ç™½
---------------

ğŸ¤” ç¿»çœ‹äº†ç½‘ä¸Šçš„ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ–‡ç« ï¼Œè´¨é‡å‚å·®ä¸é½ï¼Œå¤§å¤šæ•°éƒ½æ˜¯åœ¨å…³é”®å¤„è·³è¿‡ã€å«ç³Šå…¶è¯ï¼Œç¾å…¶åæ›° â€œä¼ æ’­çŸ¥è¯†â€ ã€‚

å¤§å¤šæ•°éƒ½æ˜¯è¿›è¡Œå¤§æ®µçš„æºç ç²˜è´´å’Œæ³¨é‡Šï¼Œæˆ–è€…**å«æºç ç¿»è¯‘ï¼** æœ‰å¿…è¦å†™ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œ**å°† AQS çš„ä¸€äº›åŸºç¡€åŸç†ææ¸…æ¥šï¼Œææ­£ç¡®ã€‚**

![Image 1](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/490b13a12bd14c3099b944896acc1b10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=9fuzdJMD8On2h3cyK4yyKz0F4AA%3D)

æœ¬æ–‡å°½é‡ç”¨å›¾æ–‡çš„å½¢å¼é˜é‡Šè¿‡ç¨‹ï¼ŒåŒæ—¶ç»“åˆæ–­ç‚¹è°ƒè¯•ï¼Œå°† AQS åœ¨å¤šçº¿ç¨‹è¿è¡Œä¸‹çš„çŠ¶æ€ï¼Œå°½å¯èƒ½å‘ˆç°å‡ºæ¥ï¼

äºŒã€å‡†å¤‡å’Œå‰æ
-------

æ³¨æ„ï¼šæœ¬æ–‡æ‰€æŒ‡çš„ AQS å‡ä¸º Java å¹¶å‘åŒ…ä¸­çš„ AbstractQueuedSynchronizer ç±»ã€‚

### 2.1 ç¯å¢ƒè¯´æ˜

*   InterlliJ IDEA 2024.2 (å…è´¹ä½¿ç”¨ 30 d)
*   JDK1.8

### 2.2 çº¿ç¨‹çŸ¥è¯†å‚¨å¤‡

**çŸ¥è¯†ç‚¹ä¸€ã€ LockSupportï¼š**

æ·±å…¥ AQS çš„æºç ï¼Œéœ€è¦æå‰ç†è§£ LockSupport æ¥å£ï¼š

`LockSupport.park()` : å½“å‰çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å®ƒè¢« `unpark` å”¤é†’æˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­

`LockSupport.unpark(Thread thread)`: å”¤é†’å…¶ä»–çº¿ç¨‹ï¼Œå‚æ•°æ˜¯ Thread

LockSupport åŠŸèƒ½ç®€å•å¼ºå¤§ï¼Œå¯¹çº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’éå¸¸æ–¹ä¾¿ã€‚

**çŸ¥è¯†ç‚¹äºŒã€ ReentrantLockï¼š**

*   ReentrantLock ä¾èµ– Sync
*   Sync ç»§æ‰¿ AQS
*   FaireSync æ˜¯å…¬å¹³é”; NonFaireSync æ˜¯éå…¬å¹³é”, ä¹Ÿæ˜¯ RentrantLock é»˜è®¤çš„é”ç±»å‹

![Image 2](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2da42647b2b45c689d8b545753ce174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=FO8wEXgd8ytCJSRmAKZlDfo%2FHpQ%3D)

**æ¨¡æ¿ä»£ç å¦‚ä¸‹**ï¼š

```
// è·å–é”
lock.lock();
try {
  // ä»£ç å—
} finally {
    // é‡Šæ”¾é”
    lock.unlock();
}
```

**çŸ¥è¯†ç‚¹ä¸‰ã€CAS**

*   å¸¸ç”¨çš„åŸå­æ“ä½œï¼Œ**ç”¨äºåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å®ç°æ— é”çš„çº¿ç¨‹å®‰å…¨æ“ä½œ**
*   CAS æ“ä½œåŒ…å«ä¸‰ä¸ªä¸»è¦çš„å‚æ•°ï¼š**å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼ï¼ˆBï¼‰**
*   **åªæœ‰å½“å†…å­˜ä½ç½®çš„å€¼ä¸é¢„æœŸåŸå€¼ç›¸åŒ¹é…æ—¶ï¼ŒCAS æ“ä½œæ‰ä¼šå°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼** **ï¼Œå¹¶ä¸”è¿™ç§æ£€æŸ¥å’Œæ›¿æ¢æ˜¯ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„åŸå­æ“ä½œå®Œæˆçš„ã€‚**

* * *

**çŸ¥è¯†ç‚¹å››ï¼šçº¿ç¨‹æ¨¡å¼**

| **æ¨¡å¼** | **å«ä¹‰** |
| --- | --- |
| SHARED | çº¿ç¨‹ä»¥å…±äº«çš„æ¨¡å¼ç­‰å¾…é” |
| EXCLUSIVE | çº¿ç¨‹æ­£åœ¨ä»¥ç‹¬å çš„æ–¹å¼ç­‰å¾…é” |

### 2.3 ä»£ç å‡†å¤‡

**éœ€è¦æ–­ç‚¹è°ƒè¯•ï¼Œæœ¬æ–‡å‡†å¤‡äº†ä¸€æ®µä»£ç ï¼Œå¯ä»¥æŒ‰ç…§æ–‡ç« æ­¥éª¤é€ä¸€è°ƒè¯•ã€‚**

ä»£ç å†…å®¹ï¼šä¸‰ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ä¸º ABCï¼Œè¿›è¡Œé”èµ„æºçš„æŠ¢å¤ºã€‚æœ¬æ–‡ä½¿ç”¨ ReentrantLock ä¸­çš„éå…¬å¹³é”å®ç°ã€‚

![Image 3](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a7605c59d614aaf98d3a8ed0493d58b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=qKv2lrXpwLveJCj8uZWP7%2BZy4w4%3D)

**ä»£ç å¦‚ä¸‹ï¼š**

*   ABC ä¸‰ä¸ªçº¿ç¨‹ï¼Œå…±åŒäº‰å¤ºä¸€æŠŠé”
*   è·å¾—é”åæ‰§è¡Œ count++
*   å®Œæˆåé‡Šæ”¾é”

**ä¸ºäº†æœ‰æ›´å¥½çš„é˜…è¯»ä½“éªŒï¼Œå»ºè®®å…ˆææ˜ç™½ä¸‹é¢ä»£ç ** **â˜ºï¸** **ã€‚**

```
import java.util.concurrent.locks.ReentrantLock;
public class LockExample {
    // ABC ä¸‰ä¸ªçº¿ç¨‹æŠ¢å¤ºä¸€æŠŠé”ã€‚æ˜¾ç¤ºæŒ‡æ˜ä½¿ç”¨éå…¬å¹³é”
    private static final ReentrantLock lock = new ReentrantLock(false);
    // è·å–é”åå¯¹ count è¿›è¡Œ++ æ“ä½œ
    private static volatile int count = 0;
    public static void main(String[] args) throws InterruptedException {
        // çº¿ç¨‹ A 
        Thread a = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                // è·å–é”
                lock.lock();
                try {
                    count++;
                    System.out.println(Thread.currentThread().getName() + " incremented count to " + count);
                } finally {
                    // é‡Šæ”¾é”
                    lock.unlock();
                }
            }
        }, "A");
        // çº¿ç¨‹ B 
        Thread b = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                // æŠ¢å é”
                lock.lock();
                try {
                    count++;
                    System.out.println(Thread.currentThread().getName() + " incremented count to " + count);
                } finally {
                    lock.unlock();
                }
            }
        }, "B");
        // çº¿ç¨‹ B 
        Thread c = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                // æŠ¢å é”
                lock.lock();
                try {
                    count++;
                    System.out.println(Thread.currentThread().getName() + " incremented count to " + count);
                } finally {
                    lock.unlock();
                }
            }
        }, "C");

        a.start();
        
        // å…ˆè®© B çº¿ç¨‹æ™šä¸€ç‚¹æ‰§è¡Œ
        System.out.println("---------");
        Thread.sleep(20000);
        b.start();

        // C çº¿ç¨‹æœ€åæ‰§è¡Œ
        System.out.println("---------");
        Thread.sleep(20000);
        c.start();

        a.join();
        b.join();
        c.join();
    }
}
```

å¯ä»¥æ‹·è´åˆ°è‡ªå·±çš„ IDEA ä¸­è¿›è¡Œè°ƒè¯•

### 2.4 å¦‚ä½•è¿›è¡Œå¤šçº¿ç¨‹çš„ debug

å¾ˆå¤šåŒå­¦æ²¡æœ‰å¤šçº¿ç¨‹çš„è°ƒè¯•ç»éªŒï¼Œå½“ç„¶å¤šçº¿ç¨‹çš„è°ƒè¯•æ˜¯æœ‰éš¾åº¦ã€‚ å¸Œæœ›é€šè¿‡æœ¬æ–‡ï¼Œèƒ½å¤Ÿæœ‰ä¸€äº›å¸®åŠ©ã€‚

![Image 4](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d697971632db4f609557226dfefafa63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=4njX%2BCloBrcuCp0WnoO8J%2FmMENY%3D)

æœ¬æ–‡ä¸­çš„å¤šçº¿ç¨‹è°ƒè¯•éœ€è¦æŒæ¡ä¸¤ä¸ªå…³é”®è¦çš„ï¼š

**è¦ç‚¹ä¸€ï¼šæŸ¥çœ‹è¿è¡Œæ ˆå¸§ && åˆ‡æ¢çº¿ç¨‹**

åœ¨ Threads & Variables è¿™ä¸ªçª—å£ï¼Œä¿éšœçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ã€‚

![Image 5](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfb3b67473594385bfd4a13ff8b51a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=OmQ6r4qlLIXPORLX%2F0CjGCrEf7M%3D)

**è¦ç‚¹äºŒï¼šæ–­ç‚¹æš‚åœæ–¹å¼ï¼Œé€‰æ‹© Thread**

![Image 6](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d476e743d0bd45cebb5b249bb12513ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=5I4Ug9E4kw1Lx0FVqtQSI2zVgRo%3D)

è¿™ä¸ªæ˜¯æœ€ä¸ºé‡è¦çš„ã€‚

å»ºè®®æœ¬æ¬¡è°ƒè¯•ï¼šé€‰æ‹© **Make Defaultï¼Œ** **ç‚¹å‡»å›¾ä¸­ Make Defaultï¼Œåç»­æ‰€æœ‰æ–­ç‚¹éƒ½æ˜¯ Thread**ï¼Œ**å¦‚æœä¸é€‰æ‹© Threadï¼Œåˆ™æ— æ³•è¿›è¡Œæ–­ç‚¹è¿½è¸ªï¼**

æ¥ä¸‹æ¥é€šè¿‡æ–­ç‚¹è¿½è¸ªçš„ï¼Œæ¼”ç¤º AQS å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹å’ŒåŸç†ã€‚

å°†æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªå¤§é˜¶æ®µï¼šæŠ¢é”è¿‡ç¨‹å’Œé‡Šæ”¾é”è¿‡ç¨‹

*   ABC ä¸‰ä¸ªçº¿ç¨‹æŠ¢é”è¿‡ç¨‹ï¼Œåˆ†åˆ«æ˜¯ A å…ˆæŠ¢åˆ°é”ï¼Œç„¶å Bã€ C å†è¿›å…¥æŠ¢é”
*   A è·å¾—é”æ‰§è¡Œä»£ç åï¼Œå†é‡Šæ”¾é”, ç„¶åå°† B çº¿ç¨‹å”¤é†’ï¼› æœ€åå†å”¤é†’ C

ä¸‰ã€æŠ¢å é”è¿‡ç¨‹æ¼”ç¤º
---------

### 3.1 çº¿ç¨‹ A è·å–é”æ¼”ç¤º

![Image 7](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c2093de0ec4b609b37f510d77616ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=p5xIpgK7iam68a%2B0UPWLiYbGa2w%3D)

**åœºæ™¯ä¸€ï¼š æ¨¡æ‹Ÿå…ˆè®© A çº¿ç¨‹è·å–åˆ°é”**

æ³¨æ„åœ¨ Bã€C å¼€å§‹çš„ä½ç½®è®¾ç½®æ–­ç‚¹ï¼Œè¿™æ ·èƒ½å¤Ÿæ§åˆ¶ Bã€C çº¿ç¨‹çš„å¯åŠ¨æ—¶é—´ã€‚

![Image 8](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54f144aac4f74f109a3e3ee8cd04aaaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=hK16stg6xODcg8LGE2pnpzX%2BwIQ%3D) ![Image 9](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca86bd60160b455ca659078862f02d65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=3YXI7bB9b8S5L9R8pF9nVfJDCZE%3D)

å…ˆè®©æ–­ç‚¹æ‰§è¡Œåˆ°çº¿ç¨‹ Aï¼Œå¹¶åœç•™åœ¨çº¿ç¨‹ lock.lock() ä½ç½®ã€‚æ¥ä¸‹æ¥è¿›å…¥æ­¤æ–¹æ³•

![Image 10](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e38bbaa298434547853e764ac1f71aad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=FBoUEdpwkk7ZFvho9i7AzWhCzSw%3D)

æ³¨æ„ï¼šåªæœ‰åˆ‡æ¢åˆ°çº¿ç¨‹ A ï¼Œ æ‰èƒ½è¿›å…¥åˆ°çº¿ç¨‹ A çš„ lock çš„æºç ã€‚

ç‚¹å‡»è¿›å…¥æºç ï¼Œæ³¨æ„æ–­ç‚¹ä½ç½®ï¼Œ å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š

ä¸€äº›éå…³é”®çš„ä»£ç ç†è§£ä¼šç›´æ¥è·³è¿‡ï¼æ¯”å¦‚ sync.lock();

![Image 11](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59773d3e6a24ac89490aa43a591cd8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=loRHlgqB0NY26VIBeEJX4tKW2yc%3D)

å…³é”®ä»£ç å¦‚ä¸‹ï¼š

```
final void lock() {
    // CAS æ–¹å¼çš„è®¾ç½® state
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```

**é€šè¿‡ CAS å°† state è®¾ç½®ä¸º 1ï¼Œè®¾ç½®æˆåŠŸè¿™ä¸ªçº¿ç¨‹åˆ™è·å¾—é”æˆåŠŸã€‚**

æ·±å…¥çœ‹ä¸€ä¸‹ compareAndSetState ä»£ç ï¼Œ æ˜¯é€šè¿‡ unsafe çš„ compareAndSwapInt å®ç°çš„ã€‚

unsafe ç±»æ˜¯ä¸€ä¸ªåŠŸèƒ½è¾ƒä¸ºåº•å±‚ã€‚ä½†å¹¶ä¸å¤æ‚ï¼Œä½¿ç”¨ä¸Šå¯ä»¥æ¨¡ä»¿ï¼

```
protected final boolean compareAndSetState(int expect, int update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

stateOffset æ˜¯å¯¹è±¡ state å­—æ®µçš„åç§»å€¼ã€‚

```
stateOffset = unsafe.objectFieldOffset
                (AbstractQueuedSynchronizer.class.getDeclaredField("state"));
```

æ€»ç»“ä¸€ä¸‹ï¼š ä½¿ç”¨ `unsafe.compareAndSwapInt(this, stateOffset, expect, update) `å¯¹ state å­—æ®µè¿›è¡Œå€¼çš„æ›´æ–°ï¼Œå¦‚æœæˆåŠŸåˆ™è·å–é”æˆåŠŸï¼Œå¦åˆ™è¿›å…¥å…¶ä»–åˆ†æ”¯ã€‚

BC çº¿ç¨‹è¿˜æœªå¼€å§‹ï¼Œåªæœ‰ A çº¿ç¨‹å¤„äº RUNNING çŠ¶æ€ï¼Œå³ 1 ä¸ªçº¿ç¨‹ï¼Œå› æ­¤ state å¯ä»¥ç»™æ›´æ–°æˆ 1ã€‚

é€šè¿‡æ–­ç‚¹è¿è¡Œï¼ŒcompareAndSwapInt è¿”å› trueï¼Œ æ¥ä¸‹æ¥å†è°ƒç”¨ setExclusiveOwnerThread(), å®Œæˆçº¿ç¨‹ A ç‹¬å è®¿é—®ã€‚

![Image 12](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa5b5d1227f4a2ea13b99fbe9a5ae35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=fU8DTC1XxfhDnC%2BqKZtofyB1Ugo%3D)

**è®¾ç½®çº¿ç¨‹ç‹¬å **

![Image 13](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/128da2c785fc4e80a463155f3df5cc8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=Zu1oPFl50ALBMIV0Zgip3PqAcLE%3D)

è¿è¡Œåˆ°ç°åœ¨ï¼ŒAQS ä¸­çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

A è·å¾—ç‹¬å é”ï¼ŒBC æœªå¼€å§‹ï¼š

![Image 14](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7f5c71a6bc747b19ed7064df233ed1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=SxQgBVvg%2BlMmD9IGMdspH%2F6gmTQ%3D)

å› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹Aï¼Œæ‰€ä»¥æ²¡æœ‰äº‰æŠ¢ï¼Œä¸éœ€è¦åˆ›å»ºé˜Ÿåˆ—ã€‚

æ¥ä¸‹æ¥æš‚åœçº¿ç¨‹ A çš„è°ƒè¯•ï¼Œæ¨¡æ‹Ÿçº¿ç¨‹B æŠ¢é”è¿‡ç¨‹ã€‚

### 3.2 çº¿ç¨‹ B æŠ¢å é”æ¼”ç¤º

æ‰§è¡Œè¿‡ç¨‹ï¼š

å…ˆåˆ‡æ¢åˆ° main çº¿ç¨‹ï¼Œå¯åŠ¨çº¿ç¨‹ Bï¼› å½“çº¿ç¨‹ B å¯åŠ¨åï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹ Bï¼Œ æ–­ç‚¹è°ƒè¯•æ‰§è¡Œçº¿ç¨‹ B çš„æŠ¢å è¿‡ç¨‹

![Image 15](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c85584038127450a8910b967a4b32c9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=IiE0L5joYe%2BCtot8kPOKT8cCTyQ%3D)

compareAndSetState(0, 1) è¿”å›ä¸º falseï¼Œæ‰§è¡Œ `acquire(1)`ä»£ç 

**æ­¥éª¤ä¸€ï¼šåˆ‡æ¢çº¿ç¨‹ main çº¿ç¨‹ï¼Œè®©çº¿ç¨‹ B è¿è¡Œã€‚**

![Image 16](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3c4910d24eb434bb0cc98f0234cb49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=Kv7RlD0Ciq1c1a8gWqXzSJQN3Gk%3D)

* * *

**æ­¥éª¤äºŒï¼šå½“çº¿ç¨‹ B è¿è¡ŒæˆåŠŸåï¼Œåˆ‡æ¢çº¿ç¨‹ Bï¼Œè¿›è¡Œæ–­ç‚¹è¿½è¸ªã€‚**

![Image 17](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71a7c5b3aafe462cae554597fe7b85ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=dXqgAN%2BCXr%2BQqgOZfIgBREF0aBM%3D)

çº¿ç¨‹ B è¿›å…¥äº† `acqurie(1) `åˆ†æ”¯

![Image 18](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0bc6fa553f34a64b12de5ca5bf289fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=Aylk%2F3920KduhtI60OV9jehhGKY%3D)

**åˆ†æ acquire ä»£ç é€»è¾‘ï¼š**

![Image 19](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a0ad506290b401486b47d7dcd7b7298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=j7dDF1GuO3pV%2B5dUfrOYMrL%2F6io%3D)

**æµç¨‹ï¼štryAcquire å°è¯•å†ä¸€æ¬¡è·å–é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¿›å…¥é˜Ÿåˆ—**

è¿›å…¥ tryAcquire æºç è¿›è¡ŒæŸ¥çœ‹ï¼š

```
final boolean nonfairTryAcquire(int acquires) {
    // è·å–å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) {
        // å½“ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹åœ¨ä½¿ç”¨é”ï¼Œå°è¯• CAS æŠ¢é”
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    // æ˜¯å¦å½“å‰çº¿ç¨‹ï¼Œå®ç°çº¿ç¨‹çš„é‡å…¥  
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

å¦‚æœ state == 0ï¼Œè¡¨ç¤ºè¿˜æ²¡æœ‰ç‹¬å çš„çº¿ç¨‹ã€‚äºæ˜¯å°è¯•å°†å½“å‰çº¿ç¨‹è®¾ç½®æˆç‹¬å ï¼Œè¿™æ®µä»£ç ä¸åˆšåˆšåˆ†æçš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼ï¼ˆ**åšä¸€æ¬¡å°è¯•**ï¼‰

```
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```

**æœ‰ä¸¤ä¸ªç‚¹å¯ä»¥æå‡ºæ¥å…³æ³¨ä¸€ä¸‹ï¼š**

*   **èƒ½å¤Ÿè®¾ç½® state å€¼æˆåŠŸçš„çº¿ç¨‹å³æŠ¢å é”æˆåŠŸï¼Œåç»­ä¸ç”¨è¿›å…¥é˜Ÿåˆ—ç­‰å¾…**
*   å¦‚æœè·å¾—é”çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå³ state = 0ï¼› äºæ˜¯åŒæ—¶ï¼Œæ–°æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°†å°è¯•è·å¾—é”ï¼Œè€Œä¸æ˜¯å°†å…¶åŠ å…¥åˆ°é˜Ÿå°¾ã€‚è¿™ä¸€ç‚¹ä½“ç°äº†ä¸å…¬å¹³é”çš„ç‰¹æ€§ï¼ä¸æ˜¯æŒ‰ç…§FIFO

**ç‰¹åˆ«è¯´æ˜ï¼šå¦‚æœ state = 0 å¹¶ä¸è¡¨ç¤ºé˜Ÿåˆ—ä¸­æ²¡æœ‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚**

å¦‚æœå½“å‰çº¿ç¨‹ä¸è·å¾—ç‹¬å é”çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå…è®¸ state ä¿®æ”¹ã€‚

```
else if (current == getExclusiveOwnerThread()) {
    int nextc = c + acquires;
    if (nextc < 0) // overflow
        throw new Error("Maximum lock count exceeded");
    setState(nextc);
    return true;
}
```

å› ä¸ºæ˜¯ç›¸åŒçš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™æ®µä»£ç ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

æ³¨æ„ï¼šè¿™ä¹Ÿæ˜¯ ReentrantLock èƒ½å¤Ÿå®ç°é‡å…¥çš„å…³é”®ä»£ç ã€‚ å¦‚ä¸‹é¢ï¼Œè¿›è¡Œä¸¤æ¬¡ lockã€‚ é‚£ä¹ˆ state ä¼šå˜æˆ 2ã€‚

```
public void performAction() {
    lock.lock(); // ç¬¬ä¸€æ¬¡è·å–é”
    try {
        System.out.println("First lock acquired.");
        performAnotherAction(); // è°ƒç”¨å¦ä¸€ä¸ªéœ€è¦é”çš„æ–¹æ³•
    } finally {
        lock.unlock(); // é‡Šæ”¾é”
        System.out.println("First lock released.");
    }
}

public void performAnotherAction() {
    lock.lock(); // ç¬¬äºŒæ¬¡è·å–åŒä¸€ä¸ªé”
    try {
        System.out.println("Second lock acquired on the same thread.");
        // æ‰§è¡Œä¸€äº›éœ€è¦é”çš„æ“ä½œ
    } finally {
        lock.unlock(); // é‡Šæ”¾é”
        System.out.println("Second lock released.");
    }
}
```

![Image 20](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e056c42af00c4d00aa8f2f7340b47f5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=CiRAlc1QA38e7OfJ8QQtrrCCgMs%3D)

å½“çº¿ç¨‹ä¸èƒ½è·å–åˆ°é”çš„æ—¶å€™ï¼Œåˆ™è¿›å…¥ `addWaiter` ç¯èŠ‚ï¼š

```
if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
```

*   å…ˆè°ƒç”¨ addWaiter()
*   å†è°ƒç”¨ acquireQueued

#### 3.2.1 æ·»åŠ ç­‰å¾…èŠ‚ç‚¹

addWaiter() å’Œ acquireQueued() æ˜¯å®ç°çº¿ç¨‹ç­‰å¾…çš„å…³é”®

ç°åœ¨ç»§ç»­åˆ†æçº¿ç¨‹ B çš„æ‰§è¡Œè¿‡ç¨‹:

![Image 21](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444783876497452989fc6c4bdab4648f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=5TPDbJt%2Beyoo9maS5jBp6fKpa%2Bk%3D)

é€šè¿‡ä»£ç åˆ†æï¼Œ pred ä¸º nullï¼Œçº¿ç¨‹ B è¿›å…¥ `enq(node)`

æ³¨æ„ï¼š**ç°åœ¨çš„ Node ä¸ºçº¿ç¨‹ B**

![Image 22](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da0d6082abc14c7d88899706941269f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=UL01m9peVj5qb30lsnVEL4iAZKM%3D)

#### 3.2.2 enq() åˆ›å»ºé˜Ÿåˆ—

**è¿›å…¥ enq æ–¹æ³•çš„çº¿ç¨‹ï¼Œä¾ç„¶å­˜åœ¨å¤šä¸ªçº¿ç¨‹ç«äº‰çš„å…³ç³»ã€‚**

```
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
```

é€šè¿‡ `for(;;)` ä¿è¯æ‰€æœ‰è¿›æ¥çš„çº¿ç¨‹æœ€ç»ˆéƒ½èƒ½å¤Ÿè¢«åˆç†çš„æ·»åŠ åˆ°ç›¸åº”çš„èŠ‚ç‚¹ä¸Šã€‚

åˆ†æçº¿ç¨‹ B åœ¨è¿™æ®µä»£ç ä¸­çš„è¿‡ç¨‹ï¼š

*   çº¿ç¨‹ B ç¬¬ä¸€æ¬¡è¿›å…¥ ï¼Œ`t == null `ä¸º tureï¼Œ**å°†åˆ›å»ºäº†ä¸€ä¸ªæ²¡æœ‰ä»»ä½•çº¿ç¨‹ç»‘å®šçš„èŠ‚ç‚¹ Node ï¼ˆæš‚ä¸”ç§°ä¸ºç©ºä¿¡æ¯èŠ‚ç‚¹ï¼‰**
*   ç¬¬äºŒæ¬¡ï¼Œè®¾ç½®çº¿ç¨‹B èŠ‚ç‚¹ä¸ºå°¾éƒ¨èŠ‚ç‚¹ï¼Œå¹¶å°†å¤´èŠ‚ç‚¹çš„ next è®¾ç½®ä¸º çº¿ç¨‹ B èŠ‚ç‚¹ï¼Œ

ä¸Šé¢æ˜¯ç†æƒ³æƒ…å†µï¼Œè¿›å…¥ enq ä¾ç„¶æ˜¯å­˜åœ¨å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ CAS ä¿è¯çº¿ç¨‹çš„è¿è¡Œå®‰å…¨ã€‚

**ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼šenq()**

![Image 23](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32508a7089f649b4b0ee8a325187e339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=z2l9ldpVteYOLHF1wnvIBd97xKY%3D)

ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œå®Œæˆå¤´éƒ¨èŠ‚ç‚¹åœ°åˆ›å»ºã€‚å½“å‰ AQS çš„çŠ¶å†µï¼š

![Image 24](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2c573beb98c4adb9962ddf934258985~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=qX%2B92oKXpMsaz%2ByXJl9HqyfvnZ0%3D)

å®Œæˆåï¼Œå°† headã€tail åœ°å€å¼•ç”¨çš„æ–¹å¼æŒ‡å‘åˆšåˆš New Node() çš„èŠ‚ç‚¹ã€‚**headã€tail éƒ½æ˜¯åœ°å€å¼•ç”¨**

**æ³¨æ„ï¼šè¿™ä¸ªå¤´èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•çº¿ç¨‹ä¿¡æ¯ï¼ˆè¿™ä¸€ç‚¹åœ¨å…¶ä»– blog ä¸­è¯´æ³•é”™è¯¯çš„ï¼Œè¦è­¦æƒ•ï¼ï¼‰**

ç”±äºä½¿ç”¨çš„æ˜¯`for(;;)` é€»è¾‘ï¼› åœ¨è¿›å…¥ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œçº¿ç¨‹ B è¿™ä¸ªèŠ‚ç‚¹å°†ä¼šæ’åˆ°é˜Ÿå°¾ã€‚

![Image 25](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f359ba291034451abcdf312160be9ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=XUJRqDJ7dsAODnSVXjWeB%2BxMAcg%3D)

hashCode=699 ï¼šçº¿ç¨‹ B èŠ‚ç‚¹

hashCode=702 ï¼šç©ºä¿¡æ¯å¤´èŠ‚ç‚¹

åœ¨å¾ªç¯å®Œæˆç¬¬äºŒæ¬¡åï¼Œå®Œæˆå¯¹çº¿ç¨‹ B èŠ‚ç‚¹çš„æ’å…¥ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

![Image 26](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71792b464dbb479495aea827400315bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=uOrgkYw8%2FvNBYTRjLBYUmtm%2F%2FlE%3D)

*   tail è®¾ç½®æˆçº¿ç¨‹ B èŠ‚ç‚¹
*   çº¿ç¨‹ B èŠ‚ç‚¹çš„çš„ prev æŒ‡å‘äº† head(å³åˆšåˆšåˆ›å»ºå‡ºæ¥çš„ç©ºä¿¡æ¯èŠ‚ç‚¹)

å®Œæˆäº†é˜Ÿåˆ—çš„åˆ›å»ºåï¼Œçœ‹ä¸€ä¸‹æ¥ä¸‹æ¥çº¿ç¨‹ B åˆ°åº•æ˜¯ç«‹åˆ»ç­‰å¾…ï¼Œè¿˜æ˜¯éœ€è¦æ‰§è¡Œä¸€äº›ç‰¹æ®Šé€»è¾‘åå†è¿›å…¥ç­‰å¾…ã€‚

#### 3.2.3 acquireQueued

æ³¨æ„å…³é”®ä»£ç ï¼šfor(;;)

![Image 27](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db327da90e764a43b9c6b536a7a532ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=LVmP4V47hBeJs95L6kYOvAc19J8%3D)

```
 if (shouldParkAfterFailedAcquire(p, node) &&
                    parkAndCheckInterrupt())
                    interrupted = true;
```

*   å…ˆæ‰§è¡Œ `shouldParkAfterFailedAcquireï¼ˆï¼‰`
*   å¦‚æœ `shouldParkAfterFailedAcquire()` è¿”å›ä¸º falseï¼Œåˆ™ `parkAndCheckInterrupt()` ä¸ä¼šå†æ‰§è¡Œ

`shouldParkAfterFailedAcquire` åˆ¤æ–­æ˜¯å¦éœ€è¦å°†çº¿ç¨‹æš‚åœã€‚æ³¨æ„ä¼ å…¥å‚æ•°ï¼š

![Image 28](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9aba01b7c0147af929397186d96ced4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=00erdoi7jZFBvJ1jNaq%2FeEbM1zE%3D)

è¡¥å……çŸ¥è¯†ç‚¹ï¼š

| **æšä¸¾** | **å«ä¹‰** |
| --- | --- |
| 0 | Node åˆå§‹åŒ–çš„æ—¶å€™çš„é»˜è®¤å€¼ |
| CANCELLED | ä¸º1ï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²ç»å–æ¶ˆäº† |
| CONDITION | ä¸º-2ï¼Œè¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’ |
| PROPAGATE | ä¸º-3ï¼Œå½“å‰çº¿ç¨‹å¤„åœ¨ SHARED æƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨ |
| SIGNAL | ä¸º-1ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±ç­‰èµ„æºé‡Šæ”¾äº† |

å…·ä½“é€»è¾‘æƒ…å†µå¦‚ä¸‹ï¼š

![Image 29](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/221cc7c093ba477ea5d9a30628b65797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=Zp%2F%2Fx%2FxH82Pdu0M%2B0jiC0%2Bp2%2FQA%3D)

ç‰¹åˆ«æ³¨æ„ï¼šwaitStatus \> 0 åªæœ‰å–æ¶ˆçŠ¶æ€è¿™ç§çŠ¶æ€

```
/** waitStatus value to indicate thread has cancelled */
static final int CANCELLED =  1;
```

**ç¬¬ä¸€æ¬¡æ‰§è¡Œ acquireQueued ï¼ŒshouldParkAfterFailedAcquire() è¿”å› falseã€‚**

**AQS ä¸­çš„çŠ¶æ€ä¿¡æ¯ï¼šå®Œæˆç¬¬ä¸€æ¬¡è¿è¡Œåï¼Œ** çº¿ç¨‹ B èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ waitStatus = -1 ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Image 30](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca89273ef1c5437ca1c0fc9fd0027e01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=zbsbP2nmJ%2FZHdWeRQHd6qJq2IKA%3D)

ç¬¬äºŒæ¬¡æ‰§è¡Œ acquireQueuedï¼Œ shouldParkAfterFailedAcquire() è¿”å› trueã€‚

åŸå› æ˜¯å› ä¸ºå‰é©±èŠ‚ç‚¹çš„ waitStatus = -1

![Image 31](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a1f76e40d59417b900a48485de5a849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=dQqFinR6umD4JJMBzXObr%2B7LEII%3D)

**ç¬¬ä¸€æ¬¡**ï¼š`shouldParkAfterFailedAcquire(p, node)` æ‰§è¡Œ falseï¼Œæ–¹æ³• `parkAndCheckInterrupt()`å°†è·³è¿‡

**ç¬¬äºŒæ¬¡ï¼š** `shouldParkAfterFailedAcquire(p, node)` æ‰§è¡Œ true ï¼Œåˆ™æ‰§è¡Œ parkAndCheckInterrupt()ï¼Œå¯¹çº¿ç¨‹ B è¿›è¡Œæš‚åœå¤„ç†ã€‚

å¾ˆæ˜¾ç„¶ï¼šåœ¨çº¿ç¨‹è¿›å…¥é˜»å¡ç­‰å¾…ä¹‹å‰ï¼Œçº¿ç¨‹èŠ‚ç‚¹å¤šåšäº†ä¸€æ¬¡å¾ªç¯ï¼Œç®—æ˜¯ä¸€ç§ä¼˜åŒ–

![Image 32](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beabf5df9959481a9df38eac2b0fb20d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=n1niPbhjkSbekqQQqBcf6Y1%2FTMg%3D)

ç”±äºçº¿ç¨‹ B ä¸€ç›´è·å–ä¸åˆ°é”ï¼Œæ‰§è¡Œ park ï¼Œå¯¹çº¿ç¨‹é˜»å¡æŒ‚èµ·ï¼

å®Œæˆçº¿ç¨‹ B çš„æŠ¢å æ¼”ç¤ºåï¼Œå†æ¼”ç¤ºçº¿ç¨‹ C

### 3.3 çº¿ç¨‹ C æŠ¢å é”æ¼”ç¤º

çº¿ç¨‹ C çš„é€»è¾‘å’Œçº¿ç¨‹ B çš„é€»è¾‘æ˜¯ç›¸ä¼¼çš„ï¼š

![Image 33](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2c5df32da7f413db1feb59f8e23ae45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=NBcvoAu4gE6ow8vgkVsCs8%2BTH%2BI%3D)

A æ­£åœ¨è·å–é”ï¼Œçº¿ç¨‹ C åªèƒ½æ‰§è¡Œ acquire() åˆ†æ”¯ä»£ç 

çº¿ç¨‹ C å’Œçº¿ç¨‹ B ä¸€äº›å·®å¼‚ç‚¹ï¼š

#### 3.3.1 addWaiter æ–¹æ³•

ç”±äº tail å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿå°¾

![Image 34](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9831a8bbc03e4f18839379ae9b6a7ba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=%2BFXK58CHb6SwePeOl5sj4oo3fKI%3D)

æ‰§è¡Œå®Œæˆåï¼Œ AQS çš„æƒ…å†µå¦‚ä¸‹ï¼š

![Image 35](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42a218cf1924958aa383ffce6911882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=mOwgSl2RTYCVwhgsQKfcrURq9uA%3D)

**æ³¨æ„ï¼šheadã€tail åªæ˜¯åœ°å€å¼•ç”¨ã€‚åˆ†åˆ«æŒ‡å‘é˜Ÿåˆ—çš„é¦–å°¾ã€‚è€Œ head å¹¶ä¸æ˜¯ä¸€ä¸ªå®é™…çš„çº¿ç¨‹èŠ‚ç‚¹ï¼Œæ²¡æœ‰çº¿ç¨‹ç›¸å…³ä¿¡æ¯ï¼Œ è¿™ä¸ªè¦ç‰¹åˆ«æ³¨æ„ï¼**

![Image 36](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b5ae2a402d49ed9a85c2f6873a24c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=KInOWPCwn%2F%2F%2F3YvNydMof1QY3l8%3D)

é€šè¿‡æ ˆå¸§æƒ…å†µï¼Œçº¿ç¨‹ A å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹ Bã€çº¿ç¨‹ C éƒ½å¤„äºæŒ‚èµ·ç­‰å¾…çŠ¶æ€ã€‚

### 3.4 æŠ¢å è¿‡ç¨‹æ€»ç»“

1.  è®¾ç½® state \> 0 æˆåŠŸçš„çº¿ç¨‹ï¼ŒAQS çš„ `exclusiveOwnerThread` å€¼å°†è¢«è®¾ç½®æˆè¯¥çº¿ç¨‹ã€‚å³è¿™ä¸ªçº¿ç¨‹è·å¾—é”
2.  ReentrantLock å¯ä»¥é‡å…¥ï¼Œé€šè¿‡ state æ¥æ§åˆ¶é‡å…¥æ¬¡æ•°
3.  ReentrantLock çš„éå…¬å¹³é”çš„åŸç†ï¼šå½“æ–°çš„çº¿ç¨‹è¿›å…¥ï¼Œè°ƒç”¨ tryAcquireï¼ˆï¼‰å¤šæ¬¡å°è¯•å¯¹ state ä¿®æ”¹ï¼Œå³å°è¯•è·å¾—ç‹¬å ï¼Œè¿™ä¸ªæ—¶å€™ä¸ç®¡æ˜¯å¦å­˜åœ¨é˜»å¡çº¿ç¨‹ï¼›å¦‚æœå¤šæ¬¡å°è¯•æ²¡æœ‰è·å–ç‹¬å æœºä¼šï¼Œä¼šå°†è¿™ä¸ªçº¿ç¨‹åŠ å…¥åŒå‘é˜Ÿåˆ—
4.  æ³¨æ„ï¼šåŒå‘é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹æ˜¯ä¸€ä¸ªä¸å¸¦çº¿ç¨‹ä¿¡æ¯èŠ‚ç‚¹
5.  åœ¨çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ä¹‹å‰ï¼Œä¾ç„¶ä¼šåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè·å–åˆ°é”ã€‚å¦‚æœå†æ¬¡å¤±è´¥ï¼Œæœ€ç»ˆä¼šçº¿ç¨‹è¿›è¡Œé˜»å¡æŒ‚èµ·

çº¿ç¨‹ ABC çš„é”æŠ¢å è¿‡ç¨‹å°±æ¼”ç¤ºå®Œæˆï¼Œé‚£ä¹ˆé˜»å¡æŒ‚èµ·çš„çº¿ç¨‹åˆå¦‚ä½•è¢«å”¤é†’å‘¢ï¼Ÿ

å››ã€é”é‡Šæ”¾è¿‡ç¨‹
-------

![Image 37](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdbff28e788341499520839eddc77cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=48tDTbgufyRRPVvPmuhWxP4KZfY%3D)

### 4.1 é‡Šæ”¾é€»è¾‘

æ¥ä¸‹æ¥ï¼Œæ‰§è¡Œçº¿ç¨‹ A ä¸­çš„é‡Šæ”¾é€»è¾‘:

![Image 38](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6fb8eea71d847eb9dc99289867ccf8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=80pzZopnLr6BHeoXc15EmrKgyg8%3D)

* * *

**è°ƒç”¨æƒ…å†µå¦‚ä¸‹ï¼š**

**java.util.concurrent.locks.ReentrantLock#unlock**

```
public void unlock() {
    sync.release(1);
}
```

ä»£ç é€»è¾‘ï¼š

*   é‡Šæ”¾é”ï¼ŒexclusiveOwnerThread è®¾ç½®ä¸º null
*   state é‡Šæ”¾å¯¹åº”æ•°å€¼
*   å”¤é†’ç­‰å¾…çš„çº¿ç¨‹

```
public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null && h.waitStatus != 0)
            // å”¤é†’ç­‰å¾…çš„çº¿ç¨‹
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```

![Image 39](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0284da0ccb4f9c9f23787fef97d647~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=VobF6V8EE2o1Q%2FO1l9fMh33KUqk%3D)

### 4.2 å”¤é†’ç­‰å¾…çº¿ç¨‹

![Image 40](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8bb5604f07146ebbe5fcc0b352f2f86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=0N%2F%2BivZdBGJRK348Mh9HoO3i0cc%3D)

å…³é”®æ–¹æ³•ï¼š unparkSuccessor()

![Image 41](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a62a8f0fc3d64062adf0aa2a377a1e0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=d4JKOfqpcjVuAT8CEobjti1mVqI%3D)

è¿™ä¸ªæ—¶å€™ AQS çš„çŠ¶æ€æƒ…å†µï¼š

*   state = 0
*   exclusiveOwnerThread = null

![Image 42](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/922590437fdb4562acb72b2ae4787624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=C2qZLlBWS8UU9VuDD2DvFTGyrCI%3D)

çº¿ç¨‹ B è¢«å”¤é†’

![Image 43](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53b3c2c78dd84affa15f6c8bd2fbaa07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=aj5AwsLavyVBKdTsSmSnPrESUxQ%3D)

å…³é”®æ–¹æ³•å¦‚ä¸‹ï¼š

```
  private final boolean parkAndCheckInterrupt() {
        LockSupport.park(this);
        // æ³¨æ„ï¼šLockSupport.park ä¼šå“åº”ä¸­æ–­
        // éä¸­æ–­è¿”å› false
        return Thread.interrupted();
    }
```

![Image 44](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dccabf95fef8425e8baf429b44481809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=rqyEa45AaKl2XGGs0x1aiW5lgv8%3D)

**_interrupted()_ **æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€ã€‚è¿™æ„å‘³ç€å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨**_interrupted()_ **ä¼šè¿”å›**_true_**ï¼Œå¹¶ä¸”é‡ç½®ä¸­æ–­çŠ¶æ€ã€‚å› æ­¤ï¼Œå¦‚æœç´§æ¥ç€å†æ¬¡è°ƒç”¨**_interrupted()_ **ï¼Œå®ƒå°†è¿”å›**_false_**ï¼Œå› ä¸ºä¸­æ–­çŠ¶æ€å·²ç»è¢«æ¸…é™¤äº†

### 4.3 çº¿ç¨‹ B è·å¾—é”

çº¿ç¨‹ B ç»§ç»­æ‰§è¡Œé€»è¾‘

![Image 45](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7450a57ce8fc43b48792500bf57f4826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=PaX%2BJo82YloZaLytDRHCKOCwlzg%3D)

çº¿ç¨‹ B è·å¾—é”æ‰§è¡Œä»£ç ï¼Œçº¿ç¨‹ C å†è·å¾—é”æ‰§è¡Œä»£ç ã€‚ç”±äºçº¿ç¨‹ C çš„é‡Šæ”¾è¿‡ç¨‹å’Œçº¿ç¨‹ B æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¸å¿…å¤‡å†èµ˜è¿°ã€‚

å½“çº¿ç¨‹ ABC éƒ½é‡Šæ”¾åï¼Œè¿™ä¸ªæ—¶å€™ AQS çš„çŠ¶æ€ï¼š

![Image 46](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d09d5c93e34e96a17a442f90348951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=kNh%2B5mth%2BM%2FXwFWNKT%2FO7e%2BMAhU%3D)

æœ€å AQS çš„çŠ¶æ€å¦‚ä¸‹ï¼š

![Image 47](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a4664f50dfc4fdcaf5bb3e68f5c6732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=VlH5XIcA7UlzUv9i3OW%2BbJD%2Buy4%3D)

æ³¨æ„ headã€tail å¹¶æ²¡æœ‰é”€æ¯ï¼Œå°†å¸¸é©»å†…å­˜ï¼

### 4.4 é‡Šæ”¾è¿‡ç¨‹æ€»ç»“

1.  Lock.park æŒ‚èµ·çº¿ç¨‹
2.  Lock.unpark å”¤é†’çº¿ç¨‹
3.  å½“çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œä¼šå”¤é†’æœ€é å‰çš„é‚£ä¸ªçº¿ç¨‹èŠ‚ç‚¹ï¼Œæ³¨æ„ä¸æ˜¯ head èŠ‚ç‚¹ã€‚ head èŠ‚ç‚¹æ˜¯ä¸å…·å¤‡çº¿ç¨‹ä¿¡æ¯çš„
4.  æ•´ä¸ªé‡Šæ”¾è¿‡ç¨‹ï¼Œç±»ä¼¼é“¾è¡¨çš„åˆ é™¤ï¼

### 4.5 å…¬å¹³é” faireSync

å…¬å¹³é”é€»è¾‘ç¨å¾®ç®€å•ä¸€äº›ï¼šå…¬å¹³é”çš„é€»è¾‘åˆ™å®Œå…¨æŒ‰ç…§é˜Ÿåˆ—çš„æ€æƒ³æ¥ï¼ŒFIFO

æ€è·¯ï¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™åŠ å…¥åˆ°é˜Ÿå°¾

äº”ã€æ€»ç»“
----

åˆ°è¿™é‡Œï¼Œå¯¹äº AQS çš„é˜Ÿåˆ—ã€çº¿ç¨‹é˜»å¡ç­‰é—®é¢˜åŸºæœ¬ç®—æ˜¯æ¸…æ¥šäº†ã€‚å¦‚æœä¸æ¸…æ¥šï¼Œå¯ä»¥æŒ‰ç…§ä»£ç ä¸€æ­¥æ­¥åœ°è¿›è¡Œè°ƒè¯•ï¼Œæ„Ÿå—ä¸€ä¸‹ AQS çš„é­…åŠ›æ‰€åœ¨ã€‚

### 5.1 é”æŠ¢å è¿‡ç¨‹å’Œé‡Šæ”¾è¿‡ç¨‹

1.  ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ CAS è®¾ç½® state å’Œ exclusiveOwnerThread è·å¾—é”
2.  ç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ªåŒçº¿é˜Ÿåˆ—ï¼ŒåŒæ—¶ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºä¿¡æ¯èŠ‚ç‚¹ headï¼Œä¸æºå¸¦çº¿ç¨‹ç›¸å…³ä¿¡æ¯ï¼›åŒæ—¶å°†è¯¥çº¿ç¨‹å°è£…æˆ Nodeï¼Œæ’å…¥åˆ°é˜Ÿå°¾
3.  ç¬¬ä¸‰ä¸ªçº¿ç¨‹ï¼Œä¼šç»§ç»­æ’å…¥åˆ°é˜Ÿå°¾
4.  è¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ä¼šé€šè¿‡ LockSupport.park è¿›å…¥æŒ‚èµ·é˜»å¡çŠ¶æ€
5.  å½“è·å¾—é”çš„çº¿ç¨‹æ‰§è¡Œå®Œï¼Œè°ƒç”¨é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œä¼šé€šè¿‡ LockSupport.unpark å°†ç¬¬ä¸€ä¸ªçº¿ç¨‹èŠ‚ç‚¹å”¤é†’ã€‚æ³¨æ„ä¸æ˜¯ head èŠ‚ç‚¹ã€‚ å…¶ä»–çº¿ç¨‹å”¤é†’è¿‡ç¨‹ç±»ä¼¼ã€‚

### 5.2 AQSä»£ç è®¾è®¡ä¸­çš„ä¼˜ç‚¹

1.  è®¾è®¡æ¨¡å¼ï¼šAQS ä¸­çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œé€šè¿‡ tryAcquireã€tryRelease ç­‰æ–¹æ³•çš„é‡å†™ï¼›ä»è€Œå®ç°äº†ä¸åŒçš„å·¥å…·ç±»ã€‚å¾ˆæ˜¾ç„¶ç»“æ„è®¾è®¡æ˜¯å¾ˆæ£’çš„
2.  CASï¼Œä½¿ç”¨å¤§é‡çš„ CAS ç©ºæ§åˆ¶çº¿ç¨‹å®‰å…¨
3.  é€šè¿‡ for(;;) ç­‰ç»†èŠ‚ï¼Œå¤šæ¬¡å°è¯•å¯¹é”çš„è·å–ï¼Œé¿å…ç›´æ¥å°†çº¿ç¨‹æŒ‚èµ·é˜»å¡ï¼Œç»†èŠ‚ä¸Šå¾ˆè®²ç©¶
4.  é€šè¿‡ç²¾å¿ƒçš„å˜é‡å€¼è®¾è®¡ï¼Œè¯¸å¦‚ stateã€waitStatus ç­‰ï¼Œä»£ç æ›´å°‘ï¼Œé€»è¾‘æ›´æ¸…æ™°

### 5.3 æœªæ¶‰åŠçŸ¥è¯†å’Œå¼Šç«¯

éƒ¨åˆ†ç»†èŠ‚æœªæ·±å…¥äº†è§£ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ï¼š

*   ä¸­æ–­è·å– acquireInterruptibly
*   æ¡ä»¶åˆ¤æ–­ condition
*   å¼‚å¸¸æƒ…å†µ
*   ä»¥ ReentrantLock è¿›è¡Œè®²è§£ï¼Œæœ‰ä¸€å®šå±€é™

å¦‚æœæœ‰æ—¶é—´å†æŒ–ä¸€æŒ–ã€‚

### 5.4 ä¸ºä»€ä¹ˆé˜Ÿåˆ—ä¸­çš„ head ä¸æºå¸¦çº¿ç¨‹ä¿¡æ¯

é—®é¢˜ï¼šé˜Ÿåˆ—ä¸­çš„ head èŠ‚ç‚¹ä¸ç»‘å®šçº¿ç¨‹ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„ head èŠ‚ç‚¹å­˜åœ¨ï¼Ÿ

ç­”æ¡ˆï¼šä¸€äº›è‡ªå·±çš„çœ‹æ³•(ä¸ä¸€å®šå¯¹å’Œå…¨ï¼Œæ¬¢è¿è¡¥å……)ï¼š

ç”±äºçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸéå¸¸çŸ­ï¼›å¦‚æœ head æ˜¯çº¿ç¨‹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéšç€é”çš„äº‰å¤ºå’Œé‡Šæ”¾ï¼Œæ•´ä¸ªé˜Ÿåˆ—å°†è¢«åå¤åˆ›å»ºå’Œé”€æ¯ã€‚

ä½†æ˜¯ç»™ä¸€ä¸ªæ— å…³çš„ head ä¿¡æ¯ï¼Œåªåˆ›å»ºä¸€æ¬¡ï¼Œå¹¶èƒ½åå¤ä½¿ç”¨ï¼Œå¸¸é©»å†…å­˜ã€‚ ä»æ•´ä½“è€Œè¨€ï¼Œç¡®å®å¯ä»¥å¸¦æ¥æ€§èƒ½çš„æå‡ï¼

å·¥ä½œè¿™ä¹ˆå¤šå¹´ï¼Œç¬¬ä¸€æ¬¡å¯¹ AQS æœ‰è¿™ä¹ˆæ·±å…¥çš„ç†è§£ï¼Œä¸å¤šåºŸè¯äº†ï¼Œæœ¬æ–‡åˆ°æ­¤ç»“æŸï¼

![Image 48](https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3adb94c3584f428caa51e07b9a8cd2c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&x-expires=1730291445&x-signature=yur7nKH3ncvveTRj%2FFovimcl7HY%3D)
