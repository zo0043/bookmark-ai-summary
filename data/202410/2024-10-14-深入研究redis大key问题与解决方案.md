# 深入研究Redis大Key问题与解决方案
- URL: https://juejin.cn/post/7167015025154981895
- Added At: 2024-10-14 16:51:39
- [Link To Text](2024-10-14-深入研究redis大key问题与解决方案_raw.md)

## TL;DR
Redis大Key指内存占用超阈值的Key，会导致数据倾斜、资源耗尽和主线程阻塞。应避免生成大Key，通过监控、内存优化和异步分批删除等手段处理，以保障系统性能和稳定性。

## Summary
1. **大Key定义**：
   - Redis是基于内存的Key-Value存储系统。
   - Value大小超过阈值时，存储该Value的Key称为大Key（bigKey）。
   - 阈值根据不同场景需求而定。

2. **bigKey的危害**：
   - **数据倾斜**：
     - bigKey所在服务器占用过多内存，影响切片集群整体性能。
   - **服务器资源耗费**：
     - **网络带宽**：bigKey传输时间长，占用大量带宽，导致网络阻塞。
     - **CPU和内存**：处理bigKey操作时间复杂度增加，占用更多CPU和内存。
   - **主线程阻塞**：
     - bigKey操作由主线程执行时，需更多时间，导致主线程阻塞。
     - 高峰期触发此场景，服务卡顿甚至瘫痪。

3. **bigKey常见问题**：
   - **HASH数据删除原理**：
     - Redis中每个HASH类型数据有`ht[0]`和`ht[1]`两张哈希表。
     - 删除操作遍历两张哈希表，释放内存。
   - **bigKey删除时间**：
     - **官方描述**：删除String类型时间复杂度为O(1)，复杂类型为O(M)。
     - **本地测试**：元素和内存占用增加，DEL耗时增加。
     - **测试结果**：元素数量增加，Redis耗时呈线性关系。
     - **耗时因素**：
       - **网络堵塞**：命令传输受阻，耗时增加。
       - **时间复杂度高**：集合类型数据删除需遍历元素，耗时增加。
       - **内存回收异常**：内存管理器性能下降，内存碎片增多。
       - **Swap引起延迟**：内存不足时，Swap操作导致延迟。
   - **bigKey删除导致服务瘫痪**：
     - 删除操作在主线程中触发，可能因手动DEL命令或未开启Lazy Free机制。

4. **bigKey解决方案**：
   - **避免出现bigKey**：
     - **规范使用**：
       - 添加TTL。
       - 使用“拆分存储”。
       - 大数据存储需求不使用Redis。
     - **监控报警**：监控Key内存占用，超阈值报警。
     - **强制删除**：超最大阈值且未处理时，触发强制删除。
   - **bigKey内存优化**：
     - **减少内存碎片**：
       - 数据对齐。
       - 重启Redis服务。
       - 开启`activedefrag`功能。
     - **避免Swap**：释放不必要的内存空间。
     - **丰富监控指标**：监控内存碎片率、Swap值。
   - **安全删除bigKey**：
     - **异步删除**：
       - 开启lazy free功能。
       - 使用unlink命令。
     - **分批删除**：通过scan轮询，每次删除部分数据。
