# 支付设计白皮书：支付系统的对账系统设计
- URL: https://juejin.cn/post/7102036546819194911
- Added At: 2024-10-14 17:49:49
- [Link To Text](2024-10-14-支付设计白皮书：支付系统的对账系统设计_raw.md)

## TL;DR
对账是支付系统中确保数据一致的关键环节，涉及内部和渠道对账，通过发现和处理差异保障系统安全。设计流程包括数据获取、解析、存储、核对及差错处理，需应对格式、下载等挑战。商户清结算分D+0和T+1两种模式，各有利弊。系统设计复杂但至关重要。

## Summary
1. **对账简介**：
   - 对账是支付系统中最头疼的问题，确保各参与者记录吻合无偏差。
   - 对账系统的工作包括发现差异记录（轧帐）和解决这些差异（平帐）。

2. **对账概念**：
   - 对账即勾兑，支付系统对账包括内部间对账和与渠道对账。
   - 内部对账：交易系统、账户系统、会计系统等子系统间的核对。
   - 渠道对账：与第三方支付公司、银行、清算中心等的对账。

3. **对账必要性**：
   - 正常情况下，双方数据一致，无需处理。
   - 异常情况下，网络问题可能导致数据不一致，对账可发现这些问题。
   - 对账是支付系统的最后一道安全防线，避免订单差错累积。

4. **支付对账系统架构**：
   - 分为对账模块和差错模块。
   - 对账模块：负责文件拉取、数据解析、核对、汇总。
   - 差错模块：处理对账模块无法核对成功的数据，生成差错订单供运营人员处理。

5. **对账系统设计流程**：
   - 平台数据获取
   - 渠道文件获取
   - 渠道账单数据解析器设计
   - 对账数据存储
   - 交易对账项目设计
   - 交易对账结果管理
   - 交易对账差错处理

6. **平台数据获取**：
   - 数据从公司平台获取，方式灵活（数据库、接口、MQ等）。

7. **渠道文件获取**：
   - 银行、第三方支付等提供对账单下载功能。
   - 存在问题：
     - 对账单格式不一，需标准化处理。
     - 下载方式不一（HTTP、HTTPS、FTP），需按协议处理。
     - 下载时间不一，需注意重试机制。
     - 稳定性差，需设置重试次数和链接超时。

8. **渠道账单数据解析器设计**：
   - 将不同渠道的字段映射到统一字段，以便无差别处理。

9. **对账数据存储**：
   - 借助大数据平台处理对账数据。

10. **交易对账项目设计**：
    - 详细设计交易对账的具体项目和流程。

11. **交易对账差错处理**：
    - 数据量不大时，人工甄别。
    - 数据量大时，需自动处理。
    - 处理情况：
      - 本地未支付，渠道已支付：修改本地状态并通知业务方。
      - 本地已支付，渠道已支付但金额不同：人工核查。
      - 本地已支付但渠道无记录，或反之：了解原因后处理。
    - 退款对账处理：
      - 本地未退款，渠道已退款：以渠道为准修改本地状态。
      - 本地已退款，渠道已退款但金额不同：人工核查。
      - 本地已退款但渠道无记录，或反之：了解原因后处理。

12. **商户清结算**：
    - 核心业务体系，包括支付、对账、结算流程。
    - 涉及商户、支付平台和银行三部分。
    - 结算周期：
      - D+0（实时到账）：先结算后对账，需垫资，风险大，手续费高。
      - T+1（正规结算）：先对账后结算，不需垫资，风险小，手续费低。

13. **商户T+1结算流程**：
    - 详细流程图和说明。

14. **商户D+0结算流程**：
    - 详细流程图和说明。

15. **总结**：
    - 对账系统设计的重要性和复杂性。
    - 感谢阅读，作者自我介绍。
