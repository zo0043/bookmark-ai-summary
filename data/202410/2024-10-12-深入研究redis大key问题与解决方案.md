# 深入研究Redis大Key问题与解决方案
- URL: https://juejin.cn/post/7167015025154981895
- Added At: 2024-10-12 07:54:00
- [Link To Text](2024-10-12-深入研究redis大key问题与解决方案_raw.md)

## TL;DR
本文探讨了Redis中大Key的定义、危害、常见问题及解决方案。大Key会导致数据倾斜、资源耗费和主线程阻塞。解决方案包括避免大Key出现、优化内存和采用安全删除策略。

## Summary
1. **前言**：本文探讨了Redis中大Key问题及其解决方案，原创内容，著作权归WGrape所有。

2. **大Key定义**：
   - Redis是基于内存的Key-Value存储系统。
   - Value大小超过阈值时，存储该Value的Key称为大Key（bigKey）。
   - 阈值根据不同场景需求而定。

3. **bigKey的危害**：
   - **数据倾斜**：bigKey所在服务器占用过多内存，影响切片集群性能。
   - **服务器资源耗费**：
     - **网络带宽**：bigKey传输时间长，占用大量带宽，导致网络阻塞。
     - **CPU和内存**：处理bigKey操作复杂度增加，占用更多CPU和内存。
   - **主线程阻塞**：bigKey操作由主线程执行时，需更多时间，高峰期易导致服务卡顿或瘫痪。

4. **bigKey常见问题**：
   - **HASH数据删除原理**：
     - HASH类型数据结构包括两张哈希表`ht[0]`和`ht[1]`。
     - 删除操作遍历哈希表并释放内存，耗时主要在数据结构遍历和内存回收。
   - **bigKey删除时间**：
     - **官方描述**：删除String类型时间复杂度为O(1)，复杂类型为O(M)。
     - **本地测试**：随元素和内存占用增长，DEL耗时增加。
     - **测试结果**：元素数量增加，Redis耗时呈线性关系。
     - **耗时因素**：
       - **网络堵塞**：命令传输受阻，耗时增加。
       - **时间复杂度高**：集合类型删除需遍历元素，耗时增加。
       - **内存回收异常**：内存管理器性能下降，内存碎片率增高。
       - **Swap引起延迟**：内存不足时，磁盘IO速度慢，导致延迟。
     - **总结**：Swap > 内存回收 > 数据结构遍历。

5. **bigKey删除导致服务瘫痪**：
   - 删除操作在主线程中触发，可能是手动DEL命令或未开启Lazy Free机制。

6. **bigKey解决方案**：
   - **避免出现bigKey**：
     - **规范使用**：添加TTL、拆分存储、避免大数据用Redis。
     - **监控报警**：监控Key内存占用，超阈值报警。
     - **强制删除**：超最大阈值未处理，触发强制删除。
   - **bigKey内存优化**：
     - **减少内存碎片**：数据对齐、重启Redis、开启`activedefrag`。
     - **避免Swap**：释放不必要的内存。
     - **丰富监控指标**：监控内存碎片率、Swap值。
   - **安全删除bigKey**：
     - **异步删除**：开启lazy free、使用unlink命令。
     - **分批删除**：通过scan轮询，每次删除部分数据。
