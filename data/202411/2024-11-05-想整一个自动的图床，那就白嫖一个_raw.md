Title: æƒ³æ•´ä¸€ä¸ªè‡ªåŠ¨çš„å›¾åºŠï¼Œä½†æ˜¯ä¸æƒ³èŠ±é’±ä¹°ossæ€ä¹ˆåŠï¼Œé‚£å°±ç™½å«–ä¸€ä¸ª ğŸ’ğŸ’ğŸ’å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½æƒ³å»ºç«‹ä¸€ä¸ªè‡ªå·±çš„å›¾åºŠæˆ–è€…è‡ªå·±çš„åš - æ˜é‡‘

URL Source: https://juejin.cn/post/7433243522555936779

Markdown Content:
å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½æƒ³å»ºç«‹ä¸€ä¸ªè‡ªå·±çš„å›¾åºŠæˆ–è€…è‡ªå·±çš„åšå®¢ï¼Œä½†æ˜¯è¦æƒ³å­˜å‚¨å›¾ç‰‡æ˜¯ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„äº‹æƒ…ï¼Œéœ€è¦æä¸€ä¸ª oss æ¥å­˜å‚¨ï¼Œä½†æ˜¯åˆæ€•å®‰å…¨æ–¹é¢åšä¸å¥½è¢«äººåˆ·æµé‡ã€‚

è¿™ä¸‹å‘ç°äº†ä¸€ä¸ªå®è—çš„äº‘å­˜å‚¨ï¼Œå¯ä»¥å…è´¹ä½¿ç”¨åŒ…æ‹¬ 20GB å¸¦å®½ã€20GB åª’ä½“å­˜å‚¨ã€1000 ä¸ªè§†é¢‘å¤„ç†å•å…ƒå’Œ 500 ä¸ªæ‰©å±•å•å…ƒã€‚å…·ä½“ï¼š

1.  æ— é™è¯·æ±‚
    
2.  æ— é™çš„å›¾åƒè½¬æ¢
    
3.  å›¾åƒã€è§†é¢‘å’Œåª’ä½“ç®¡ç†åŠŸèƒ½
    
4.  ä½¿ç”¨æƒ…å†µåˆ†æ
    
5.  20GB å¸¦å®½ã€20GB åª’ä½“å­˜å‚¨ã€1000 ä¸ªè§†é¢‘å¤„ç†å•å…ƒå’Œ 500 ä¸ªæ‰©å±•å•å…ƒ
    
6.  å¸¦æœ‰ 72 å°æ—¶ SLA çš„ç”µå­é‚®ä»¶æ”¯æŒ
    

æ›´æ–°è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥ç›´æ¥è®¿é—® [imagekit](https://link.juejin.cn/?target=https%3A%2F%2Fimagekit.io%2F "https://imagekit.io/")

åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ çš„å›¾ç‰‡ï¼š

![Image 1: 20241104124406](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af95ea99ee244b42bea2a9e0c00b82df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=gHMlTZYOypkr2KVpUC7fbjamw1U%3D)

é™¤äº†é€šè¿‡ api ä¸Šä¼ ä¹‹å¤–ä½ è¿˜å¯ä»¥æ‰‹åŠ¨ä¸Šä¼ ã€‚

å¦‚ä½•åœ¨ NestJs ä¸­ä½¿ç”¨
--------------

![Image 2: 20241104124514](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc0e2c4ecd6b468982f5816ae0ed4ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=7AF54Pu4ZJJrZ9WH4upWh0vhopU%3D)

è¦æƒ³åœ¨ NestJs ä¸­ä½¿ç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ç‚¹å‡»åˆ°è¿™é‡Œï¼š

![Image 3: 20241104124615](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62c6e7f7dfca441899c2983c29f57d80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=CDZGUc3KROUs4a7WldXCXgqjyJs%3D)

è¿™äº›å­—æ®µæˆ‘ä»¬ç­‰ä¼šéœ€è¦ç”¨åˆ°ï¼Œå®ƒè¿˜æä¾›äº†å¤šç§ç›´æ¥è°ƒç”¨çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ Reactã€Vueï¼š

![Image 4: 20241104124655](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f033d2e26a584506a411a616da3b2b1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=HuFvRnJhAp6mL5Q9xuW%2FguCUzXs%3D)

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•åœ¨ NestJs ä¸­ä½¿ç”¨è¿™ä¸ª imagekitï¼Œé¦–å…ˆå®ƒéœ€è¦æˆ‘ä»¬å®‰è£…ç›¸å…³çš„åŒ…ï¼š

```
pnpm add imagekit
```

å®‰è£…å®Œæˆä¹‹åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª controllerï¼š

```
import {
  Controller,
  Get,
  Post,
  UploadedFile,
  UseInterceptors,
} from "@nestjs/common";
import {
  FileInterceptor,
  MulterFile,
} from "@webundsoehne/nest-fastify-file-upload";

import { UploadService } from "./upload.service";

@Controller("upload")
export class UploadController {
  constructor(private readonly uploadService: UploadService) {}

  @Post("url")
  @UseInterceptors(FileInterceptor("file"))
  async convertImage(@UploadedFile() file: MulterFile) {
    console.log(file.originalname); // æ–‡ä»¶åŸå§‹åç§°
    console.log(file.buffer); // æ–‡ä»¶å†…å®¹çš„Buffer
    console.log(file.mimetype); // æ–‡ä»¶çš„MIMEç±»å‹

    const uploadResult = await this.uploadService.uploadImage(
      file.buffer,
      file.originalname
    );

    // è¿”å›ä¸Šä¼ åçš„æ–‡ä»¶ URL
    return { url: uploadResult.url };
  }
}
```

å®šä¹‰å®Œæˆ controller ä¹‹åæˆ‘ä»¬è¦å®šä¹‰ serviceï¼š

```
import { Injectable } from "@nestjs/common";
import ImageKit from "imagekit";
import * as crypto from "crypto";

@Injectable()
export class UploadService {
  private imageKit: ImageKit;
  private privateKey: string;

  constructor() {
    this.imageKit = new ImageKit({
      publicKey: "",
      privateKey: "",
      urlEndpoint: "",
    });
    this.privateKey = ""; // è·Ÿå‰é¢çš„privateKeyä¸€æ ·
  }

  async uploadImage(file: Buffer, fileName: string): Promise<any> {
    // ç”Ÿæˆæ–‡ä»¶çš„å”¯ä¸€å“ˆå¸Œå€¼
    const fileHash = this.generateFileHash(file);

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    const existingFile = await this.checkIfFileExists(fileHash);
    console.log(existingFile);

    if (existingFile) {
      return { url: existingFile.url }; // è¿”å›å·²ä¸Šä¼ æ–‡ä»¶çš„URL
    }

    // ä¸Šä¼ æ–‡ä»¶
    try {
      const response = await this.imageKit.upload({
        file, // ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹
        fileName, // æ–‡ä»¶å
        tags: [fileHash], // å°†å“ˆå¸Œå€¼ä½œä¸ºæ ‡ç­¾å­˜å‚¨ï¼Œä¾¿äºåç»­æŸ¥æ‰¾
      });
      return response;
    } catch (error) {
      throw new Error(`Image upload failed: ${error.message}`);
    }
  }
}
```

å°±è¿™æ ·æˆ‘ä»¬å°±ç”Ÿæˆäº†ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ apifox æ¥æµ‹è¯•ä¸€ä¸‹ç›¸å…³çš„æ•ˆæœï¼š

![Image 5: 20241104130037](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dea2fd78039745419dd5dc231e09005d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=T0qXg5HsRdN1%2FWVb2WGRML4yyH8%3D)

æœ€ç»ˆç»™æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è®¿é—®çš„é“¾æ¥ï¼š

![Image 6: 20241104130105](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/155a11854462475fbc08a93d58a56cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=BngBQc1PqgMi0KlFVkNc8peoVcU%3D)

å¦‚æœä½ å®¢æˆ·ç«¯ç›´ä¼ çš„è¯å°±å¯ä»¥çœ‹ä¸‹é¢çš„å®Œæ•´ä»£ç ï¼š

```
// controller

import {
  Controller,
  Get,
  Post,
  UploadedFile,
  UseInterceptors,
} from "@nestjs/common";
import {
  FileInterceptor,
  MulterFile,
} from "@webundsoehne/nest-fastify-file-upload";

import { UploadService } from "./upload.service";

@Controller("upload")
export class UploadController {
  constructor(private readonly uploadService: UploadService) {}

  @Post("url")
  @UseInterceptors(FileInterceptor("file"))
  async convertImage(@UploadedFile() file: MulterFile) {
    console.log(file.originalname); // æ–‡ä»¶åŸå§‹åç§°
    console.log(file.buffer); // æ–‡ä»¶å†…å®¹çš„Buffer
    console.log(file.mimetype); // æ–‡ä»¶çš„MIMEç±»å‹

    const uploadResult = await this.uploadService.uploadImage(
      file.buffer,
      file.originalname
    );

    // è¿”å›ä¸Šä¼ åçš„æ–‡ä»¶ URL
    return { url: uploadResult.url };
  }

  @Get("signature")
  getUploadSignature() {
    return this.uploadService.generateUploadSignature();
  }
}

// Service
import { Injectable } from "@nestjs/common";
import ImageKit from "imagekit";
import * as crypto from "crypto";

@Injectable()
export class UploadService {
  private imageKit: ImageKit;
  private privateKey: string;

  constructor() {
    this.imageKit = new ImageKit({
      publicKey: "",
      privateKey: "",
      urlEndpoint: "",
    });
    this.privateKey = "";
  }

  private generateFileHash(file: Buffer): string {
    return crypto.createHash("md5").update(file).digest("hex");
  }

  async uploadImage(file: Buffer, fileName: string): Promise<any> {
    // ç”Ÿæˆæ–‡ä»¶çš„å”¯ä¸€å“ˆå¸Œå€¼
    const fileHash = this.generateFileHash(file);

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    const existingFile = await this.checkIfFileExists(fileHash);
    console.log(existingFile);

    if (existingFile) {
      return { url: existingFile.url }; // è¿”å›å·²ä¸Šä¼ æ–‡ä»¶çš„URL
    }

    // ä¸Šä¼ æ–‡ä»¶
    try {
      const response = await this.imageKit.upload({
        file, // ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹
        fileName, // æ–‡ä»¶å
        tags: [fileHash], // å°†å“ˆå¸Œå€¼ä½œä¸ºæ ‡ç­¾å­˜å‚¨ï¼Œä¾¿äºåç»­æŸ¥æ‰¾
      });
      return response;
    } catch (error) {
      throw new Error(`Image upload failed: ${error.message}`);
    }
  }

  private async checkIfFileExists(fileHash: string): Promise<any | null> {
    // ä½¿ç”¨ ImageKit çš„åˆ—è¡¨æ–‡ä»¶ APIï¼Œæ ¹æ®æ–‡ä»¶å“ˆå¸Œæ ‡ç­¾æŸ¥æ‰¾
    const files = await this.imageKit.listFiles({
      tags: fileHash,
      limit: 1, // åªéœ€è¦ä¸€ä¸ªæ–‡ä»¶
    });

    console.log(files);

    return files.length > 0 ? files[0] : null;
  }

  generateUploadSignature() {
    const expire = Math.floor(Date.now() / 1000) + 30 * 60; // 30åˆ†é’Ÿåè¿‡æœŸ
    const token = crypto.randomBytes(16).toString("hex");

    const signature = crypto
      .createHmac("sha1", this.privateKey)
      .update(token + expire)
      .digest("hex");

    return { signature, expire, token };
  }
}
```

è¿™æ ·å­ï¼Œæˆ‘ä»¬çš„æ¥å£å°±ç¼–å†™å®Œæˆäº†ï¼Œè¿™ä¼šæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è°ƒç”¨ signature è¿™ä¸ªæ¥å£ï¼Œç„¶åå®ƒä¼šè¿”å›ä¸€äº› token ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬æœ€ç»ˆä½¿ç”¨è¿™äº›å‚æ•°å‘å›ºå®šçš„æ¥å£å‘èµ· post è¯·æ±‚ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

![Image 7: 20241104130629](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fe8617a73d14d9a825b841aa2019f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&x-expires=1731304409&x-signature=ZnpurA09ZrUAMJYLHwF9CKp5%2BNM%3D)

é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±å¯ä»¥å°†å›¾ç‰‡ç›´æ¥ä¸Šä¼ åˆ° imagekit äº†ï¼Œå¹¶ä¸”ä¸éœ€è¦é¢å¤–çš„å°†æ–‡ä»¶ä¸Šä¼ åˆ°æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨äº†ã€‚

æ€»ç»“
--

æœ‰äº† imagekitï¼Œå†ç»“åˆ supabaseï¼Œvercelï¼Œè¶³å¤Ÿè®©æˆ‘ä»¬ä¸€ä¸ªå‰ç«¯æ¥ä¸Šçº¿ä¸€ä¸ªå‰ç«¯çš„é¡¹ç›®äº†ã€‚

æœ€åå†æ¥æä¸€äº›è¿™ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒä»¬éƒ½æ˜¯æˆ‘ä»¬ç›®å‰æ­£åœ¨ç»´æŠ¤çš„å¼€æºé¡¹ç›®ï¼š

*   [åœ¨çº¿ä»£ç ååŒç¼–è¾‘å™¨](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxun082%2Fonline-edit-web "https://github.com/xun082/online-edit-web")
    
*   [å‰ç«¯è„šæ‰‹æ¶ create-neat](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxun082%2Fcreate-neat "https://github.com/xun082/create-neat")
    

å¦‚æœä½ æƒ³å‚ä¸è¿›æ¥å¼€å‘æˆ–è€…æƒ³è¿›ç¾¤å­¦ä¹ ï¼Œå¯ä»¥æ·»åŠ æˆ‘å¾®ä¿¡ `yunmz777`ï¼Œåé¢è¿˜ä¼šæœ‰å¾ˆå¤šéœ€æ±‚ï¼Œç­‰è¿™ä¸ªé¡¹ç›®å®Œæˆä¹‹åè¿˜ä¼šæœ‰å¾ˆå¤šæ–°çš„å¹¶ä¸”å¾ˆæœ‰è¶£çš„å¼€æºé¡¹ç›®ç­‰ç€ä½ ã€‚
