# 详解：“资损防控”方法论
- URL: https://mp.weixin.qq.com/s?__biz=Mzg2MTg1NTM4NA==&mid=2247501374&idx=1&sn=04a6753f3c41016d2208731992088f6b&scene=21#wechat_redirect
- Added At: 2024-11-11 02:04:19
- [Link To Text](2024-11-11-详解：“资损防控”方法论_raw.md)

## TL;DR
本文阐述了支付公司资损防控的重要性，包括防控体系、常见场景及应对策略，监控与对账，应急与复盘，预案与演练，产品设计要点，全局通盘设计等，旨在帮助读者构建完善的资损防控体系。

## Summary
1. **资损防控重要性**：
   - 支付公司重视资损防控，防止资金损失、舆论风波和监管介入。

2. **资损防控体系**：
   - **资损本质**：轻则资金损失，重则舆论风波，甚至监管介入。
   - **防控本质**：论述资损防控的本质，如何防，如何控。
   - **全生命周期**：资损防控全生命周期管理。
   - **风险分类**：资损风险分类，如金额放大缩小、幂等击穿等。

3. **常见场景及应对**：
   - **金额放大缩小**：
     - **背景**：币种最小单位不同，工程师处理金额时易出错。
     - **问题**：金额放大或缩小100倍，导致资损。
     - **解决方案**：制定Money类统一处理金额，强制使用Money类运算、传输，数据库使用DECIMAL类型保存。
   - **幂等击穿**：
     - **背景**：幂等性描述操作执行多少次，都产生相同结果的属性。
     - **问题**：交易可能变成多笔，幂等字段变更导致幂等逻辑失败。
     - **解决方案**：明确幂等字段，使用数据库唯一索引，建设幂等组件，注意架构升级时幂等逻辑变更。
   - **流水号及短号重复**：
     - **背景**：订单号或交易请求号短，系统升级可能导致流水重复。
     - **问题**：支付时渠道返回“重复交易”，平台推进状态错误。
     - **解决方案**：拼接交易日期，拼接渠道返回的交易日期及金额，禁止网关生成流水号，重点评估流水号变更逻辑。
   - **返回码映射**：
     - **背景**：渠道和内部应用返回码标准不同，可能导致资损。
     - **问题**：调用渠道支付返回超时，平台推进到“失败”，但渠道最终处理成功。
     - **解决方案**：明确“业务成功”和“业务失败”，慎重推进成功或失败，流入类慎重推进到成功，流出类慎重推进到失败。
   - **乱序**：
     - **背景**：渠道异步通知可能比同步接口返回更快，内部应用之间消息、任务调度无法保证顺序性。
     - **问题**：渠道异步回调通知先回来，平台推进状态错误。
     - **解决方案**：状态机设计保证“终态不可变更”，默认所有返回都有可能是乱序的，系统设计要防重。
   - **越权/环境**：
     - **背景**：支付平台操作需要授权，对接的外部渠道通常有线下环境（沙箱环境）和生产环境。
     - **问题**：参数校验不完善，商户越权使用支付方式，线下环境配置了渠道生产环境参数。
     - **解决方案**：严格做校验，禁止在线下环境配置渠道的生产环境参数，对用户的操作行为也需要严格校验权限和数据。
   - **数据库操作**：
     - **背景**：所有交易都会与数据库进行交互，存在乐观锁和悲观锁的争论。
     - **问题**：乐观锁引入事务问题。
     - **解决方案**：严格执行“一锁二判三更新”的原则，根据业务形态综合决定是否引入分布式事务。
   - **状态机**：
     - **背景**：所有交易单据都有状态，如支付中、成功、失败等。
     - **问题**：状态机设计错误，状态机没有设计终态。
     - **解决方案**：引入严格的状态机，明确状态迁移，要有终态概念。
   - **多线程与资源共享**：
     - **背景**：多线程无处不在，且还可能为解决一些特殊场景，引入线程变量或线程池操作。
     - **问题**：类成员变量可写，Threadlocal变量未做重置和清理，混用了特定用户的缓存数据。
     - **解决方案**：严格禁止在service使用可写的类成员变量，Threadlocal变量入口和出口做重置和清理，明确缓存数据。
   - **兼容与灰度**：
     - **背景**：所有业务系统都面临架构升级，必然会出现新老系统 + 新老数据的兼容问题。
     - **问题**：发布过程中出现线上问题，甚至资损。
     - **解决方案**：保证发布阶段的兼容，所有DB变更，无论是结构变更，还是数据内容变更，全部都需要考虑兼容性。
   - **运营操作**：
     - **背景**：运营操作在支付平台的日常运营工作中无处不在。
     - **问题**：操作不可靠，如忘记设置营销券使用条件，打款多打一笔等。
     - **解决方案**：使用技术手段进行预警，加入必要的审批流，严格校对领取权限，实时监控券的领取和使用。

4. **监控与对账**：
   - **监控**：在发布或有变更时，重点监控成功率和提交量变化。
   - **对账**：资损的发现更多的仍然依赖对账来解决，对账主要对状态、金额、交易笔数。
   - **实时对账与离线对账**：监听数据库的binlog，当数据有变动时，延时几秒后请求双方系统的查询接口，查到数据后进行对账。
   - **三层对账**：信息流对账、账单对账、账实对账。

5. **应急与复盘**：
   - **应急**：资损发生后，需要立即启动应急，一线工程师在发现资损故障后，一定要第一时间上报给自己的主管。
   - **复盘**：故障定级、时间线、影响面、根因、反思、待改进项、责任人或责任团队。

6. **预案与演练**：
   - **预案**：针对可能发生的资损场景，制定详细的对策及处置流程。
   - **演练**：有损演练和无损演练，检查是否能及时告警，以及告警出来后，值班的工程师是否及时接手和处置，处置过程是否得当。

7. **产品设计要点**：
   - 信息流与资金流匹配，正向与逆向都需要考虑，异常场景需要提前考虑。

8. **全局通盘设计**：
   - 资损防控需要组合多种能力，才能建设出完善的资损防控体系。

9. **结束语**：
   - 希望本文能为各位在资损防控建设方面有所帮助，早日修成扁鹊长兄的才能：“未有形而除之”。

10. **案例分享**：
    - 分享了多个资损案例，如金额放大缩小、银行异步通知比同步返回更快等。
