# 【📕分布式锁通关指南 01】从解决库存超卖开始加锁的初体验
- URL: https://juejin.cn/post/7452745711856730131
- Added At: 2024-12-27 05:45:20
- [Link To Text](2024-12-27-【📕分布式锁通关指南-01】从解决库存超卖开始加锁的初体验_raw.md)

## TL;DR
文章分析了电商库存超卖问题，探讨了分布式锁、JVM锁、MySQL锁及乐观锁的解决方案，并强调根据业务场景选择合适的锁机制。

## Summary
1. **引言**：
   - 电商业务中库存超卖问题的重要性
   - 从解决库存超卖问题引入分布式锁的概念

2. **需求背景**：
   - 电商项目库存扣减逻辑
   - 创建商品库存表和扣减库存接口
   - 模拟库存扣减逻辑，验证逻辑正确性

3. **发现问题**：
   - 高并发场景下可能出现超卖问题
   - 使用JMeter模拟高并发请求，复现超卖问题

4. **JVM锁初显神通**：
   - 使用synchronized关键字实现JVM锁
   - 使用ReentrantLock实现代码块加锁
   - 分析JVM锁失效场景：多例模式、事务模式、集群模式

5. **解决JVM锁失效后的并发问题**：
   - 使用MySQL悲观锁机制解决并发问题
   - 悲观锁 - 单条update语句实现：合并查询和扣减逻辑，避免超卖
   - 悲观锁 - for update语句实现：查询时加锁，避免并发修改
   - 乐观锁 - 版本号：通过版本号字段判断数据是否被修改
   - 乐观锁 - 时间戳：通过时间戳字段判断数据是否被修改

6. **乐观锁问题**：
   - 高并发写操作性能低
   - 存在ABA问题：可能造成数据不一致

7. **小结**：
   - 介绍JVM锁、MySQL悲观锁和乐观锁
   - 强调没有完美的方案，只有更适合的方案
   - 建议根据业务场景选择合适的锁机制
