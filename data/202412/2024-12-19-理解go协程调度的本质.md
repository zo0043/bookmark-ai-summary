# 理解Go协程调度的本质
- URL: https://mp.weixin.qq.com/s/j9OpuIxXRWa9524oacGCzw
- Added At: 2024-12-19 08:38:04
- [Link To Text](2024-12-19-理解go协程调度的本质_raw.md)

## TL;DR
本文介绍了Go语言的goroutine调度机制，包括进程内存布局、goroutine调度器模型、数据结构以及从main函数启动到调度循环的过程。

## Summary
1. **Go协程概述**：Go语言的核心特色之一是goroutine，它支持高并发程序。通过`go`关键字可以创建大量的轻量级协程，与线程相比，goroutine更轻量，具体调度机制尚待探究。

2. **进程内存布局**：
   - **代码区**：存放程序机器代码，通常是只读的。
   - **数据区**：包括全局变量和静态变量，大小固定。
   - **堆**：动态内存分配区域，如`malloc`和`new`。
   - **栈**：用于函数调用，从高地址向低地址生长。

3. **栈帧详解**：
   - **栈内存**：保存局部变量、返回值、参数、返回地址。
   - **栈帧**：每个函数调用都会产生一个新的栈帧。
   - **寄存器**：`rsp`指向栈顶，`rbp`指向栈底，`ip`指向下一条指令。

4. **Linux线程与调度**：
   - **线程**：操作系统级别的调度单位，由内核管理。
   - **调度过程**：选择线程、上下文切换、线程切换。
   - **核心**：切换寄存器和栈。

5. **goroutine调度器**：
   - **调度模型**：M:N模型，N个系统线程执行M个goroutine。
   - **GM模型**：多对多模型，每个goroutine运行在系统线程上。
   - **GMP模型**：引入P，增加本地队列，优化锁争用和资源消耗。

6. **调度器数据结构**：
   - **g结构体**：保存goroutine所有信息，如栈、状态、关联的M和P。
   - **m结构体**：系统线程，包含TLS、当前运行的G、关联的P。
   - **p结构体**：处理器，包含本地队列、G缓存、状态。
   - **schedt结构体**：调度器工作状态，包含全局队列、空闲M列表、空闲P列表等。

7. **线程与数据结构映射**：
   - **线程本地存储（TLS）**：每个线程有自己的数据副本。
   - **`fs`段**：用于存储线程的TLS数据。

8. **从main函数启动分析**：
   - **程序入口**：`runtime·rt0_go`函数完成初始化工作。
   - **初始化g0**：为g0提供栈空间。
   - **主线程与m0绑定**：设置TLS，实现线程与数据结构之间的映射。
   - **m0和g0绑定**：实现m0和g0与主线程的关联。
   - **初始化m0**：创建和初始化m0。
   - **初始化P**：创建和初始化P结构体对象。
   - **goroutine创建**：通过`newproc`创建goroutine。
   - **调度器初始化**：初始化调度器相关组件。

9. **调度循环**：
   - **schedule函数**：寻找需要运行的goroutine。
   - **execute函数**：切换到goroutine的代码和栈空间。
   - **gogo函数**：完成从g0到goroutine的切换。

10. **总结**：
    - Go的goroutine调度器是GMP模型，通过多对多模型实现轻量级协程。
    - 调度器数据结构包括g、m、p、schedt等。
    - 调度过程涉及线程与数据结构之间的映射、goroutine的创建与调度、调度循环等。
